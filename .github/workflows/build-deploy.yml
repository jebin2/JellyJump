name: Build and Deploy

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: |
          npm install --save-dev terser
          npm install --save-dev clean-css-cli
          npm install --save-dev html-minifier-terser
      
      - name: Create build directory
        run: mkdir -p build
      
      - name: Minify JavaScript files
        run: |
          find . -name "*.js" \
            -not -path "./node_modules/*" \
            -not -path "./build/*" \
            -not -path "./desktop/*" \
            -not -path "./.git/*" | while read file; do
              output_file="build/${file#./}"
              mkdir -p "$(dirname "$output_file")"
              npx terser "$file" --compress --mangle --output "$output_file"
            done
      
      - name: Minify CSS files
        run: |
          find . -name "*.css" \
            -not -path "./node_modules/*" \
            -not -path "./build/*" \
            -not -path "./desktop/*" \
            -not -path "./.git/*" | while read file; do
              output_file="build/${file#./}"
              mkdir -p "$(dirname "$output_file")"
              npx cleancss -o "$output_file" "$file"
            done
      
      - name: Minify HTML files
        run: |
          find . -name "*.html" \
            -not -path "./node_modules/*" \
            -not -path "./build/*" \
            -not -path "./desktop/*" \
            -not -path "./.git/*" | while read file; do
              output_file="build/${file#./}"
              mkdir -p "$(dirname "$output_file")"
              npx html-minifier-terser \
                --collapse-whitespace \
                --remove-comments \
                --minify-css true \
                --minify-js true \
                --output "$output_file" \
                "$file"
            done
      
      - name: Copy other assets
        run: |
          find . \( -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.gif" \
                  -o -name "*.svg" -o -name "*.ico" -o -name "*.woff" -o -name "*.woff2" \
                  -o -name "*.ttf" -o -name "*.eot" \) \
            -not -path "./node_modules/*" \
            -not -path "./build/*" \
            -not -path "./desktop/*" \
            -not -path "./.git/*" | while read file; do
              output_file="build/${file#./}"
              mkdir -p "$(dirname "$output_file")"
              cp "$file" "$output_file"
            done
      
      - name: Deploy to release branch
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
          # Move build directory to temp location outside git repo
          TEMP_BUILD=/tmp/build-artifacts
          mv build "$TEMP_BUILD"
          
          # Create or checkout release branch
          git fetch origin
          git checkout release 2>/dev/null || git checkout -b release
          
          # Remove old build directory if it exists in release branch
          rm -rf build
          
          # Move build back from temp location
          mv "$TEMP_BUILD" build
          
          # Stage and commit changes
          git add build/
          git diff --staged --quiet || git commit -m "Build: Update minified assets from main [skip ci]"
          
          # Push to release branch
          git push origin release