name: Build and Deploy

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: |
          npm install --save-dev terser
          npm install --save-dev clean-css-cli
          npm install --save-dev html-minifier-terser
      
      - name: Create build directory
        run: mkdir -p build
      
      - name: Minify JavaScript files
        run: |
          find . -name "*.js" \
            -not -path "./node_modules/*" \
            -not -path "./build/*" \
            -not -path "./desktop/*" \
            -not -path "./.git/*" | while read file; do
              output_file="build/${file#./}"
              mkdir -p "$(dirname "$output_file")"
              npx terser "$file" --compress --mangle --output "$output_file"
            done
      
      - name: Minify CSS files
        run: |
          find . -name "*.css" \
            -not -path "./node_modules/*" \
            -not -path "./build/*" \
            -not -path "./desktop/*" \
            -not -path "./.git/*" | while read file; do
              output_file="build/${file#./}"
              mkdir -p "$(dirname "$output_file")"
              npx cleancss -o "$output_file" "$file"
            done
      
      - name: Minify HTML files
        run: |
          find . -name "*.html" \
            -not -path "./node_modules/*" \
            -not -path "./build/*" \
            -not -path "./desktop/*" \
            -not -path "./.git/*" | while read file; do
              output_file="build/${file#./}"
              mkdir -p "$(dirname "$output_file")"
              npx html-minifier-terser \
                --collapse-whitespace \
                --remove-comments \
                --minify-css true \
                --minify-js true \
                --output "$output_file" \
                "$file"
            done
      
      - name: Copy other assets
        run: |
          find . \( -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.gif" \
                  -o -name "*.svg" -o -name "*.ico" -o -name "*.woff" -o -name "*.woff2" \
                  -o -name "*.ttf" -o -name "*.eot" \) \
            -not -path "./node_modules/*" \
            -not -path "./build/*" \
            -not -path "./desktop/*" \
            -not -path "./.git/*" | while read file; do
              output_file="build/${file#./}"
              mkdir -p "$(dirname "$output_file")"
              cp "$file" "$output_file"
            done
      
      - name: Deploy to release branch
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
          # Move build directory and files to temp location
          TEMP_DIR=/tmp/release-artifacts
          mkdir -p "$TEMP_DIR"
          mv build "$TEMP_DIR/"
          cp build.sh "$TEMP_DIR/" 2>/dev/null || true
          cp -r desktop "$TEMP_DIR/" 2>/dev/null || true
          cp build-desktop.sh "$TEMP_DIR/" 2>/dev/null || true
          cp package-lock.json "$TEMP_DIR/" 2>/dev/null || true
          cp package.json "$TEMP_DIR/" 2>/dev/null || true
          
          # Create or checkout release branch
          git fetch origin
          git checkout release 2>/dev/null || git checkout --orphan release
          
          # Clear everything in release branch
          git rm -rf . 2>/dev/null || true
          rm -rf * 2>/dev/null || true
          
          # Move selected files/folders back
          mv "$TEMP_DIR"/* . 2>/dev/null || true
          
          # Force add all files (override .gitignore)
          git add -f build/ build.sh desktop/ build-desktop.sh package-lock.json package.json 2>/dev/null || true
          
          # Commit if there are changes
          if ! git diff --staged --quiet 2>/dev/null; then
            git commit -m "Build: Update release artifacts from main [skip ci]"
          fi
          
          # Push to release branch
          git push -f origin release