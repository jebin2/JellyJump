<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JellyJump - Player</title>
    <link rel="icon" href="assets/icons/jelly_jump_logo.png">

    <!-- Preload animated logo for loading indicator -->
    <link rel="preload" href="assets/icons/jelly_jump_logo.gif" as="image">
    <!-- Preload play button -->
    <link rel="preload" href="assets/icons/jelly_play.png" as="image">

    <!-- CSS -->
    <link rel="stylesheet" href="assets/css/theme.css">
    <!-- Common CSS -->
    <link rel="stylesheet" href="assets/css/common.css">
    <link rel="stylesheet" href="assets/css/player.css">
    <link rel="stylesheet" href="assets/css/screenshot.css">
    <link rel="stylesheet" href="assets/css/player_page.css">
</head>

<body>
    <!-- Page Loading Overlay -->
    <div class="page-loader" id="page-loader">
        <div class="page-loader-logo"></div>
    </div>

    <!-- SVG Icon Sprite (loaded first for immediate use) -->
    <div style="display: none;">
        <svg xmlns="http://www.w3.org/2000/svg">
            <defs>
                <!-- Icons are defined in sprite.svg and loaded via <use> tags -->
            </defs>
        </svg>
    </div>

    <div class="player-layout">
        <!-- Video Section -->
        <main class="video-section" id="player-container">
            <!-- Core Player will be injected here -->
        </main>

        <!-- Playlist Section -->
        <aside class="playlist-section">
            <header class="playlist-header" style="display: none;">
                <!-- Header is now generated by Playlist.js -->
            </header>
            <div class="playlist-content">
                <div class="playlist-placeholder">
                    <p>No videos in playlist.</p>
                    <p class="text-sm mt-2">Drag & drop files here.</p>
                </div>
            </div>
        </aside>

        <!-- Mobile Expand Button (separate from playlist) -->
        <button id="mobile-expand-btn" class="mobile-expand-button" aria-label="Expand playlist" title="Expand playlist"
            style="display: none;">
            â–²
        </button>
    </div>

    <!-- Hidden File Inputs -->
    <input type="file" id="mb-file-input" multiple accept="video/*" style="display: none;">
    <input type="file" id="mb-folder-input" webkitdirectory directory style="display: none;">

    <!-- Hidden Download Anchor (reusable) -->
    <a id="mb-download-link" style="display: none;"></a>

    <!-- Import Map: Redirect CDN imports to local files -->
    <script type="importmap">
    {
        "imports": {
            "/npm/mediabunny@1.25.6/+esm": "./assets/js/lib/mediabunny.js"
        }
    }
    </script>

    <!-- GIF Encoder Library (local copy for Electron compatibility) -->
    <script type="module" src="assets/js/lib/gif.js"></script>

    <!-- Scripts -->
    <script type="module">
        // Load templates first, then initialize player
        async function initializeApp() {
            // Load playlist templates
            const playlistResponse = await fetch('assets/templates/playlist-templates.html');
            const playlistHtml = await playlistResponse.text();

            // Load screenshot templates
            const screenshotResponse = await fetch('assets/templates/screenshot-templates.html');
            const screenshotHtml = await screenshotResponse.text();

            // Load player templates
            const playerResponse = await fetch('assets/templates/player-templates.html');
            const playerHtml = await playerResponse.text();

            const tempDiv = document.createElement('div');
            tempDiv.style.display = 'none'; // Hide template container
            tempDiv.innerHTML = playlistHtml + screenshotHtml + playerHtml;
            document.body.appendChild(tempDiv);

            // Now that templates are loaded, import and initialize
            const { CorePlayer } = await import('./assets/js/core/Player.js');
            const { Playlist } = await import('./assets/js/player/Playlist.js');

            // Initialize Player
            const player = new CorePlayer('player-container', {
                autoplay: false,
                muted: false,
                mode: 'player'
            });

            // Initialize Playlist (which will initialize SidebarToggle internally)
            const playlist = new Playlist(
                document.querySelector('.playlist-content'),
                player
            );

            // Demo Videos (optional)
            if (!localStorage.getItem('JellyJumpDB-playlist') && (window.location.href.includes('//localhost:') || window.location.href.includes('//jebin2.github.io/JellyJump/'))) {
                playlist.addItems([
                    {
                        title: 'Big Buck Bunny',
                        url: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4',
                        isLocal: false
                    },
                    {
                        title: 'Big Buck Bunny Audio',
                        url: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/CastVideos/dash/BigBuckBunnyAudio.mp4',
                        isLocal: false
                    }, {
                        title: 'WAVrchive',
                        url: 'https://video.twimg.com/amplify_video/1994083297756848128/vid/avc1/576x576/ue31qU0xts8L9tXD.mp4?tag=21',
                        isLocal: false
                    }, {
                        title: 'Flip Coin',
                        url: 'https://video.twimg.com/amplify_video/1996894303411752961/vid/avc1/720x1280/pL51M6ntUwHJLa7s.mp4?tag=14',
                        isLocal: false
                    }
                ]);

                // Auto-load the first video (without autoplay) so the player isn't empty
                if (playlist.items.length > 0) {
                    const firstItem = playlist.items[0];
                    playlist.activeIndex = 0;
                    playlist.render(); // Update UI to show active state
                    player.load(firstItem.url, false, firstItem.id);
                }
            }
        }

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }

        // Hide page loader after initialization
        window.addEventListener('load', function () {
            const loader = document.getElementById('page-loader');
            if (loader) {
                loader.classList.add('hidden');
            }
        });
    </script>

</body>

</html>