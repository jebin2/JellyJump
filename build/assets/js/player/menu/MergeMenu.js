import{Modal}from"../Modal.js";import{MediaProcessor}from"../../core/MediaProcessor.js";import{MediaMetadata}from"../../utils/MediaMetadata.js";import{generateId}from"../../utils/mediaUtils.js";export class MergeMenu{static async init(e,t){const r=t.items.indexOf(e),o=document.getElementById("merge-modal-content-template"),s=document.getElementById("merge-modal-footer-template"),n=document.getElementById("merge-item-template");if(!o||!s||!n)return;const a=new Modal({maxWidth:"900px"});a.setTitle("Merge Videos"),a.setBody(o.content.cloneNode(!0)),a.setFooter(s.content.cloneNode(!0));const i=a.modal,d=i.querySelector(".available-list"),l=i.querySelector(".selected-list"),c=i.querySelector(".merge-btn"),m=i.querySelector(".selection-count"),u=i.querySelector(".empty-selection-state"),p=i.querySelector("#merge-width"),g=i.querySelector("#merge-height"),v=i.querySelector(".max-resolution-hint"),h=i.querySelector(".scale-select"),y=i.querySelector("#merge-bg-color");let f=[];const L=async()=>{m.textContent=`${f.length} selected`,f.length>=2?c.removeAttribute("disabled"):c.setAttribute("disabled","true"),f.length>0?u.classList.add("hidden"):u.classList.remove("hidden"),await(async()=>{if(0===f.length)return p.value="",g.value="",void(v.textContent="Select videos to detect resolution");v.textContent="Detecting resolution...";let e=0,r=0;for(const o of f)o.videoInfo?await t._ensureMetadata(o):(o.duration,o.duration="Loading...",S(),await t._ensureMetadata(o),S()),o.videoInfo&&(e=Math.max(e,o.videoInfo.width),r=Math.max(r,o.videoInfo.height));e>0&&r>0?(p.value=e,g.value=r,v.textContent=`Max detected: ${e}×${r}`):v.textContent="Could not detect resolution"})()},M=()=>{d.innerHTML="";const e=t.items.filter(e=>!e.type||e.type.startsWith("video/"));0!==e.length?e.forEach((e,t)=>{const r=n.content.cloneNode(!0).querySelector(".merge-item");r.querySelector(".remove-item-btn").remove();const o=r.querySelector(".item-title");o.textContent=e.title,o.title=e.title,r.querySelector(".item-dur").textContent=e.duration||"--:--";f.includes(e)&&(r.classList.add("bg-primary","text-white"),r.classList.remove("hover:bg-tertiary")),r.addEventListener("click",()=>{f.push(e),M(),S(),L()}),d.appendChild(r)}):d.innerHTML='<div class="empty-state text-center p-md text-muted text-sm italic">No videos available</div>'},S=()=>{l.innerHTML="",0!==f.length?f.forEach((e,t)=>{if(!e)return void console.warn("Undefined item in selectedVideos at index",t);const r=n.content.cloneNode(!0).querySelector(".merge-item"),o=r.querySelector(".item-title");o.textContent=e.title,o.title=e.title,r.querySelector(".item-dur").textContent=e.duration||"--:--",r.querySelector(".remove-item-btn").addEventListener("click",e=>{e.stopPropagation(),f.splice(t,1),M(),S(),L()}),r.addEventListener("dragstart",e=>{e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",t),r.classList.add("opacity-50")}),r.addEventListener("dragend",()=>{r.classList.remove("opacity-50"),l.querySelectorAll(".merge-item").forEach(e=>e.classList.remove("border-primary"))}),r.addEventListener("dragover",e=>{e.preventDefault(),e.dataTransfer.dropEffect="move",r.classList.add("border-primary")}),r.addEventListener("dragleave",()=>{r.classList.remove("border-primary")}),r.addEventListener("drop",e=>{e.preventDefault();const r=parseInt(e.dataTransfer.getData("text/plain")),o=t;if(r!==o){const e=f[r];f.splice(r,1),f.splice(o,0,e),S()}}),l.appendChild(r)}):l.appendChild(u)};"number"==typeof r&&t.items[r]&&(f.push(t.items[r]),t.items[r+1]&&f.push(t.items[r+1])),a.open(),M(),S(),L(),c.addEventListener("click",async()=>{if(f.length<2)return;const e=parseInt(p.value),r=parseInt(g.value),o=h.value,s=y.value,n=i.querySelector('input[name="addToPlaylist"]').checked;if(!e||!r||e<128||r<128)return void alert("Please enter valid resolution dimensions (minimum 128×128)");i.querySelector(".options-group").classList.add("disabled"),p.disabled=!0,g.disabled=!0,h.disabled=!0,y.disabled=!0,c.disabled=!0,c.innerHTML='<span class="spinner-sm border-2 border-current border-t-transparent rounded-full w-4 h-4 animate-spin mr-xs"></span> Merging...';const a=i.querySelector(".merge-progress"),d=a.querySelector(".progress-bar-fill"),l=a.querySelector(".progress-percentage"),m=i.querySelector(".merge-error"),u=i.querySelector(".merge-success"),v=i.querySelector(".download-btn");a.classList.remove("hidden"),m.classList.add("hidden"),u.classList.add("hidden");try{const a=[];for(const e of f){const r=await MediaMetadata.getSourceBlob(e,()=>t._saveState());a.push(r)}const i=await MediaProcessor.merge({inputs:a,format:"mp4",resolution:{width:e,height:r},scaleMode:o,backgroundColor:s,onProgress:e=>{const t=Math.round(100*e);d.style.width=`${t}%`,l.textContent=`${t}%`}});u.classList.remove("hidden"),c.innerHTML="Merged";const m=URL.createObjectURL(i),p=`merged-${(new Date).toISOString().replace(/[:.]/g,"-")}.mp4`;if(v.href=m,v.download=p,v.classList.remove("hidden"),n){const e={title:p,url:m,duration:"...",thumbnail:"",isLocal:!0,file:new File([i],p,{type:"video/mp4"}),id:generateId()},r=t.items.indexOf(f[f.length-1]);-1!==r?t.items.splice(r+1,0,e):t.items.push(e),t._saveState(),t.render(),t._processMetadata([e])}}catch(e){console.error("Merge failed:",e),m.textContent=`Merge failed: ${e.message}`,m.classList.remove("hidden"),c.disabled=!1,c.innerHTML='<span class="mr-xs">Merge</span><svg width="16" height="16" fill="currentColor"><use href="assets/icons/sprite.svg#icon-layers"></use></svg>'}})}}