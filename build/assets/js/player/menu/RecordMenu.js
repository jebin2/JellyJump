import{Modal}from"../Modal.js";export class RecordMenu{static isRecording=!1;static mediaRecorder=null;static chunks=[];static async init(e,t){if(!t.player||!t.player.canvas)return console.error("RecordMenu: Player canvas not available"),void t._showToast("Error: Player not ready","error");this.checkActiveItem(e,t)?this.isRecording?this.stopRecording(t):(t.player.paused&&t._showToast("Recording started. Play video to capture.","info"),this._startRecording(t)):t._showToast("Please play this video to record it","warning")}static _startRecording(e){try{this.chunks=[];const t=e.player.canvas.captureStream(30);let o;const r=e.player.video||e.player.hlsPlayer&&e.player.hlsPlayer.video;r&&(r.captureStream?o=r.captureStream():r.mozCaptureStream&&(o=r.mozCaptureStream()));const a=[...t.getVideoTracks()];if(o){const e=o.getAudioTracks();e.length>0?(a.push(...e),console.log("RecordMenu: Audio tracks added")):console.warn("RecordMenu: No audio tracks found on video element stream")}else console.warn("RecordMenu: Could not capture audio stream from video element");const i=new MediaStream(a);this.mediaRecorder=new MediaRecorder(i,{mimeType:"video/webm;codecs=vp9,opus"}),this.mediaRecorder.ondataavailable=e=>{e.data.size>0&&this.chunks.push(e.data)},this.mediaRecorder.onstop=()=>{const t=`recording_${(new Date).toISOString().replace(/[:.]/g,"-")}.webm`,o=new Blob(this.chunks,{type:"video/webm"}),r=e.items[e.activeIndex].path||e.items[e.activeIndex].title,a=new File([o],t,{type:"video/webm"}),i={title:t,url:URL.createObjectURL(o),file:a,duration:"Loading...",type:"video",isLocal:!0,path:`${r}/${t}`,id:Date.now().toString()};e.addItems([i]);const s=URL.createObjectURL(o),c=document.createElement("a");c.style.display="none",c.href=s,c.download=t,document.body.appendChild(c),c.click(),setTimeout(()=>{document.body.removeChild(c),window.URL.revokeObjectURL(s)},100),e._showToast("Recording saved","success"),this.chunks=[],this.isRecording=!1,this.mediaRecorder=null},this.mediaRecorder.start(1e3),this.isRecording=!0,e.player.paused||e._showToast("Recording started. Play video to capture.","info")}catch(t){console.error("RecordMenu: Start Error",t),e._showToast("Failed to start recording: "+t.message,"error"),this.isRecording=!1}}static stopRecording(e){this.mediaRecorder&&"inactive"!==this.mediaRecorder.state&&(this.mediaRecorder.stop(),e._showToast("Stopping recording...","info"))}static handleItemChange(e){this.isRecording&&(console.log("RecordMenu: Item changed, stopping recording..."),this.stopRecording(e))}static checkActiveItem(e,t){if(!t||-1===t.activeIndex)return!1;return t.items[t.activeIndex]===e}}