import{Modal}from"../Modal.js";import{MediaProcessor}from"../../core/MediaProcessor.js";export class InfoMenu{static async init(e,o){const t=document.getElementById("info-content-template"),n=document.getElementById("info-footer-template");if(!t)return;const a=new Modal({maxWidth:"600px"});a.setTitle("Video Information"),a.setBody(t.content.cloneNode(!0)),n&&a.setFooter(n.content.cloneNode(!0));const i=a.modal,d=i.querySelector(".info-loading"),r=i.querySelector(".info-modal-content"),c=i.querySelectorAll(".copy-btn"),l=i.querySelector(".copy-all-btn");a.open();try{await o._ensureMetadata(e);let t=null;const n=(e,o=1)=>{if(0===e)return"0 Bytes";const t=o<0?0:o,n=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,n)).toFixed(t))+" "+["Bytes","KB","MB","GB","TB"][n]};let c="0 Bytes";if(e.file)c=n(e.file.size);else if(e.url)try{const o=(await fetch(e.url,{method:"HEAD"})).headers.get("content-length");o&&(c=n(parseInt(o)))}catch(e){c="Unknown"}const l={filename:e.title,format:e.file?e.file.type.split("/")[0]:"Unknown",mimeType:e.file?e.file.type:"Unknown",size:c,duration:e.duration||"Unknown",videoCodec:e.videoInfo?e.videoInfo.codec.toUpperCase():"N/A",videoCodecString:e.videoInfo?e.videoInfo.codec:"N/A",resolution:e.videoInfo?`${e.videoInfo.width}x${e.videoInfo.height}`:"N/A",codedResolution:e.videoInfo?`${e.videoInfo.codedWidth}x${e.videoInfo.codedHeight}`:"N/A",fps:"Calculating...",videoBitrate:"Calculating...",rotation:e.videoInfo?`${e.videoInfo.rotation}Â°`:"N/A",hdr:e.videoInfo?e.videoInfo.hasHDR?"Yes":"No":"N/A",audioCodec:e.audioInfo?e.audioInfo.codec.toUpperCase():"N/A",audioCodecString:e.audioInfo?e.audioInfo.codec:"N/A",channels:e.audioInfo?2===e.audioInfo.channels?"Stereo (2)":`${e.audioInfo.channels} Channels`:"N/A",sampleRate:e.audioInfo?`${(e.audioInfo.sampleRate/1e3).toFixed(1)} kHz`:"N/A",language:e.audioInfo?"und"===e.audioInfo.languageCode?"Undetermined":e.audioInfo.languageCode:"N/A"};if(e.videoInfo&&e.file)try{const o=await MediaProcessor.getTracks(e.file);t=o.video?o.video[0]:null}catch(e){console.warn("Could not get video track for packet stats:",e)}d.classList.add("hidden"),r.classList.remove("hidden"),Object.keys(l).forEach(e=>{const o=i.querySelector(`[data-key="${e}"]`);if(o){o.textContent=l[e];const t=o.parentElement.querySelector(".copy-btn");t&&(t.dataset.value=l[e])}}),a.body.dataset.rawInfo=JSON.stringify(l),t&&t.computePacketStats(50).then(e=>{const o=i.querySelector('.info-value[data-key="fps"]'),t=i.querySelector('.info-value[data-key="videoBitrate"]'),n=JSON.parse(a.body.dataset.rawInfo||"{}");if(o){const t=`${Math.round(e.averagePacketRate)} fps`;o.textContent=t;const a=o.parentElement.querySelector(".copy-btn");a&&(a.dataset.value=t),n.fps=t}if(t){const o=`${(e.averageBitrate/1e6).toFixed(1)} Mbps`;t.textContent=o;const a=t.parentElement.querySelector(".copy-btn");a&&(a.dataset.value=o),n.videoBitrate=o}a.body.dataset.rawInfo=JSON.stringify(n)}).catch(console.error)}catch(e){console.error("Failed to load video info:",e),d&&d.classList.add("hidden"),r&&r.classList.remove("hidden")}c.forEach(e=>{e.addEventListener("click",async()=>{const t=e.dataset.value;if(t)try{await navigator.clipboard.writeText(t),o._showToast("Copied to clipboard!")}catch(e){console.error("Failed to copy:",e)}})}),l&&l.addEventListener("click",async()=>{try{const e=JSON.parse(a.body.dataset.rawInfo||"{}"),t=`Video Information\n-----------------\nFilename: ${e.filename}\nFormat: ${e.format}\nMIME Type: ${e.mimeType}\nSize: ${e.size}\nDuration: ${e.duration}\n\nVideo Stream\n------------\nCodec: ${e.videoCodec} (${e.videoCodecString})\nResolution: ${e.resolution} (Coded: ${e.codedResolution})\nFrame Rate: ${e.fps}\nBitrate: ${e.videoBitrate}\nRotation: ${e.rotation}\nHDR: ${e.hdr}\n\nAudio Stream\n------------\nCodec: ${e.audioCodec} (${e.audioCodecString})\nChannels: ${e.channels}\nSample Rate: ${e.sampleRate}\nLanguage: ${e.language}\n`;await navigator.clipboard.writeText(t),o._showToast("All info copied to clipboard!")}catch(e){console.error("Failed to copy all:",e)}})}}