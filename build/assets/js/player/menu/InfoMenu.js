import{Modal}from"../Modal.js";import{MediaProcessor}from"../../core/MediaProcessor.js";export class InfoMenu{static async init(e,o){const t=document.getElementById("info-content-template"),n=document.getElementById("info-footer-template");if(!t)return;const i=new Modal({maxWidth:"600px"});i.setTitle("Video Information"),i.setBody(t.content.cloneNode(!0)),n&&i.setFooter(n.content.cloneNode(!0));const a=i.modal,d=a.querySelector(".info-loading"),r=a.querySelector(".info-modal-content"),l=a.querySelectorAll(".copy-btn"),c=a.querySelector(".copy-all-btn");i.open();try{if(e.isStream||e.isLive){const t=o.player&&o.player.src===e.url;let n="N/A",l="N/A";if(t&&o.player.videoElement){const e=o.player.videoElement;e.videoWidth&&(n=`${e.videoWidth}x${e.videoHeight}`)}const c={source:e.url||"Unknown",filename:e.title,format:"Stream (HLS/M3U8)",mimeType:e.mimeType||"application/vnd.apple.mpegurl",size:"N/A",duration:"LIVE",videoCodec:l,videoCodecString:"N/A",resolution:n,codedResolution:"N/A",fps:"N/A",videoBitrate:"N/A",rotation:"N/A",hdr:"N/A",audioCodec:"N/A",audioCodecString:"N/A",channels:"N/A",sampleRate:"N/A",language:"N/A"};return d&&d.classList.add("hidden"),r&&r.classList.remove("hidden"),Object.keys(c).forEach(e=>{const o=a.querySelector(`[data-key="${e}"]`);if(o){o.textContent=c[e];const t=o.parentElement.querySelector(".copy-btn");t&&(t.dataset.value=c[e]),"source"===e&&(o.title=c[e])}}),void(i.body.dataset.rawInfo=JSON.stringify(c))}await o._ensureMetadata(e);const t=(e,o=1)=>{if(0===e)return"0 Bytes";const t=o<0?0:o,n=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,n)).toFixed(t))+" "+["Bytes","KB","MB","GB","TB"][n]};let n="Unknown";if(e.fileSize)n=t(e.fileSize);else if(e.file)n=t(e.file.size);else if(e.url)try{const o=(await fetch(e.url,{method:"HEAD"})).headers.get("content-length");o&&(n=t(parseInt(o)))}catch(e){n="Unknown"}let l="Unknown",c="Unknown";e.videoInfo&&(e.videoInfo.fps&&(l=`${e.videoInfo.fps} fps`),e.videoInfo.bitrate&&(c=`${(e.videoInfo.bitrate/1e6).toFixed(1)} Mbps`));const s=e.fileType||(e.file?e.file.type:"Unknown"),f="Unknown"!==s?s.split("/")[0]:"Unknown",u={source:e.isLocal?"Local File":e.url||"Unknown",filename:e.title,format:f,mimeType:s,size:n,duration:e.duration||"Unknown",videoCodec:e.videoInfo?e.videoInfo.codec.toUpperCase():"N/A",videoCodecString:e.videoInfo?e.videoInfo.codec:"N/A",resolution:e.videoInfo?`${e.videoInfo.width}x${e.videoInfo.height}`:"N/A",codedResolution:e.videoInfo?`${e.videoInfo.codedWidth}x${e.videoInfo.codedHeight}`:"N/A",fps:l,videoBitrate:c,rotation:e.videoInfo?`${e.videoInfo.rotation}Â°`:"N/A",hdr:e.videoInfo?e.videoInfo.hasHDR?"Yes":"No":"N/A",audioCodec:e.audioInfo?e.audioInfo.codec.toUpperCase():"N/A",audioCodecString:e.audioInfo?e.audioInfo.codec:"N/A",channels:e.audioInfo?2===e.audioInfo.channels?"Stereo (2)":`${e.audioInfo.channels} Channels`:"N/A",sampleRate:e.audioInfo?`${(e.audioInfo.sampleRate/1e3).toFixed(1)} kHz`:"N/A",language:e.audioInfo?"und"===e.audioInfo.languageCode?"Undetermined":e.audioInfo.languageCode:"N/A"};d&&d.classList.add("hidden"),r&&r.classList.remove("hidden"),Object.keys(u).forEach(e=>{const o=a.querySelector(`[data-key="${e}"]`);if(o){o.textContent=u[e];const t=o.parentElement.querySelector(".copy-btn");t&&(t.dataset.value=u[e]),"source"===e&&(o.title=u[e])}}),i.body.dataset.rawInfo=JSON.stringify(u)}catch(e){console.error("Failed to load video info:",e),d&&d.classList.add("hidden"),r&&r.classList.remove("hidden")}l.forEach(e=>{e.addEventListener("click",async()=>{const t=e.dataset.value;if(t)try{await navigator.clipboard.writeText(t),o._showToast("Copied to clipboard!")}catch(e){console.error("Failed to copy:",e)}})}),c&&c.addEventListener("click",async()=>{try{const e=JSON.parse(i.body.dataset.rawInfo||"{}"),t=`Video Information\n-----------------\nFilename: ${e.filename}\nFormat: ${e.format}\nMIME Type: ${e.mimeType}\nSize: ${e.size}\nDuration: ${e.duration}\n\nVideo Stream\n------------\nCodec: ${e.videoCodec} (${e.videoCodecString})\nResolution: ${e.resolution} (Coded: ${e.codedResolution})\nFrame Rate: ${e.fps}\nBitrate: ${e.videoBitrate}\nRotation: ${e.rotation}\nHDR: ${e.hdr}\n\nAudio Stream\n------------\nCodec: ${e.audioCodec} (${e.audioCodecString})\nChannels: ${e.channels}\nSample Rate: ${e.sampleRate}\nLanguage: ${e.language}\n`;await navigator.clipboard.writeText(t),o._showToast("All info copied to clipboard!")}catch(e){console.error("Failed to copy all:",e)}})}}