import{Modal}from"../Modal.js";import{CorePlayer}from"../../core/Player.js";import{MediaProcessor}from"../../core/MediaProcessor.js";import{MediaMetadata}from"../../utils/MediaMetadata.js";import{generateId}from"../../utils/mediaUtils.js";export class TrimMenu{static async init(e,t){const o=document.getElementById("trim-content-template"),r=document.getElementById("trim-footer-template");if(!o||!r)return;const n=new Modal({maxWidth:"600px"});n.setTitle("Trim Video"),n.setBody(o.content.cloneNode(!0)),n.setFooter(r.content.cloneNode(!0));const s=n.modal;n.open();const a=s.querySelector("#trim-player-container");let i=null;a&&(i=new CorePlayer("trim-player-container",{mode:"player",controls:{playPause:!0,volume:!1,time:!0,progress:!0,captions:!1,settings:!1,fullscreen:!1,loop:!1,speed:!1,modeToggle:!1},autoplay:!1}));const l=s.querySelector(".trim-loading"),d=s.querySelector(".trim-content"),c=s.querySelector(".source-filename"),m=s.querySelector("#trim-start-input"),u=s.querySelector("#trim-end-input"),p=s.querySelector(".trim-duration"),y=s.querySelector(".total-duration"),h=s.querySelector(".timeline-slider"),g=s.querySelector(".timeline-range"),f=s.querySelector(".start-handle"),S=s.querySelector(".end-handle"),v=s.querySelector('input[name="addToPlaylist"]'),M=s.querySelector(".trim-btn"),L=s.querySelector(".download-btn"),b=s.querySelector(".progress-section"),q=s.querySelector(".progress-bar-fill"),w=s.querySelector(".progress-percentage"),E=s.querySelector(".error-message"),$=s.querySelector(".success-message");M.disabled=!0;const x=e=>{const t=Math.floor(e/3600),o=Math.floor(e%3600/60),r=Math.floor(e%60);return`${t.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}:${r.toString().padStart(2,"0")} `};c.textContent=e.title,c.title=e.title,await t._ensureMetadata(e);let C=0;if(e.duration&&"string"==typeof e.duration&&"--:--"!==e.duration){const t=e.duration.split(":").map(Number);3===t.length?C=3600*t[0]+60*t[1]+t[2]:2===t.length&&(C=60*t[0]+t[1])}l.classList.add("hidden"),d.classList.remove("hidden"),M.disabled=!1,y.textContent=x(C);let P=0,B=C;if(i){const t=e.file?URL.createObjectURL(e.file):e.url;await i.load(t,!1),i.loopMode="ab",i.loopStart=P,i.loopEnd=B}const j=()=>{document.activeElement!==m&&(m.value=x(P)),document.activeElement!==u&&(u.value=x(B));const e=Math.max(0,B-P);p.textContent=x(e);const t=P/C*100,o=B/C*100;f.style.left=`${t}% `,S.style.left=`${o}% `,g.style.left=`${t}% `,g.style.width=o-t+"% ",i&&(i.loopStart=P,i.loopEnd=B,"ab"!==i.loopMode&&(i.loopMode="ab"));const r=P<B&&B-P>=1;M.disabled=!r,r?E.classList.add("hidden"):(P>=B?E.textContent="Start time must be before end time.":B-P<1&&(E.textContent="Duration must be at least 1 second."),E.classList.remove("hidden"))};j();const T=(e,t)=>{const o=(e=>{if("number"==typeof e)return e;const t=e.split(":").map(Number);return 3===t.length?3600*t[0]+60*t[1]+t[2]:2===t.length?60*t[0]+t[1]:0})(e.value);t?o>=0&&o<C&&(P=o):o>0&&o<=C&&(B=o),j()};m.addEventListener("change",()=>T(m,!0)),u.addEventListener("change",()=>T(u,!1));const N=(e,t)=>{e.addEventListener("mousedown",e=>{e.preventDefault();const o=e=>((e,t)=>{const o=h.getBoundingClientRect(),r=e.clientX-o.left,n=Math.max(0,Math.min(1,r/o.width))*C;t?(n<B-1&&(P=n),i&&i.seek(P)):(n>P+1&&(B=n),i&&i.seek(B)),j()})(e,t),r=()=>{document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",r)};document.addEventListener("mousemove",o),document.addEventListener("mouseup",r)})};N(f,!0),N(S,!1);const R=n.close.bind(n);n.close=()=>{i&&i.destroy(),R()},M.addEventListener("click",async()=>{s.classList.add("processing"),M.disabled=!0,n.closeBtn.disabled=!0,b.classList.remove("hidden"),E.classList.add("hidden"),$.classList.add("hidden");try{const o=await MediaMetadata.getSourceBlob(e,()=>t._saveState()),r=await MediaProcessor.process({source:o,format:"mp4",quality:100,trim:{start:P,end:B},onProgress:e=>{const t=Math.round(100*e);q.style.width=`${t}% `,w.textContent=`${t}% `}});$.classList.remove("hidden");const s="mp4",a=e.title.replace(/\.[^/.]+$/,"")+`- trimmed - ${Math.round(P)} -${Math.round(B)}.${s} `,i=URL.createObjectURL(r);if(L.href=i,L.download=a,L.classList.remove("hidden"),v.checked){const o={id:generateId(),title:a,url:i,file:new File([r],a,{type:`video / ${s} `}),duration:x(B-P),type:"video",isLocal:!0,isNew:!0},n=t.items.indexOf(e)+1;t.items.splice(n,0,o),t.render(),t._saveState()}n.closeBtn.disabled=!1}catch(e){console.error("Trimming failed:",e),E.textContent=`Trimming failed: ${e.message} `,E.classList.remove("hidden"),M.disabled=!1,n.closeBtn.disabled=!1,b.classList.add("hidden")}})}}