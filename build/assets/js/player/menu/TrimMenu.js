import{Modal}from"../Modal.js";import{CorePlayer}from"../../core/Player.js";import{MediaProcessor}from"../../core/MediaProcessor.js";import{MediaMetadata}from"../../utils/MediaMetadata.js";import{generateId}from"../../utils/mediaUtils.js";export class TrimMenu{static async init(e,t){const o=document.getElementById("trim-content-template"),r=document.getElementById("trim-footer-template");if(!o||!r)return;const n=new Modal({maxWidth:"600px"});n.setTitle("Trim Video"),n.setBody(o.content.cloneNode(!0)),n.setFooter(r.content.cloneNode(!0));const a=n.modal;n.open();const s=a.querySelector("#trim-player-container");let i=null;s&&(i=new CorePlayer("trim-player-container",{mode:"player",controlBarMode:"fixed",controls:{playPause:!0,navigation:!1,volume:!1,time:!0,progress:!0,captions:!1,settings:!1,fullscreen:!1,loop:!1,speed:!1,modeToggle:!1,keyboard:!1},autoplay:!1}));const d=a.querySelector(".trim-loading"),l=a.querySelector(".trim-content"),c=a.querySelector(".source-filename"),m=a.querySelector("#trim-start-input"),u=a.querySelector("#trim-end-input"),p=a.querySelector(".trim-duration"),y=a.querySelector(".total-duration"),h=a.querySelector(".timeline-slider"),g=a.querySelector(".timeline-range"),S=a.querySelector(".start-handle"),f=a.querySelector(".end-handle"),v=a.querySelector('input[name="addToPlaylist"]'),M=a.querySelector(".trim-btn"),b=a.querySelector(".download-btn"),L=a.querySelector(".progress-section"),q=a.querySelector(".progress-bar-fill"),w=a.querySelector(".progress-percentage"),x=a.querySelector(".error-message"),E=a.querySelector(".success-message");M.disabled=!0;const $=e=>{const t=Math.floor(e/3600),o=Math.floor(e%3600/60),r=Math.floor(e%60);return`${t.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}:${r.toString().padStart(2,"0")} `};c.textContent=e.title,c.title=e.title,await t._ensureMetadata(e);let C=0;if(e.duration&&"string"==typeof e.duration&&"--:--"!==e.duration){const t=e.duration.split(":").map(Number);3===t.length?C=3600*t[0]+60*t[1]+t[2]:2===t.length&&(C=60*t[0]+t[1])}d.classList.add("hidden"),l.classList.remove("hidden"),M.disabled=!1,y.textContent=$(C);let P=0,B=C;i&&(await MediaMetadata.getProcessedSourceURL(e,()=>t._saveState()),await i.load(e.blob_url,!1),i.loopMode="ab",i.loopStart=P,i.loopEnd=B);const T=()=>{document.activeElement!==m&&(m.value=$(P)),document.activeElement!==u&&(u.value=$(B));const e=Math.max(0,B-P);p.textContent=$(e);const t=P/C*100,o=B/C*100;S.style.left=`${t}% `,f.style.left=`${o}% `,g.style.left=`${t}% `,g.style.width=o-t+"% ",i&&(i.loopStart=P,i.loopEnd=B,"ab"!==i.loopMode&&(i.loopMode="ab"));const r=P<B&&B-P>=1;M.disabled=!r,r?x.classList.add("hidden"):(P>=B?x.textContent="Start time must be before end time.":B-P<1&&(x.textContent="Duration must be at least 1 second."),x.classList.remove("hidden"))};T();const j=(e,t)=>{const o=(e=>{if("number"==typeof e)return e;const t=e.split(":").map(Number);return 3===t.length?3600*t[0]+60*t[1]+t[2]:2===t.length?60*t[0]+t[1]:0})(e.value);t?o>=0&&o<C&&(P=o):o>0&&o<=C&&(B=o),T()};m.addEventListener("change",()=>j(m,!0)),u.addEventListener("change",()=>j(u,!1));const k=(e,t)=>{e.addEventListener("mousedown",e=>{e.preventDefault();const o=e=>((e,t)=>{const o=h.getBoundingClientRect(),r=e.clientX-o.left,n=Math.max(0,Math.min(1,r/o.width))*C;t?(n<B-1&&(P=n),i&&i.seek(P)):(n>P+1&&(B=n),i&&i.seek(B)),T()})(e,t),r=()=>{document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",r)};document.addEventListener("mousemove",o),document.addEventListener("mouseup",r)})};k(S,!0),k(f,!1);const N=n.close.bind(n);n.close=()=>{i&&i.destroy(),N()},M.addEventListener("click",async()=>{a.classList.add("processing"),M.disabled=!0,n.closeBtn.disabled=!0,L.classList.remove("hidden"),x.classList.add("hidden"),E.classList.add("hidden");try{const o=await MediaMetadata.getSourceBlob(e,()=>t._saveState()),r=await MediaProcessor.process({source:o,format:"mp4",quality:100,trim:{start:P,end:B},onProgress:e=>{const t=Math.round(100*e);q.style.width=`${t}% `,w.textContent=`${t}% `}});E.classList.remove("hidden");const a="mp4",s=e.title.replace(/\.[^/.]+$/,"")+`- trimmed - ${Math.round(P)} -${Math.round(B)}.${a} `,i=URL.createObjectURL(r);if(b.href=i,b.download=s,b.classList.remove("hidden"),v.checked){const o={id:generateId(),title:s,url:i,file:new File([r],s,{type:`video/${a}`}),duration:$(B-P),type:"video",isLocal:!0,isNew:!0,path:(e.path||e.title)+"/"+s},n=t.items.indexOf(e)+1;t.items.splice(n,0,o),t.render(),t._saveState()}n.closeBtn.disabled=!1}catch(e){console.error("Trimming failed:",e),x.textContent=`Trimming failed: ${e.message} `,x.classList.remove("hidden"),M.disabled=!1,n.closeBtn.disabled=!1,L.classList.add("hidden")}})}}