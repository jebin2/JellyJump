import{Modal}from"../Modal.js";import{MediaProcessor}from"../../core/MediaProcessor.js";import{MediaMetadata}from"../../utils/MediaMetadata.js";import{generateId}from"../../utils/mediaUtils.js";export class ResizeMenu{static async init(e,t){const s=document.getElementById("resize-content-template"),o=document.getElementById("resize-footer-template");if(!s||!o)return;const i=new Modal({maxWidth:"550px"});i.setTitle("Resize Video"),i.setBody(s.content.cloneNode(!0)),i.setFooter(o.content.cloneNode(!0));const r=i.modal,a=r.querySelector(".current-resolution"),n=r.querySelector(".current-aspect-ratio"),d=r.querySelector("#resize-width"),l=r.querySelector("#resize-height"),c=r.querySelector(".aspect-lock-btn"),u=r.querySelectorAll(".preset-btn"),m=r.querySelector('input[name="addToPlaylist"]'),p=r.querySelector(".resize-btn"),h=r.querySelector(".download-btn"),y=r.querySelector(".resize-progress"),v=r.querySelector(".progress-bar-fill"),f=r.querySelector(".progress-percentage"),b=r.querySelector(".status-text"),L=r.querySelector(".resize-error"),g=r.querySelector(".resize-success");i.open();let w=0,x=0,S=0,j=!0;const M=(e,t,s)=>{"width"!==s&&(d.value=Math.round(e)),"height"!==s&&(l.value=Math.round(t))};try{if(await t._ensureMetadata(e),!(e.videoInfo&&e.videoInfo.width&&e.videoInfo.height))throw new Error("No video metadata available");w=e.videoInfo.width,x=e.videoInfo.height,S=w/x,a.textContent=`${w}x${x}`,n.textContent=((e,t)=>{const s=(e,t)=>t?s(t,e%t):e,o=s(e,t);return`${e/o}:${t/o}`})(w,x),M(w,x)}catch(e){console.error("Failed to load video info:",e),a.textContent="Unknown",L.textContent="Failed to load video info. Resizing may not work.",L.classList.remove("hidden")}c.addEventListener("click",()=>{if(j=!j,c.setAttribute("aria-pressed",j),c.classList.toggle("jellyjump-btn-primary",j),c.classList.toggle("jellyjump-btn-secondary",!j),j){const e=parseInt(d.value)||w;M(e,e/S,"width")}}),d.addEventListener("input",()=>{const e=parseInt(d.value);j&&e&&S&&M(e,e/S,"width")}),l.addEventListener("input",()=>{const e=parseInt(l.value);j&&e&&S&&M(e*S,e,"height")}),u.forEach(e=>{e.addEventListener("click",()=>{let t;switch(e.dataset.preset){case"1080p":t=1080;break;case"720p":t=720;break;case"480p":t=480;break;case"360p":t=360}t&&(M(t*S,t),u.forEach(e=>e.classList.remove("jellyjump-btn-primary")),u.forEach(e=>e.classList.add("jellyjump-btn-secondary")),e.classList.remove("jellyjump-btn-secondary"),e.classList.add("jellyjump-btn-primary"))})}),p.addEventListener("click",async()=>{const s=parseInt(d.value),o=parseInt(l.value);if(!s||!o||s<128||o<128)return L.textContent="Dimensions must be at least 128px.",void L.classList.remove("hidden");if(s%2!=0||o%2!=0)return L.textContent="Dimensions must be even numbers.",void L.classList.remove("hidden");L.classList.add("hidden"),y.classList.remove("hidden"),p.disabled=!0,i.closeBtn.disabled=!0,b.textContent=`Resizing to ${s}x${o}...`;try{const r=await MediaMetadata.getSourceBlob(e,()=>t._saveState()),a=await MediaProcessor.process({source:r,format:"mp4",quality:100,resize:{width:s,height:o},onProgress:e=>{const t=Math.round(100*e);v.style.width=`${t}%`,f.textContent=`${t}%`}});g.classList.remove("hidden"),y.classList.add("hidden");const n="mp4",d=e.title.replace(/\.[^/.]+$/,"")+`-${s}x${o}.${n}`,l=URL.createObjectURL(a);if(h.href=l,h.download=d,h.classList.remove("hidden"),p.disabled=!1,p.classList.remove("hidden"),b.textContent="Resizing video...",v.style.width="0%",f.textContent="0%",m.checked){const s={id:generateId(),title:d,url:l,file:new File([a],d,{type:`video/${n}`}),duration:e.duration,type:"video",isLocal:!0,isNew:!0},o=t.items.indexOf(e)+1;t.items.splice(o,0,s),t.render(),t._saveState()}i.closeBtn.disabled=!1}catch(e){console.error("Resize failed:",e),L.textContent=`Resize failed: ${e.message}`,L.classList.remove("hidden"),y.classList.add("hidden"),p.disabled=!1,i.closeBtn.disabled=!1}})}}