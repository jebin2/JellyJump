import{Modal}from"../Modal.js";import{CorePlayer}from"../../core/Player.js";import{MediaProcessor}from"../../core/MediaProcessor.js";import{MediaMetadata}from"../../utils/MediaMetadata.js";import{generateId,formatDuration,formatTime,parseTime,formatFileSize}from"../../utils/mediaUtils.js";export class GifMenu{static async init(e,t){const o=document.getElementById("gif-content-template"),i=document.getElementById("gif-footer-template");if(!o||!i)return void console.error("GIF modal templates not found!");const a=new Modal({maxWidth:"600px"});a.setTitle("Create GIF"),a.setBody(o.content.cloneNode(!0)),a.setFooter(i.content.cloneNode(!0));const r=a.modal;a.open();const s=r.querySelector("#gif-player-container");let d=null;s&&(d=new CorePlayer("gif-player-container",{mode:"player",controlBarMode:"fixed",controls:{playPause:!0,navigation:!1,volume:!1,time:!0,progress:!0,captions:!1,settings:!1,fullscreen:!1,loop:!1,speed:!1,modeToggle:!1,keyboard:!1},autoplay:!1}));const n=r.querySelector(".gif-loading"),l=r.querySelector(".gif-content"),c=r.querySelector(".source-filename"),u=r.querySelector(".source-duration"),m=r.querySelector(".source-resolution");c.textContent=e.title,c.title=e.title,await t._ensureMetadata(e),n.classList.add("hidden"),l.classList.remove("hidden");let f=0;if(e.duration&&"string"==typeof e.duration&&"--:--"!==e.duration){const t=e.duration.split(":").map(Number);2===t.length?f=60*t[0]+t[1]:3===t.length&&(f=3600*t[0]+60*t[1]+t[2])}u.textContent=formatDuration(f),m.textContent=e.videoInfo?`${e.videoInfo.width}Ã—${e.videoInfo.height} `:"Unknown",d&&(await MediaMetadata.getProcessedSourceURL(e,()=>t._saveState()),await d.load(e.blob_url,!1),d.loopMode="ab",d.loopStart=0,d.loopEnd=Math.min(f,10));const p=r.querySelector("#gif-start-input"),g=r.querySelector("#gif-end-input"),y=r.querySelector(".gif-duration"),h=r.querySelector(".time-validation-error"),v=r.querySelector("#gif-fps"),b=r.querySelector("#gif-size"),S=r.querySelector("#gif-quality"),q=r.querySelector("#gif-quality-value"),M=r.querySelector(".create-gif-btn"),L=r.querySelector(".download-btn"),w=r.querySelector(".progress-section"),x=r.querySelector(".progress-bar-fill"),I=r.querySelector(".progress-percentage"),C=r.querySelector(".gif-preview-section"),F=r.querySelector(".gif-preview-image"),T=r.querySelector(".gif-file-size"),E=r.querySelector(".error-message"),P=r.querySelector(".success-message");g.value=formatTime(Math.min(f,10));const $=()=>{const e=parseTime(p.value),t=parseTime(g.value),o=t-e;return d&&(d.loopStart=e,d.loopEnd=t),h.classList.add("hidden"),M.disabled=!1,e>=t?(h.textContent="Start time must be before end time",h.classList.remove("hidden"),M.disabled=!0,!1):o<.5?(h.textContent="GIF duration must be at least 0.5 seconds",h.classList.remove("hidden"),M.disabled=!0,!1):o>60?(h.textContent="GIF duration must not exceed 60 seconds",h.classList.remove("hidden"),M.disabled=!0,!1):t>f?(h.textContent="End time exceeds video duration",h.classList.remove("hidden"),M.disabled=!0,!1):(y.textContent=`${o.toFixed(1)} s`,!0)};p.addEventListener("input",$),g.addEventListener("input",$),S.addEventListener("input",()=>{const e=parseInt(S.value);q.textContent={40:"Low",60:"Medium",80:"High",100:"Original"}[e]||"Medium"}),M.addEventListener("click",async()=>{if(!$())return;const o=parseTime(p.value),i=parseTime(g.value),a=parseInt(v.value),s=b.value,d=parseInt(S.value),n=r.querySelector('input[name="addToPlaylist"]').checked;p.disabled=!0,g.disabled=!0,v.disabled=!0,b.disabled=!0,S.disabled=!0,M.disabled=!0,w.classList.remove("hidden"),E.classList.add("hidden"),P.classList.add("hidden");try{let r,l,c;if("original"===s)r=e.videoInfo.width,l=e.videoInfo.height;else{l={720:720,480:480,360:360}[s],r=Math.round(e.videoInfo.width/e.videoInfo.height*l)}try{c=await MediaMetadata.getSourceBlob(e,()=>t._saveState())}catch(e){throw console.error("Failed to get source blob:",e),new Error("Cannot access video file")}const u=await MediaProcessor.createGif({input:c,startTime:o,duration:i-o,fps:a,width:r,height:l,quality:d,onProgress:e=>{const t=Math.round(100*e);x.style.width=`${t}% `,I.textContent=`${t}% `}});P.classList.remove("hidden");const m=URL.createObjectURL(u);F.src=m,T.textContent=formatFileSize(u.size),C.classList.remove("hidden");const f=Math.round(o).toString().padStart(2,"0")+"-"+Math.round(i).toString().padStart(2,"0"),y=`${e.title.replace(/\.[^.]+$/,"")} -${f}.gif`;if(L.href=m,L.download=y,L.classList.remove("hidden"),n){const a={title:y,url:m,duration:formatDuration(i-o),thumbnail:m,isLocal:!0,file:new File([u],y,{type:"image/gif"}),id:generateId(),type:"image/gif"},r=t.items.indexOf(e);-1!==r?t.items.splice(r+1,0,a):t.items.push(a),t._saveState(),t.render()}p.disabled=!1,g.disabled=!1,v.disabled=!1,b.disabled=!1,S.disabled=!1,M.disabled=!1}catch(e){console.error("GIF creation failed:",e),E.textContent=`GIF creation failed: ${e.message} `,E.classList.remove("hidden"),p.disabled=!1,g.disabled=!1,v.disabled=!1,b.disabled=!1,S.disabled=!1,M.disabled=!1}});const G=a.close.bind(a);a.close=()=>{d&&d.destroy(),G()},$()}}