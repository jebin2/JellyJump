import{Modal}from"../Modal.js";import{MediaProcessor}from"../../core/MediaProcessor.js";import{MediaMetadata}from"../../utils/MediaMetadata.js";import{generateId,formatDuration,formatFileSize}from"../../utils/mediaUtils.js";export class ReverseMenu{static async init(e,t){const o=document.getElementById("reverse-content-template"),r=document.getElementById("reverse-footer-template");if(!o||!r)return void console.error("Reverse modal templates not found!");const s=new Modal({maxWidth:"500px"});s.setTitle("Reverse Video"),s.setBody(o.content.cloneNode(!0)),s.setFooter(r.content.cloneNode(!0));const d=s.modal;s.open();const i=d.querySelector(".source-filename"),a=d.querySelector(".source-duration"),n=d.querySelector(".source-resolution"),l=d.querySelector("#reverse-include-audio"),c=d.querySelector(".processing-info"),u=d.querySelector("#long-video-warning"),m=d.querySelector(".reverse-btn"),y=d.querySelector(".download-btn"),v=d.querySelector(".progress-section"),p=d.querySelector(".progress-bar-fill"),h=d.querySelector(".progress-percentage"),g=d.querySelector(".progress-status"),f=(d.querySelector(".frame-counter"),d.querySelector(".error-message")),S=d.querySelector(".success-message"),b=d.querySelector(".reverse-loading"),q=d.querySelector(".reverse-content");m.disabled=!0,i.textContent=e.title,i.title=e.title,await t._ensureMetadata(e),b.classList.add("hidden"),q.classList.remove("hidden"),m.disabled=!1;let L=0;if(e.duration&&"string"==typeof e.duration&&"--:--"!==e.duration){const t=e.duration.split(":").map(Number);2===t.length?L=60*t[0]+t[1]:3===t.length&&(L=3600*t[0]+60*t[1]+t[2])}a.textContent=formatDuration(L),n.textContent=e.videoInfo?`${e.videoInfo.width}Ã—${e.videoInfo.height}`:"Unknown",L>60?(u.classList.remove("hidden"),c.classList.remove("hidden")):c.classList.add("hidden");m.addEventListener("click",async()=>{const o=l.checked;m.disabled=!0,y.disabled=!0,l.disabled=!0,v.classList.remove("hidden"),f.classList.add("hidden"),S.classList.add("hidden");const r=s.close;s.close=()=>{},s.modal.querySelector(".mb-modal-close").style.display="none";try{let r;try{r=await MediaMetadata.getSourceBlob(e,()=>t._saveState())}catch(e){throw console.error("Failed to get source blob:",e),new Error("Cannot access video file")}const s=await MediaProcessor.reverseVideo({source:r,includeAudio:o,onProgress:e=>{const t=Math.round(100*e);p.style.width=`${t}%`,h.textContent=`${t}%`,g.textContent=e<.4?"Extracting frames...":e<.9?"Reversing & Encoding...":"Finalizing..."}});S.classList.remove("hidden"),v.classList.add("hidden");(new Date).toISOString().replace(/[:.]/g,"-").slice(0,19);const d=`${e.title.replace(/\.[^.]+$/,"")}-reversed.mp4`,i=URL.createObjectURL(s);y.onclick=()=>{const e=document.createElement("a");e.href=i,e.download=d,document.body.appendChild(e),e.click(),document.body.removeChild(e)},y.disabled=!1,y.classList.remove("hidden"),l.disabled=!1,m.disabled=!1;const a={title:d,url:i,duration:null,thumbnail:e.thumbnail,isLocal:!0,file:new File([s],d,{type:"video/mp4"}),id:generateId(),type:"video/mp4"},n=t.items.indexOf(e);-1!==n?t.items.splice(n+1,0,a):t.items.push(a),await t._ensureMetadata(a),t._saveState(),t.render()}catch(e){console.error("Reversal failed:",e),f.textContent=`Reversal failed: ${e.message}`,f.classList.remove("hidden"),v.classList.add("hidden"),l.disabled=!1,m.disabled=!1}finally{s.close=r,s.modal.querySelector(".mb-modal-close").style.display=""}})}}