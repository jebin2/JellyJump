import{Modal}from"../Modal.js";import{MediaProcessor}from"../../core/MediaProcessor.js";import{MediaMetadata}from"../../utils/MediaMetadata.js";import{generateId,formatDuration,formatFileSize}from"../../utils/mediaUtils.js";import{SpeedDropdown}from"../../utils/SpeedDropdown.js";export class ReverseMenu{static async init(e,t){const o=document.getElementById("reverse-content-template"),r=document.getElementById("reverse-footer-template");if(!o||!r)return void console.error("Reverse modal templates not found!");const s=new Modal({maxWidth:"500px"});s.setTitle("Reverse Video"),s.setBody(o.content.cloneNode(!0)),s.setFooter(r.content.cloneNode(!0));const d=s.modal;s.open();const i=d.querySelector(".source-filename"),a=d.querySelector(".source-duration"),n=d.querySelector(".source-resolution"),l=d.querySelector("#reverse-include-audio"),c=d.querySelector("[data-speed-btn]"),u=d.querySelector("[data-speed-menu]"),m=SpeedDropdown.init({button:c,menu:u}),p=d.querySelector(".processing-info"),y=d.querySelector("#long-video-warning"),v=d.querySelector(".reverse-btn"),h=d.querySelector(".download-btn"),S=d.querySelector(".progress-section"),g=d.querySelector(".progress-bar-fill"),b=d.querySelector(".progress-percentage"),f=d.querySelector(".progress-status"),q=(d.querySelector(".frame-counter"),d.querySelector(".error-message")),w=d.querySelector(".success-message"),L=d.querySelector(".reverse-loading"),M=d.querySelector(".reverse-content");v.disabled=!0,i.textContent=e.title,i.title=e.title,await t._ensureMetadata(e),L.classList.add("hidden"),M.classList.remove("hidden"),v.disabled=!1;let x=0;if(e.duration&&"string"==typeof e.duration&&"--:--"!==e.duration){const t=e.duration.split(":").map(Number);2===t.length?x=60*t[0]+t[1]:3===t.length&&(x=3600*t[0]+60*t[1]+t[2])}a.textContent=formatDuration(x),n.textContent=e.videoInfo?`${e.videoInfo.width}Ã—${e.videoInfo.height}`:"Unknown",x>60?(y.classList.remove("hidden"),p.classList.remove("hidden")):p.classList.add("hidden");v.addEventListener("click",async()=>{const o=l.checked,r=m.getCurrentSpeed();v.disabled=!0,h.disabled=!0,l.disabled=!0,m.setDisabled(!0),S.classList.remove("hidden"),q.classList.add("hidden"),w.classList.add("hidden");const d=s.close;s.close=()=>{},s.modal.querySelector(".mb-modal-close").style.display="none";try{let s;try{s=await MediaMetadata.getSourceBlob(e,()=>t._saveState())}catch(e){throw console.error("Failed to get source blob:",e),new Error("Cannot access video file")}const d=await MediaProcessor.reverseVideo({source:s,includeAudio:o,speed:r,onProgress:e=>{const t=Math.round(100*e);g.style.width=`${t}%`,b.textContent=`${t}%`,f.textContent=e<.4?"Extracting frames...":e<.9?"Reversing & Encoding...":"Finalizing..."}});w.classList.remove("hidden"),S.classList.add("hidden");(new Date).toISOString().replace(/[:.]/g,"-").slice(0,19);const i=`${e.title.replace(/\.[^.]+$/,"")}-reversed.mp4`,a=URL.createObjectURL(d);h.onclick=()=>{const e=document.createElement("a");e.href=a,e.download=i,document.body.appendChild(e),e.click(),document.body.removeChild(e)},h.disabled=!1,h.classList.remove("hidden"),l.disabled=!1,m.setDisabled(!1),v.disabled=!1;const n={title:i,url:a,duration:null,thumbnail:e.thumbnail,isLocal:!0,file:new File([d],i,{type:"video/mp4"}),id:generateId(),type:"video/mp4"},c=t.items.indexOf(e);-1!==c?t.items.splice(c+1,0,n):t.items.push(n),await t._ensureMetadata(n),t._saveState(),t.render()}catch(e){console.error("Reversal failed:",e),q.textContent=`Reversal failed: ${e.message}`,q.classList.remove("hidden"),S.classList.add("hidden"),l.disabled=!1,m.setDisabled(!1),v.disabled=!1}finally{s.close=d,s.modal.querySelector(".mb-modal-close").style.display=""}})}}