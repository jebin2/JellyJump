import{Modal}from"../Modal.js";import{CorePlayer}from"../../core/Player.js";import{MediaMetadata}from"../../utils/MediaMetadata.js";import{MediaProcessor}from"../../core/MediaProcessor.js";import{generateId,formatDuration}from"../../utils/mediaUtils.js";export class RemoveBackgroundMenu{static async init(e,t){const o=document.getElementById("remove-bg-content-template"),s=document.getElementById("remove-bg-footer-template");if(!o||!s)return void console.error("Remove Background modal templates not found!");const n=new Modal({maxWidth:"900px"});n.setTitle("Remove Background"),n.setBody(o.content.cloneNode(!0)),n.setFooter(s.content.cloneNode(!0));const r=n.modal;n.open();const a=r.querySelector("#remove-bg-player-container"),i=r.querySelector(".selected-colors-list"),l=r.querySelector("#pick-color-btn"),c=r.querySelector("#live-preview-toggle"),d=r.querySelectorAll('input[name="bg-type"]'),u=r.querySelector("#custom-bg-color"),m=r.querySelector(".process-btn"),g=r.querySelector(".download-btn"),h=r.querySelector(".progress-section"),p=r.querySelector(".progress-bar-fill"),y=r.querySelector(".progress-percentage"),v=r.querySelector(".progress-status"),b=r.querySelector(".error-message"),f=r.querySelector(".success-message");let k=[],x=null,M=!1,S=null;a&&(x=new CorePlayer("remove-bg-player-container",{mode:"player",controlBarMode:"fixed",controls:{playPause:!0,navigation:!1,volume:!1,time:!0,progress:!0,captions:!1,settings:!1,fullscreen:!1,loop:!0,speed:!1,modeToggle:!1,keyboard:!1},autoplay:!1}));const w=(e,t,o)=>{if(!c.checked)return;if(0===k.length)return;const s=e.getImageData(0,0,t,o),n=Array.from(d).find(e=>e.checked).value,r=u.value;MediaProcessor.applyChromaKey(s,k,n,r),e.putImageData(s,0,0)};x&&x.addRenderCallback(w);try{await MediaMetadata.getProcessedSourceURL(e,()=>t._saveState()),await x.load(e.blob_url,!1),x.canvas&&setTimeout(()=>{try{const e=x.canvas.getContext("2d",{willReadFrequently:!0}),t=x.canvas.width,o=x.canvas.height,s=e.getImageData(0,0,t,o).data,n=(e,t,o)=>{let s=0,n=0,r=0,a=0;return[0,4*(t-1),t*(o-1)*4,4*(t*o-1)].forEach(t=>{t<e.length&&(s+=e[t],n+=e[t+1],r+=e[t+2],a++)}),0===a?null:{r:Math.round(s/a),g:Math.round(n/a),b:Math.round(r/a)}},r=n(s,t,o);r&&(console.log("[RemoveBackground] Auto-detected color:",r),C(r))}catch(e){console.warn("[RemoveBackground] Auto-detection failed:",e)}},100);(()=>(S||(S=document.createElement("img"),S.className="color-picker-overlay",S.style.cssText="\n                        position: absolute;\n                        top: 0;\n                        left: 0;\n                        width: 100%;\n                        height: 100%;\n                        object-fit: contain;\n                        z-index: 100;\n                        cursor: crosshair;\n                        display: none;\n                        background: #000;\n                    ",a.appendChild(S),S.addEventListener("click",e=>{if(!M)return;const t=document.createElement("canvas");t.width=x.canvas.width,t.height=x.canvas.height;const o=t.getContext("2d",{willReadFrequently:!0});o.drawImage(S,0,0,t.width,t.height);const s=S.getBoundingClientRect(),n=t.width/s.width,r=t.height/s.height,a=Math.floor((e.clientX-s.left)*n),i=Math.floor((e.clientY-s.top)*r),l=o.getImageData(a,i,1,1).data;0!==l[3]&&C({r:l[0],g:l[1],b:l[2]})})),S))()}catch(e){return console.error("Failed to load video:",e),b.textContent="Failed to load video: "+e.message,void b.classList.remove("hidden")}function C(e){k.some(t=>Math.abs(t.r-e.r)<5&&Math.abs(t.g-e.g)<5&&Math.abs(t.b-e.b)<5)||(k.push({...e,similarity:0,smoothness:.08,spill:.1}),q(),x.isPlaying||x.seek(x.currentTime))}function q(){if(i.innerHTML="",0===k.length)return void(i.innerHTML='\n                    <div class="empty-state text-xs text-muted text-center py-md">\n                        No colors selected.\n                    </div>\n                ');const e=document.getElementById("color-item-template");k.forEach((t,o)=>{const s=e.content.cloneNode(!0),n=s.querySelector(".color-swatch"),r=s.querySelector(".color-hex"),a=s.querySelector(".remove-color-btn"),l=s.querySelector(".similarity-slider"),c=s.querySelector(".similarity-value"),d=s.querySelector(".smoothness-slider"),u=s.querySelector(".smoothness-value"),m=s.querySelector(".spill-slider"),g=s.querySelector(".spill-value"),h=`rgb(${t.r}, ${t.g}, ${t.b})`;var p,y,v;n.style.backgroundColor=h,r.textContent=(p=t.r,y=t.g,v=t.b,"#"+((1<<24)+(p<<16)+(y<<8)+v).toString(16).slice(1).toUpperCase()),l.value=100*t.similarity,c.textContent=t.similarity.toFixed(2),d.value=100*t.smoothness,u.textContent=t.smoothness.toFixed(2),m.value=100*t.spill,g.textContent=t.spill.toFixed(2);const b=()=>{x.isPlaying||x.seek(x.currentTime)};l.oninput=()=>{t.similarity=parseInt(l.value)/100,c.textContent=t.similarity.toFixed(2),b()},d.oninput=()=>{t.smoothness=parseInt(d.value)/100,u.textContent=t.smoothness.toFixed(2),b()},m.oninput=()=>{t.spill=parseInt(m.value)/100,g.textContent=t.spill.toFixed(2),b()},a.onclick=()=>function(e){k.splice(e,1),q(),x.isPlaying||x.seek(x.currentTime)}(o),i.appendChild(s)})}l.onclick=()=>{M=!M,M?(l.classList.add("active"),l.innerHTML='\n                    <svg width="16" height="16" fill="currentColor">\n                        <use href="assets/icons/sprite.svg#icon-check"></use>\n                    </svg>\n                    Done\n                ',x.pause(),x.canvas&&S&&(S.src=x.canvas.toDataURL("image/png"),S.style.display="block")):(l.classList.remove("active"),l.innerHTML='\n                    <svg width="16" height="16" fill="currentColor">\n                        <use href="assets/icons/sprite.svg#icon-eyedropper"></use>\n                    </svg>\n                    Pick Color from Video\n                ',S&&(S.style.display="none"))},c.onchange=()=>{x.isPlaying||x.seek(x.currentTime)},d.forEach(e=>{e.onchange=()=>{const t="custom"===e.value;u.disabled=!t,x.isPlaying||x.seek(x.currentTime)},e.onclick=()=>{"custom"===e.value&&(u.disabled=!1,setTimeout(()=>u.click(),10))}}),u.onchange=()=>{x.isPlaying||x.seek(x.currentTime)};const L=n.close.bind(n);n.close=()=>{x&&x.destroy(),L()},m.onclick=async()=>{if(0===k.length)return b.textContent="Please select at least one color to remove.",void b.classList.remove("hidden");m.disabled=!0,g.classList.add("hidden"),h.classList.remove("hidden"),b.classList.add("hidden"),f.classList.add("hidden"),l.disabled=!0,c.disabled=!0,d.forEach(e=>e.disabled=!0),u.disabled=!0,x&&x.pause();try{const o=Array.from(d).find(e=>e.checked).value,s=u.value,n=await MediaProcessor.process({source:await MediaMetadata.getProcessedSourceURL(e),removeBackgroundOptions:{colors:k,bgType:o,bgColor:s},onProgress:e=>{const t=Math.round(100*e);p.style.width=`${t}%`,y.textContent=`${t}%`,v.textContent=e<.1?"Initializing...":e<.9?"Removing background...":"Finalizing..."}});f.classList.remove("hidden"),h.classList.add("hidden");(new Date).toISOString().replace(/[:.]/g,"-").slice(0,19);const r="transparent"===o?"webm":"mp4",a=`${e.title.replace(/\.[^.]+$/,"")}-nobg.${r}`,i=URL.createObjectURL(n);g.href=i,g.download=a,g.classList.remove("hidden"),g.onclick=e=>{e.stopPropagation()};const l={title:a,url:i,duration:null,thumbnail:e.thumbnail,isLocal:!0,file:new File([n],a,{type:`video/${r}`}),id:generateId(),type:`video/${r}`,path:(e.path||e.title)+"/"+a},c=t.items.indexOf(e);-1!==c?t.items.splice(c+1,0,l):t.items.push(l),await t._ensureMetadata(l),t._saveState(),t.render()}catch(e){console.error("Processing failed:",e),b.textContent=`Processing failed: ${e.message}`,b.classList.remove("hidden"),h.classList.add("hidden")}finally{m.disabled=!1,l.disabled=!1,c.disabled=!1,d.forEach(e=>e.disabled=!1),d[1].checked&&(u.disabled=!1)}}}}