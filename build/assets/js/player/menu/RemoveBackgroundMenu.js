import{Modal}from"../Modal.js";import{CorePlayer}from"../../core/Player.js";import{MediaMetadata}from"../../utils/MediaMetadata.js";import{MediaProcessor}from"../../core/MediaProcessor.js";import{generateId,formatDuration}from"../../utils/mediaUtils.js";export class RemoveBackgroundMenu{static async init(e,t){const o=document.getElementById("remove-bg-content-template"),s=document.getElementById("remove-bg-footer-template");if(!o||!s)return void console.error("Remove Background modal templates not found!");const r=new Modal({maxWidth:"900px"});r.setTitle("Remove Background"),r.setBody(o.content.cloneNode(!0)),r.setFooter(s.content.cloneNode(!0));const n=r.modal;r.open();const a=n.querySelector("#remove-bg-player-container"),i=n.querySelector(".selected-colors-list"),l=n.querySelector("#pick-color-btn"),c=n.querySelector("#live-preview-toggle"),d=n.querySelectorAll('input[name="bg-type"]'),u=n.querySelector("#custom-bg-color"),m=n.querySelector(".process-btn"),g=n.querySelector(".download-btn"),p=n.querySelector(".progress-section"),v=n.querySelector(".progress-bar-fill"),h=n.querySelector(".progress-percentage"),y=n.querySelector(".progress-status"),b=n.querySelector(".error-message"),f=n.querySelector(".success-message");let k=[],x=null,S=null,C=!1;a&&(S=new CorePlayer("remove-bg-player-container",{mode:"player",controlBarMode:"fixed",controls:{playPause:!0,volume:!1,time:!0,progress:!0,captions:!1,settings:!1,fullscreen:!1,loop:!0,speed:!1,modeToggle:!1},autoplay:!1}));const M=(e,t,o)=>{if(!c.checked)return;if(0===k.length)return;const s=e.getImageData(0,0,t,o),r=Array.from(d).find(e=>e.checked).value,n=u.value;MediaProcessor.applyChromaKey(s,k,r,n),e.putImageData(s,0,0)};S&&S.addRenderCallback(M);try{x=await MediaMetadata.getSourceBlob(e,()=>t._saveState());const o=URL.createObjectURL(x);await S.load(o,!1),S.canvas&&setTimeout(()=>{try{const e=S.canvas.getContext("2d",{willReadFrequently:!0}),t=S.canvas.width,o=S.canvas.height,s=e.getImageData(0,0,t,o).data,r=(e,t,o)=>{let s=0,r=0,n=0,a=0;return[0,4*(t-1),t*(o-1)*4,4*(t*o-1)].forEach(t=>{t<e.length&&(s+=e[t],r+=e[t+1],n+=e[t+2],a++)}),0===a?null:{r:Math.round(s/a),g:Math.round(r/a),b:Math.round(n/a)}},n=r(s,t,o);n&&(console.log("[RemoveBackground] Auto-detected color:",n),L(n))}catch(e){console.warn("[RemoveBackground] Auto-detection failed:",e)}},100),S.canvas&&(S.canvas.addEventListener("click",e=>{if(!C)return;e.stopImmediatePropagation(),e.preventDefault();const t=S.canvas.getBoundingClientRect(),o=S.canvas.width/t.width,s=S.canvas.height/t.height,r=(e.clientX-t.left)*o,n=(e.clientY-t.top)*s,a=S.canvas.getContext("2d",{willReadFrequently:!0}).getImageData(r,n,1,1).data;0!==a[3]&&(L({r:a[0],g:a[1],b:a[2]}),q(!1))},!0),S.canvas.addEventListener("mousemove",()=>{S.canvas.style.cursor=C?"crosshair":"pointer"}))}catch(e){return console.error("Failed to load video:",e),b.textContent="Failed to load video: "+e.message,void b.classList.remove("hidden")}function q(e){C=e,C?(l.classList.add("active"),l.innerHTML='\n                    <svg width="16" height="16" fill="currentColor" class="animate-pulse">\n                        <use href="assets/icons/sprite.svg#icon-eyedropper"></use>\n                    </svg>\n                    Picking... (Click Video)\n                ',S.pause(),S.canvas.style.cursor="crosshair"):(l.classList.remove("active"),l.innerHTML='\n                    <svg width="16" height="16" fill="currentColor">\n                        <use href="assets/icons/sprite.svg#icon-eyedropper"></use>\n                    </svg>\n                    Pick Color from Video\n                ',S.canvas.style.cursor="pointer")}function L(e){k.some(t=>Math.abs(t.r-e.r)<5&&Math.abs(t.g-e.g)<5&&Math.abs(t.b-e.b)<5)||(k.push({...e,similarity:0,smoothness:.08,spill:.1}),w(),S.isPlaying||S.seek(S.currentTime))}function w(){if(i.innerHTML="",0===k.length)return void(i.innerHTML='\n                    <div class="empty-state text-xs text-muted text-center py-md">\n                        No colors selected.\n                    </div>\n                ');const e=document.getElementById("color-item-template");k.forEach((t,o)=>{const s=e.content.cloneNode(!0),r=s.querySelector(".color-swatch"),n=s.querySelector(".color-hex"),a=s.querySelector(".remove-color-btn"),l=s.querySelector(".similarity-slider"),c=s.querySelector(".similarity-value"),d=s.querySelector(".smoothness-slider"),u=s.querySelector(".smoothness-value"),m=s.querySelector(".spill-slider"),g=s.querySelector(".spill-value"),p=`rgb(${t.r}, ${t.g}, ${t.b})`;var v,h,y;r.style.backgroundColor=p,n.textContent=(v=t.r,h=t.g,y=t.b,"#"+((1<<24)+(v<<16)+(h<<8)+y).toString(16).slice(1).toUpperCase()),l.value=100*t.similarity,c.textContent=t.similarity.toFixed(2),d.value=100*t.smoothness,u.textContent=t.smoothness.toFixed(2),m.value=100*t.spill,g.textContent=t.spill.toFixed(2);const b=()=>{S.isPlaying||S.seek(S.currentTime)};l.oninput=()=>{t.similarity=parseInt(l.value)/100,c.textContent=t.similarity.toFixed(2),b()},d.oninput=()=>{t.smoothness=parseInt(d.value)/100,u.textContent=t.smoothness.toFixed(2),b()},m.oninput=()=>{t.spill=parseInt(m.value)/100,g.textContent=t.spill.toFixed(2),b()},a.onclick=()=>function(e){k.splice(e,1),w(),S.isPlaying||S.seek(S.currentTime)}(o),i.appendChild(s)})}l.onclick=()=>{q(!C)},c.onchange=()=>{S.isPlaying||S.seek(S.currentTime)},d.forEach(e=>{e.onchange=()=>{const t="custom"===e.value;u.disabled=!t,S.isPlaying||S.seek(S.currentTime)},e.onclick=()=>{"custom"===e.value&&(u.disabled=!1,setTimeout(()=>u.click(),10))}}),u.onchange=()=>{S.isPlaying||S.seek(S.currentTime)};const P=r.close.bind(r);r.close=()=>{S&&S.destroy(),P()},m.onclick=async()=>{if(0===k.length)return b.textContent="Please select at least one color to remove.",void b.classList.remove("hidden");m.disabled=!0,g.classList.add("hidden"),p.classList.remove("hidden"),b.classList.add("hidden"),f.classList.add("hidden"),l.disabled=!0,c.disabled=!0,d.forEach(e=>e.disabled=!0),u.disabled=!0,S&&S.pause();try{const o=Array.from(d).find(e=>e.checked).value,s=u.value,r=await MediaProcessor.process({source:x,removeBackgroundOptions:{colors:k,bgType:o,bgColor:s},onProgress:e=>{const t=Math.round(100*e);v.style.width=`${t}%`,h.textContent=`${t}%`,y.textContent=e<.1?"Initializing...":e<.9?"Removing background...":"Finalizing..."}});f.classList.remove("hidden"),p.classList.add("hidden");(new Date).toISOString().replace(/[:.]/g,"-").slice(0,19);const n="transparent"===o?"webm":"mp4",a=`${e.title.replace(/\.[^.]+$/,"")}-nobg.${n}`,i=URL.createObjectURL(r);g.href=i,g.download=a,g.classList.remove("hidden"),g.onclick=e=>{e.stopPropagation()};const l={title:a,url:i,duration:null,thumbnail:e.thumbnail,isLocal:!0,file:new File([r],a,{type:`video/${n}`}),id:generateId(),type:`video/${n}`},c=t.items.indexOf(e);-1!==c?t.items.splice(c+1,0,l):t.items.push(l),await t._ensureMetadata(l),t._saveState(),t.render()}catch(e){console.error("Processing failed:",e),b.textContent=`Processing failed: ${e.message}`,b.classList.remove("hidden"),p.classList.add("hidden")}finally{m.disabled=!1,l.disabled=!1,c.disabled=!1,d.forEach(e=>e.disabled=!1),d[1].checked&&(u.disabled=!1)}}}}