import{Modal}from"../Modal.js";import{MediaProcessor}from"../../core/MediaProcessor.js";import{MediaMetadata}from"../../utils/MediaMetadata.js";import{generateId}from"../../utils/mediaUtils.js";export class ConvertMenu{static async init(e,t){const o=document.getElementById("conversion-content-template"),s=document.getElementById("conversion-footer-template");if(console.log("Opening Conversion Modal"),!o||!s)return void console.error("Conversion modal templates not found!");const n=new Modal({maxWidth:"500px"});n.setTitle("Convert & Optimize Video"),n.setBody(o.content.cloneNode(!0)),n.setFooter(s.content.cloneNode(!0));const a=n.modal,i=a.querySelector(".source-filename");i&&(i.textContent=e.title,i.title=e.title);const r=a.querySelector(".convert-btn"),l=a.querySelector(".download-btn"),d=a.querySelector(".progress-section"),c=a.querySelector(".progress-bar-fill"),u=a.querySelector(".progress-percentage"),p=a.querySelector(".success-message"),m=a.querySelector(".error-message"),v=a.querySelectorAll("input"),y=a.querySelector(".quality-slider"),h=a.querySelector(".quality-value"),f=a.querySelector(".estimated-reduction"),b=()=>{const e=parseInt(y.value);let t="Medium (60%)",o="~40% smaller";100===e?(t="Original (100%)",o="No size reduction"):80===e?(t="High (80%)",o="~20% smaller"):40===e&&(t="Low (40%)",o="~60% smaller"),h.textContent=t,f.textContent=o};y.addEventListener("input",b),b();const C=n.close.bind(n);n.close=()=>{r.disabled&&!l.classList.contains("hidden")||C()},r.addEventListener("click",async()=>{const o=a.querySelector('input[name="format"]:checked').value,s=a.querySelector('input[name="addToPlaylist"]').checked,i=parseInt(y.value);if("keep"===o&&100===i)return m.textContent="No changes selected. Please choose a different format or reduce quality.",void m.classList.remove("hidden");v.forEach(e=>e.disabled=!0),y.disabled=!0,r.disabled=!0,n.closeBtn.disabled=!0,d.classList.remove("hidden"),m.classList.add("hidden"),p.classList.add("hidden"),l.classList.add("hidden");try{await ConvertMenu._startConversion(e,o,i,s,t,e=>{const t=Math.round(100*e)+"%";c.style.width=t,u.textContent=t},l),p.classList.remove("hidden"),d.classList.add("hidden"),l.classList.remove("hidden");const a="keep"===o?e.title.split(".").pop():o;l.title=`Download ${a.toUpperCase()}`,l.setAttribute("aria-label",`Download ${a.toUpperCase()}`),v.forEach(e=>{e.parentElement.classList.contains("disabled")||(e.disabled=!1)}),y.disabled=!1,r.disabled=!1,n.closeBtn.disabled=!1}catch(e){console.error("Conversion failed:",e),m.textContent=`Operation failed: ${e.message}`,m.classList.remove("hidden"),d.classList.add("hidden"),v.forEach(e=>{e.parentElement.classList.contains("disabled")||(e.disabled=!1)}),y.disabled=!1,r.disabled=!1,n.closeBtn.disabled=!1}}),n.open()}static async _startConversion(e,t,o,s,n,a,i){const r=await MediaMetadata.getSourceBlob(e,()=>n._saveState());let l=t;if("keep"===t){l=e.title.split(".").pop().toLowerCase(),["mp4","webm","mov"].includes(l)||(console.warn(`Format ${l} not explicitly supported, defaulting to MP4.`),l="mp4")}try{const t=await MediaProcessor.process({source:r,format:l,quality:o,onProgress:a});ConvertMenu._handleConversionSuccess(t,e,l,s,n,i)}catch(e){throw console.error("Conversion failed:",e),e}}static _handleConversionSuccess(e,t,o,s,n,a){const i=t.title.replace(/\.[^/.]+$/,"")+`-converted.${o}`,r=URL.createObjectURL(e);if(a&&(a.href=r,a.download=i),s){const o={title:i,url:r,file:new File([e],i,{type:e.type}),duration:t.duration,type:"video",path:(t.path||t.title)+"/"+i,id:generateId()},s=n.items.indexOf(t);n.items.splice(s+1,0,o),n.render(),n._saveState()}}}