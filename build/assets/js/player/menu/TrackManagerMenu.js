import{Modal}from"../Modal.js";import{MediaProcessor}from"../../core/MediaProcessor.js";import{MediaMetadata}from"../../utils/MediaMetadata.js";import{generateId}from"../../utils/mediaUtils.js";import{SpeedDropdown}from"../../utils/SpeedDropdown.js";export class TrackManagerMenu{static async init(e,t){const a=document.getElementById("track-management-content-template");if(!a)return;const o=new Modal({maxWidth:"700px"});o.setTitle("Video & Audio Tracks"),o.setBody(a.content.cloneNode(!0));const r=o.modal;r.querySelector(".source-filename").textContent=`Source: ${e.title}`,o.open();try{await t._ensureMetadata(e),r.querySelector(".tracks-loading").classList.add("hidden"),r.querySelector(".tracks-content").classList.remove("hidden");const a={video:e.videoTracks||[],audio:e.audioTracks||[]};this.renderTracks(a,e,r,t)}catch(a){if(console.error("Failed to load tracks:",a),a.message&&a.message.includes("No source available")){o.close(),alert(`The file "${e.title}" is no longer available and will be removed from the playlist.\n\nThis can happen when the browser cache is cleared or the file was not properly saved.`);const a=t.items.indexOf(e);return void(-1!==a&&(t.items.splice(a,1),t.render(),t._saveState(),console.log(`[TrackManagerMenu] Removed unavailable item: ${e.title}`)))}r.querySelector(".tracks-loading").classList.add("hidden"),r.querySelector(".mb-modal-body").insertAdjacentHTML("beforeend",`<div class="p-md text-danger">Failed to load tracks: ${a.message}</div>`)}}static renderTracks(e,t,a,o){const r=a.querySelector(".video-track-list"),c=a.querySelector(".audio-track-list"),s=a.querySelector(".video-tracks-section .track-count"),i=a.querySelector(".audio-tracks-section .track-count"),d=a.querySelector(".video-tracks-section .no-tracks-message"),n=a.querySelector(".audio-tracks-section .no-tracks-message");s.textContent=e.video.length,i.textContent=e.audio.length,0===e.video.length&&d.classList.remove("hidden"),0===e.audio.length&&n.classList.remove("hidden");const l=document.getElementById("track-card-template"),u=(e,a,r)=>{e.forEach((e,c)=>{const s=l.content.cloneNode(!0).querySelector(".track-card");s.querySelector(".track-index").textContent=c+1,s.querySelector(".meta-codec").textContent=e.codecString||e.codec||"Unknown",s.querySelector(".meta-language").textContent=e.language||"und";let i="";i="video"===r?`${e.width}x${e.height}`:`${e.channels}ch, ${e.sampleRate}Hz`,s.querySelector(".meta-details").textContent=i;const d=s.querySelector(".download-track-btn"),n=s.querySelector(".add-to-playlist-btn"),u=s.querySelector(".progress-container"),m=s.querySelector("[data-speed-btn]"),p=s.querySelector("[data-speed-menu]"),h=SpeedDropdown.init({button:m,menu:p});let y="mp4";if("audio"===r){const t=(e.codec||"").toLowerCase();y=t.includes("mp3")?"mp3":t.includes("aac")||t.includes("mp4a")?"m4a":t.includes("pcm")||""===t?"wav":"m4a"}d.addEventListener("click",()=>{this.extractTrack(o.items.indexOf(t),c,r,y,!1,h.getCurrentSpeed(),u,d,n,h,o)}),n.addEventListener("click",()=>{const e=y,a=`${t.title.replace(/\.[^/.]+$/,"")}-${r}-track${c+1}.${e}`;o.items.some(e=>e.title===a)?alert(`Track "${a}" is already in the playlist.`):this.extractTrack(o.items.indexOf(t),c,r,y,!0,h.getCurrentSpeed(),u,d,n,h,o)}),a.appendChild(s)})};u(e.video,r,"video"),u(e.audio,c,"audio")}static async extractTrack(e,t,a,o,r,c,s,i,d,n,l){const u=l.items[e];i.classList.add("hidden"),d.classList.add("hidden"),s.classList.remove("hidden"),n.setDisabled(!0);try{const e=await MediaMetadata.getSourceBlob(u,()=>l._saveState()),s=await MediaProcessor.extractTrack({source:e,trackIndex:t,trackType:a,format:o,speed:c,onProgress:e=>{}});this.handleExtractionSuccess(s,u,a,t,o,r,l)}catch(e){console.error("Extraction failed:",e),alert(`Extraction failed: ${e.message}`)}finally{i.classList.remove("hidden"),d.classList.remove("hidden"),s.classList.add("hidden"),n.setDisabled(!1)}}static handleExtractionSuccess(e,t,a,o,r,c,s){const i=r,d=`${t.title.replace(/\.[^/.]+$/,"")}-${a}-track${o+1}.${i}`,n=URL.createObjectURL(e);if(c){const o={id:generateId(),title:d,url:n,file:new File([e],d,{type:e.type}),duration:t.duration,type:"video"===a?"video":"audio",isAudioOnly:"audio"===a},r=s.items.indexOf(t);s.items.splice(r+1,0,o),s.render(),setTimeout(()=>{const e=s.container.querySelector(`[data-index="${r+1}"]`);e&&e.scrollIntoView({behavior:"smooth",block:"nearest"})},100)}else{const e=document.createElement("a");e.href=n,e.download=d,document.body.appendChild(e),e.click(),document.body.removeChild(e)}}}