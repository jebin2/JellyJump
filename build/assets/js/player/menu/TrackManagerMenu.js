import{Modal}from"../Modal.js";import{MediaProcessor}from"../../core/MediaProcessor.js";import{MediaMetadata}from"../../utils/MediaMetadata.js";import{generateId}from"../../utils/mediaUtils.js";export class TrackManagerMenu{static async init(e,t){const a=document.getElementById("track-management-content-template");if(!a)return;const o=new Modal({maxWidth:"700px"});o.setTitle("Video & Audio Tracks"),o.setBody(a.content.cloneNode(!0));const c=o.modal;c.querySelector(".source-filename").textContent=`Source: ${e.title}`,o.open();try{await t._ensureMetadata(e),c.querySelector(".tracks-loading").classList.add("hidden"),c.querySelector(".tracks-content").classList.remove("hidden");const a={video:e.videoTracks||[],audio:e.audioTracks||[]};this.renderTracks(a,e,c,t)}catch(a){if(console.error("Failed to load tracks:",a),a.message&&a.message.includes("No source available")){o.close(),alert(`The file "${e.title}" is no longer available and will be removed from the playlist.\n\nThis can happen when the browser cache is cleared or the file was not properly saved.`);const a=t.items.indexOf(e);return void(-1!==a&&(t.items.splice(a,1),t.render(),t._saveState(),console.log(`[TrackManagerMenu] Removed unavailable item: ${e.title}`)))}c.querySelector(".tracks-loading").classList.add("hidden"),c.querySelector(".mb-modal-body").insertAdjacentHTML("beforeend",`<div class="p-md text-danger">Failed to load tracks: ${a.message}</div>`)}}static renderTracks(e,t,a,o){const c=a.querySelector(".video-track-list"),r=a.querySelector(".audio-track-list"),i=a.querySelector(".video-tracks-section .track-count"),s=a.querySelector(".audio-tracks-section .track-count"),n=a.querySelector(".video-tracks-section .no-tracks-message"),d=a.querySelector(".audio-tracks-section .no-tracks-message");i.textContent=e.video.length,s.textContent=e.audio.length,0===e.video.length&&n.classList.remove("hidden"),0===e.audio.length&&d.classList.remove("hidden");const l=document.getElementById("track-card-template"),u=(e,a,c)=>{e.forEach((e,r)=>{const i=l.content.cloneNode(!0).querySelector(".track-card");i.querySelector(".track-index").textContent=r+1,i.querySelector(".meta-codec").textContent=e.codecString||e.codec||"Unknown",i.querySelector(".meta-language").textContent=e.language||"und";let s="";s="video"===c?`${e.width}x${e.height}`:`${e.channels}ch, ${e.sampleRate}Hz`,i.querySelector(".meta-details").textContent=s;const n=i.querySelector(".download-track-btn"),d=i.querySelector(".add-to-playlist-btn"),u=i.querySelector(".progress-container");let m="mp4";if("audio"===c){const t=(e.codec||"").toLowerCase();m=t.includes("mp3")?"mp3":t.includes("aac")||t.includes("mp4a")?"aac":t.includes("pcm")||""===t?"wav":"m4a"}n.addEventListener("click",()=>{this.extractTrack(o.items.indexOf(t),r,c,m,!1,u,n,d,o)}),d.addEventListener("click",()=>{const e=m,a=`${t.title.replace(/\.[^/.]+$/,"")}-${c}-track${r+1}.${e}`;o.items.some(e=>e.title===a)?alert(`Track "${a}" is already in the playlist.`):this.extractTrack(o.items.indexOf(t),r,c,m,!0,u,n,d,o)}),a.appendChild(i)})};u(e.video,c,"video"),u(e.audio,r,"audio")}static async extractTrack(e,t,a,o,c,r,i,s,n){const d=n.items[e];i.classList.add("hidden"),s.classList.add("hidden"),r.classList.remove("hidden");try{const e=await MediaMetadata.getSourceBlob(d,()=>n._saveState()),r=await MediaProcessor.extractTrack({source:e,trackIndex:t,trackType:a,format:o,onProgress:e=>{}});this.handleExtractionSuccess(r,d,a,t,o,c,n)}catch(e){console.error("Extraction failed:",e),alert(`Extraction failed: ${e.message}`)}finally{i.classList.remove("hidden"),s.classList.remove("hidden"),r.classList.add("hidden")}}static handleExtractionSuccess(e,t,a,o,c,r,i){const s=c,n=`${t.title.replace(/\.[^/.]+$/,"")}-${a}-track${o+1}.${s}`,d=URL.createObjectURL(e);if(r){const o={id:generateId(),title:n,url:d,file:new File([e],n,{type:e.type}),duration:t.duration,type:"video"===a?"video":"audio",isAudioOnly:"audio"===a},c=i.items.indexOf(t);i.items.splice(c+1,0,o),i.render(),setTimeout(()=>{const e=i.container.querySelector(`[data-index="${c+1}"]`);e&&e.scrollIntoView({behavior:"smooth",block:"nearest"})},100)}else{const e=document.createElement("a");e.href=d,e.download=n,document.body.appendChild(e),e.click(),document.body.removeChild(e)}}}