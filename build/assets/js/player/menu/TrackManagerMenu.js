import{Modal}from"../Modal.js";import{MediaProcessor}from"../../core/MediaProcessor.js";import{MediaMetadata}from"../../utils/MediaMetadata.js";import{generateId}from"../../utils/mediaUtils.js";export class TrackManagerMenu{static async init(e,t){const a=document.getElementById("track-management-content-template");if(!a)return;const o=new Modal({maxWidth:"700px"});o.setTitle("Video & Audio Tracks"),o.setBody(a.content.cloneNode(!0));const c=o.modal;c.querySelector(".source-filename").textContent=`Source: ${e.title}`,o.open();try{const a=await MediaMetadata.getSourceBlob(e,()=>t._saveState()),o=await MediaProcessor.getTracks(a);c.querySelector(".tracks-loading").classList.add("hidden"),c.querySelector(".tracks-content").classList.remove("hidden"),this.renderTracks(o,e,c,t)}catch(e){console.error("Failed to load tracks:",e),c.querySelector(".tracks-loading").classList.add("hidden"),c.querySelector(".mb-modal-body").insertAdjacentHTML("beforeend",`<div class="p-md text-danger">Failed to load tracks: ${e.message}</div>`)}}static renderTracks(e,t,a,o){const c=a.querySelector(".video-track-list"),r=a.querySelector(".audio-track-list"),s=a.querySelector(".video-tracks-section .track-count"),i=a.querySelector(".audio-tracks-section .track-count"),d=a.querySelector(".video-tracks-section .no-tracks-message"),n=a.querySelector(".audio-tracks-section .no-tracks-message");s.textContent=e.video.length,i.textContent=e.audio.length,0===e.video.length&&d.classList.remove("hidden"),0===e.audio.length&&n.classList.remove("hidden");const l=document.getElementById("track-card-template"),u=(e,a,c)=>{e.forEach((e,r)=>{const s=l.content.cloneNode(!0).querySelector(".track-card");s.querySelector(".track-index").textContent=r+1,s.querySelector(".meta-codec").textContent=e.codecString||e.codec||"Unknown",s.querySelector(".meta-language").textContent=e.language||"und";let i="";i="video"===c?`${e.width}x${e.height}`:`${e.channels}ch, ${e.sampleRate}Hz`,s.querySelector(".meta-details").textContent=i;const d=s.querySelector(".download-track-btn"),n=s.querySelector(".add-to-playlist-btn"),u=s.querySelector(".progress-container");let m="mp4";if("audio"===c){const t=(e.codec||"").toLowerCase();m=t.includes("mp3")?"mp3":t.includes("aac")||t.includes("mp4a")?"aac":t.includes("pcm")||""===t?"wav":"m4a"}d.addEventListener("click",()=>{this.extractTrack(o.items.indexOf(t),r,c,m,!1,u,d,n,o)}),n.addEventListener("click",()=>{const e=m,a=`${t.title.replace(/\.[^/.]+$/,"")}-${c}-track${r+1}.${e}`;o.items.some(e=>e.title===a)?alert(`Track "${a}" is already in the playlist.`):this.extractTrack(o.items.indexOf(t),r,c,m,!0,u,d,n,o)}),a.appendChild(s)})};u(e.video,c,"video"),u(e.audio,r,"audio")}static async extractTrack(e,t,a,o,c,r,s,i,d){const n=d.items[e];s.classList.add("hidden"),i.classList.add("hidden"),r.classList.remove("hidden");try{const e=await MediaMetadata.getSourceBlob(n,()=>d._saveState()),r=await MediaProcessor.extractTrack({source:e,trackIndex:t,trackType:a,format:o,onProgress:e=>{}});this.handleExtractionSuccess(r,n,a,t,o,c,d)}catch(e){console.error("Extraction failed:",e),alert(`Extraction failed: ${e.message}`)}finally{s.classList.remove("hidden"),i.classList.remove("hidden"),r.classList.add("hidden")}}static handleExtractionSuccess(e,t,a,o,c,r,s){const i=c,d=`${t.title.replace(/\.[^/.]+$/,"")}-${a}-track${o+1}.${i}`,n=URL.createObjectURL(e);if(r){const o={id:generateId(),title:d,url:n,file:new File([e],d,{type:e.type}),duration:t.duration,type:"video"===a?"video":"audio",isAudioOnly:"audio"===a},c=s.items.indexOf(t);s.items.splice(c+1,0,o),s.render(),setTimeout(()=>{const e=s.container.querySelector(`[data-index="${c+1}"]`);e&&e.scrollIntoView({behavior:"smooth",block:"nearest"})},100)}else{const e=document.createElement("a");e.href=n,e.download=d,document.body.appendChild(e),e.click(),document.body.removeChild(e)}}}