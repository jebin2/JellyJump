import{IndexedDBService}from"./IndexedDBService.js";import{MediaBunny}from"../core/MediaBunny.js";import{MediaProcessor}from"../core/MediaProcessor.js";import{CorePlayer}from"../core/Player.js";import{Modal}from"./Modal.js";export class Playlist{constructor(e,t){this.container=e,this.player=t,this.items=[],this.activeIndex=-1,this.storage=new IndexedDBService,this.expandedFolders=new Set,this.storage=new IndexedDBService,this.saveTimeout=null,this.container.innerHTML="",setInterval(()=>{this.player&&this.player.isPlaying&&this._savePlaybackProgress()},1e3),this._createHeader(),this._createListContainer(),this._attachDragEvents(),window.addEventListener("beforeunload",()=>{this._saveState()}),this._initKeyboardShortcuts(),this._initPlayerNavigation(),this._initUrlUpload(),this._loadSavedPlaylist(),document.addEventListener("click",e=>{e.target.closest(".playlist-context-menu")||e.target.closest(".playlist-settings-btn")||this._closeAllMenus()}),document.addEventListener("keydown",e=>{"Escape"===e.key&&this._closeAllMenus()})}_initPlayerNavigation(){this.player?(this.player.setNavigationCallbacks(()=>this.playPrevious(),()=>this.playNext()),this.player.setPlayCallback(()=>{this.items.length>0&&this.selectItem(0)})):console.error("Playlist: Player instance is missing!")}_initKeyboardShortcuts(){document.addEventListener("keydown",e=>{if("INPUT"!==e.target.tagName&&"TEXTAREA"!==e.target.tagName&&(!e.shiftKey||"N"!==e.key&&"n"!==e.key||(e.preventDefault(),this.playNext()),!e.shiftKey||"P"!==e.key&&"p"!==e.key||(e.preventDefault(),this.playPrevious()),"Delete"!==e.key&&"Backspace"!==e.key||this.activeIndex>=0&&confirm("Remove current video from playlist?")&&this.removeItem(this.activeIndex),(e.ctrlKey||e.metaKey)&&("u"===e.key||"U"===e.key))){e.preventDefault();const t=document.getElementById("mb-file-input");t&&t.click()}})}_createHeader(){const e=document.getElementById("playlist-header-controls-template");if(!e)return void console.error("Playlist header template not found!");const t=e.content.cloneNode(!0),i=document.createElement("div");i.className="playlist-header",i.appendChild(t),this.container.parentNode.insertBefore(i,this.container);const o=document.querySelector(".playlist-section"),n=document.getElementById("sidebar-toggle-btn");o&&n?import("./SidebarToggle.js").then(({SidebarToggle:e})=>{new e(o,n)}).catch(e=>{console.error("Failed to load SidebarToggle:",e)}):console.warn("Sidebar toggle elements not found",{sidebarElement:o,toggleButton:n});const a=i.querySelector("#mb-add-files"),s=i.querySelector("#mb-add-folder"),r=i.querySelector("#mb-clear-playlist");a&&a.addEventListener("click",()=>{document.getElementById("mb-file-input").click()}),s&&s.addEventListener("click",()=>{document.getElementById("mb-folder-input").click()}),r&&r.addEventListener("click",()=>{this.clear()});const l=document.getElementById("mb-file-input"),d=document.getElementById("mb-folder-input");l&&l.addEventListener("change",e=>{this.handleFiles(e.target.files),e.target.value=""}),d&&d.addEventListener("change",e=>{this.handleFiles(e.target.files),e.target.value=""})}_createListContainer(){this.container.classList.add("playlist-items")}_initMobileDrawer(){const e=document.getElementById("playlist-toggle"),t=document.getElementById("playlist-overlay"),i=this.container.closest(".playlist-section");if(e&&t&&i){const o=()=>{window.innerWidth<=768?e.style.display="flex":(e.style.display="none",i.classList.remove("open"),t.classList.remove("visible"))};window.addEventListener("resize",o),o();const n=()=>{i.classList.contains("open")?(i.classList.remove("open"),t.classList.remove("visible"),e.setAttribute("aria-expanded","false")):(i.classList.add("open"),t.classList.add("visible"),e.setAttribute("aria-expanded","true"))};e.addEventListener("click",n),t.addEventListener("click",n)}}_initKeyboardShortcuts(){document.addEventListener("keydown",e=>{["INPUT","TEXTAREA","SELECT"].includes(document.activeElement.tagName)||(e.shiftKey&&"n"===e.key.toLowerCase()?(e.preventDefault(),this.playNext()):e.shiftKey&&"p"===e.key.toLowerCase()?(e.preventDefault(),this.playPrevious()):"Delete"===e.key||e.key)})}_setupPlayerNavigation(){this.player&&"function"==typeof this.player.setNavigationCallbacks&&(this.player.setNavigationCallbacks(()=>this.playPrevious(),()=>this.playNext()),this.player.onEnded=()=>this.playNext(),this._updatePlayerNavigationState())}_canGoPrevious(){return this.activeIndex>0&&this.items.length>0}_canGoNext(){return this.activeIndex>=0&&this.activeIndex<this.items.length-1}_updatePlayerNavigationState(){this.player&&"function"==typeof this.player.updateNavigationButtons&&this.player.updateNavigationButtons(this._canGoPrevious(),this._canGoNext())}playPrevious(){this.activeIndex>0&&this.selectItem(this.activeIndex-1)}async _loadSavedPlaylist(){try{const e=await this.storage.loadPlaylist();if(e.length>0){this.items=e,this.render();const t=await this.storage.loadPlaybackState();if(t){let e=-1;if(t.activeId&&(e=this.items.findIndex(e=>e.id===t.activeId)),-1===e&&"number"==typeof t.index&&(e=t.index),e>=0&&e<this.items.length){this.activeIndex=e;const t=this.items[this.activeIndex];t.needsReload||(await this.player.load(t.url,!1,t.id),this._updateUI(),this._updatePlayerNavigationState())}}}else this.render()}catch(e){console.error("Error loading playlist:",e),this.render()}}_saveState(){this.storage.savePlaylist(this.items);const e=this.items[this.activeIndex];this.storage.savePlaybackState({index:this.activeIndex,activeId:e?e.id:null,time:this.player.currentTime||0})}_savePlaybackProgress(){const e=this.items[this.activeIndex];if(e){const t=this.player.currentTime||0;this.storage.savePlaybackState({index:this.activeIndex,activeId:e.id,time:t});try{const i={videoIdentifier:e.id,timestamp:t,savedAt:(new Date).toISOString()};localStorage.setItem(`jellyjump-state-${e.id}`,JSON.stringify(i))}catch(e){console.warn("Failed to sync state to localStorage:",e)}}}_attachDragEvents(){const e=this.container.closest(".playlist-section");["dragenter","dragover","dragleave","drop"].forEach(t=>{e.addEventListener(t,e=>{e.preventDefault(),e.stopPropagation()},!1)}),["dragenter","dragover"].forEach(t=>{e.addEventListener(t,()=>{e.classList.add("drag-over")},!1)}),["dragleave","drop"].forEach(t=>{e.addEventListener(t,()=>{e.classList.remove("drag-over")},!1)}),e.addEventListener("drop",async e=>{const t=e.dataTransfer,i=t.items;if(i){const e=[],t=[];for(let o=0;o<i.length;o++){const n=i[o].webkitGetAsEntry?i[o].webkitGetAsEntry():null;n?t.push(this._scanEntry(n)):"file"===i[o].kind&&e.push(i[o].getAsFile())}const o=(await Promise.all(t)).flat(),n=[...e,...o];this.handleFiles(n)}else this.handleFiles(t.files)},!1)}_scanEntry(e){return new Promise(t=>{if(e.isFile)e.file(i=>{!i.webkitRelativePath&&e.fullPath&&Object.defineProperty(i,"webkitRelativePath",{value:e.fullPath.substring(1)}),t([i])});else if(e.isDirectory){e.createReader().readEntries(async e=>{const i=e.map(e=>this._scanEntry(e)),o=await Promise.all(i);t(o.flat())})}else t([])})}handleFiles(e){const t=Array.from(e).filter(e=>e.type.startsWith("video/"));if(0===t.length)return void alert("Please select valid video files.");const i=t.map(e=>{let t=e.webkitRelativePath||e.name;return t.includes("/")||(t=e.name),{title:e.name,url:URL.createObjectURL(e),duration:"Loading...",thumbnail:"",isLocal:!0,needsReload:!1,file:e,path:t,id:this._generateId()}});this.addItems(i),this._processMetadata(i),this.items.length===i.length&&this.selectItem(0)}async _processMetadata(e){for(const t of e)if(t.isLocal&&t.file){t.duration="Loading...",this._updateItemUI(t);try{const{videoInfo:e,audioInfo:i,duration:o}=await MediaProcessor.getMetadata(t.file);t.duration=this._formatDuration(o),t.videoInfo=e,t.audioInfo=i,this._updateItemUI(t),this._saveState()}catch(e){console.warn("Failed to load metadata for",t.title,e),t.duration="--:--",this._updateItemUI(t)}}}async _ensureMetadata(e){if(e.videoInfo||e.audioInfo)return;let t;if(e.file)t=e.file;else{if(!e.url)throw new Error("No source available for metadata");{const i=await fetch(e.url);t=await i.blob()}}const{videoInfo:i,audioInfo:o,duration:n}=await MediaProcessor.getMetadata(t);e.videoInfo=i,e.audioInfo=o,e.duration&&"--:--"!==e.duration&&"Loading..."!==e.duration||(e.duration=this._formatDuration(n)),this._saveState()}async _getVideoDuration(e){try{const t=e instanceof File?new MediaBunny.BlobSource(e):new MediaBunny.UrlSource(e),i=new MediaBunny.Input({source:t,formats:MediaBunny.ALL_FORMATS});return await i.computeDuration()}catch(e){return console.error("Error getting video duration:",e),0}}_formatDuration(e){if(!e||isNaN(e))return"--:--";return`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,"0")}`}_updateItemUI(e){const t=this.items.indexOf(e);if(-1===t)return;const i=this.container.querySelector(`.playlist-item[data-index="${t}"]`);if(i){const t=i.querySelector(".playlist-duration");t&&(t.textContent=e.duration)}}addItem(e){e.id||(e.id=this._generateId()),this.items.push(e),this._saveState(),this.render(),this._updatePlayerNavigationState()}addItems(e){e.forEach(e=>{e.id||(e.id=this._generateId())});const t=this.items.length;this.items=[...this.items,...e],this._saveState(),this.render(),this._updatePlayerNavigationState(),1===e.length&&this.selectItem(t)}removeItem(e){e<0||e>=this.items.length||(e===this.activeIndex?this.items.length>1?e<this.items.length-1?(this.selectItem(e+1),this.activeIndex--):this.selectItem(e-1):this.clear(!1):e<this.activeIndex&&this.activeIndex--,this.items.splice(e,1),this._saveState(),this.render(),this._updatePlayerNavigationState())}async clear(e=!0){(!e||e&&confirm("Are you sure you want to clear the playlist? This will reset the application state."))&&(this.player.reset(),this.items=[],this.activeIndex=-1,await this.storage.clear(),this.render(),this._updatePlayerNavigationState(),console.log("Application state reset successfully"))}playNext(){this.activeIndex<this.items.length-1?this.selectItem(this.activeIndex+1):"playlist"===this.player.loopMode?this.selectItem(0):console.log("Playlist ended")}async selectItem(e){if(e<0||e>=this.items.length)return;const t=this.items[e];t.needsReload?alert("This local file needs to be re-uploaded."):(this.activeIndex=e,await this.player.load(t.url,!0,t.id),this._updateUI(),this._saveState(),this._updatePlayerNavigationState(),this.player.play())}render(){if(this.container.innerHTML="",0===this.items.length){const e=document.getElementById("playlist-empty-template").content.cloneNode(!0);return void this.container.appendChild(e)}const e=this._buildTree(this.items);this.container.appendChild(this._renderTreeLevel(e)),this._updateUI()}_buildTree(e){const t={name:"root",children:{},items:[]};return e.forEach((e,i)=>{const o=(e.path||e.title||"Unknown").split("/");if(1===o.length)return void t.items.push({...e,originalIndex:i});let n=t;for(let e=0;e<o.length-1;e++){const t=o[e];n.children[t]||(n.children[t]={name:t,path:o.slice(0,e+1).join("/"),children:{},items:[]}),n=n.children[t]}n.items.push({...e,originalIndex:i})}),t}_renderTreeLevel(e){const t=document.createElement("div");return t.className="playlist-tree-level",Object.values(e.children).forEach(e=>{t.appendChild(this._createFolderElement(e))}),e.items.forEach(e=>{t.appendChild(this._createPlaylistItemElement(e))}),t}_createFolderElement(e){const t=document.createElement("div");t.className="playlist-folder";const i=this.expandedFolders.has(e.path),o=this._createFolderHeader(e,i),n=document.createElement("div");return n.className="playlist-children "+(i?"":"hidden"),n.appendChild(this._renderTreeLevel(e)),this._attachFolderEvents(o,n,e),t.appendChild(o),t.appendChild(n),t}_createFolderHeader(e,t){const i=document.getElementById("playlist-folder-header-template").content.cloneNode(!0),o=i.querySelector(".playlist-folder-header"),n=o.querySelector(".playlist-toggle"),a=o.querySelector(".folder-name"),s=o.querySelector(".folder-remove-btn");return t&&n.classList.add("expanded"),a.textContent=e.name,s.setAttribute("aria-label",`Remove folder ${e.name}`),i.firstElementChild}_attachFolderEvents(e,t,i){e.querySelector(".playlist-folder-info").addEventListener("click",o=>{o.stopPropagation();t.classList.contains("hidden")?(t.classList.remove("hidden"),e.querySelector(".playlist-toggle").classList.add("expanded"),this.expandedFolders.add(i.path)):(t.classList.add("hidden"),e.querySelector(".playlist-toggle").classList.remove("expanded"),this.expandedFolders.delete(i.path))}),e.querySelector(".folder-remove-btn").addEventListener("click",e=>{e.stopPropagation(),confirm(`Delete folder "${i.name}" and all its contents?`)&&this.removeFolder(i.path)})}_createPlaylistItemElement(e){const t=this._createItemHTML(e,e.originalIndex).querySelector(".playlist-item");return this._attachItemEvents(t),t}_attachItemEvents(e){e.addEventListener("click",t=>{if(t.target.closest(".playlist-remove-btn")||t.target.closest(".playlist-download-btn"))return;const i=parseInt(e.dataset.index);this.selectItem(i)});const t=e.querySelector(".playlist-download-btn");t&&t.addEventListener("click",t=>{t.stopPropagation();const i=parseInt(e.dataset.index);this._downloadItem(i)});const i=e.querySelector(".playlist-remove-btn");i&&i.addEventListener("click",t=>{t.stopPropagation();const i=parseInt(e.dataset.index);this.removeItem(i)});const o=e.querySelector(".playlist-settings-btn");o&&o.addEventListener("click",t=>{t.stopPropagation();const i=parseInt(e.dataset.index);this._toggleSettingsMenu(i,o)})}_updateUI(){if(this.container.querySelectorAll(".playlist-item").forEach(e=>e.classList.remove("active")),this.activeIndex>=0){const e=this.container.querySelector(`.playlist-item[data-index="${this.activeIndex}"]`);e&&(e.classList.add("active"),e.scrollIntoView({behavior:"smooth",block:"nearest"}))}}removeFolder(e){const t=this.activeIndex>=0&&this.activeIndex<this.items.length?this.items[this.activeIndex]:null,i=this.items.length;if(this.items=this.items.filter(t=>{const i=t.path||"";return i!==e&&!i.startsWith(e+"/")}),this.items.length!==i){if(t){const e=this.items.indexOf(t);-1===e?(this.activeIndex=-1,this.player&&this.player.reset()):this.activeIndex=e}else this.activeIndex=-1;this._saveState(),this.render()}}_sanitizeFilename(e){let t=e.replace(/[<>:"/\\|?*]/g,"_");return t.match(/\.\w+$/)||(t+=".mp4"),t}async _downloadItem(e){if(e<0||e>=this.items.length)return;const t=this.items[e],i=this.container.querySelector(`[data-index="${e}"] .playlist-download-btn`);try{let e=t.title||"video";t.file&&t.file.name&&(e=t.file.name),e=this._sanitizeFilename(e);let o=t.url,n=null;if(!t.url.startsWith("blob:")){if(i){const e=document.getElementById("loading-spinner-template").content.cloneNode(!0);i.innerHTML="",i.appendChild(e),i.style.opacity="1"}console.log(`Fetching remote file: ${t.url}`);const e=await fetch(t.url);if(!e.ok)throw new Error(`Failed to fetch file: ${e.statusText}`);const a=await e.blob();n=URL.createObjectURL(a),o=n,i.style.opacity=""}const a=document.getElementById("mb-download-link");if(a.href=o,a.download=e,a.click(),n&&setTimeout(()=>URL.revokeObjectURL(n),100),console.log(`Downloading: ${e}`),i){const e=document.getElementById("playlist-item-template"),t=e.content.cloneNode(!0).querySelector(".playlist-download-btn svg").cloneNode(!0);i.innerHTML="",i.appendChild(t)}}catch(e){if(console.error("Download failed:",e),alert(`Failed to download video: ${e.message}\n\nThis may be due to CORS restrictions on the remote server.`),i){const e=document.getElementById("playlist-item-template").content.cloneNode(!0).querySelector(".playlist-download-btn svg").cloneNode(!0);i.innerHTML="",i.appendChild(e)}}}_createItemHTML(e,t){const i=document.getElementById("playlist-item-template").content.cloneNode(!0),o=i.querySelector(".playlist-item"),n=o.querySelector(".playlist-thumbnail"),a=o.querySelector(".playlist-title"),s=o.querySelector(".playlist-duration");if(o.dataset.index=t,o.setAttribute("aria-label",`Play ${e.title||"Unknown Video"}`),e.needsReload&&o.classList.add("needs-reload"),e.error&&o.classList.add("error"),e.thumbnail)n.innerHTML=`<img src="${e.thumbnail}" alt="${e.title}" loading="lazy">`;else{const e=document.getElementById("video-placeholder-template").content.cloneNode(!0);n.appendChild(e)}const r=e.title||"Unknown Video";if(a.textContent=r,a.setAttribute("title",r),e.needsReload){const e=document.getElementById("missing-file-status-template").content.cloneNode(!0);a.appendChild(e)}return s.textContent=e.duration||"--:--",i}_initUrlUpload(){const e=document.getElementById("mb-add-url");e?e.addEventListener("click",()=>{this._openUrlModal()}):console.warn("URL Upload button not found")}_openUrlModal(){const e=document.getElementById("url-upload-content-template"),t=document.getElementById("url-upload-footer-template");if(!e||!t)return;const i=new Modal({maxWidth:"500px"});i.setTitle("Add Video from URL"),i.setBody(e.content.cloneNode(!0)),i.setFooter(t.content.cloneNode(!0));const o=i.modal,n=o.querySelector("#url-input"),a=o.querySelector(".mb-modal-add"),s=o.querySelector(".mb-modal-cancel"),r=o.querySelector(".mb-modal-error"),l=o.querySelector(".mb-modal-loading");i.open(),setTimeout(()=>n.focus(),100),n.addEventListener("input",()=>{const e=this._isValidUrl(n.value);a.disabled=!e,r.style.display="none"}),a.addEventListener("click",async()=>{const e=n.value.trim();if(e){n.disabled=!0,a.disabled=!0,s.disabled=!0,i.closeBtn.disabled=!0,l.style.display="flex",r.style.display="none";try{await this._handleUrlUpload(e),i.close()}catch(e){n.disabled=!1,a.disabled=!1,s.disabled=!1,i.closeBtn.disabled=!1,l.style.display="none",r.textContent=e.message,r.style.display="block"}}}),s.addEventListener("click",()=>i.close()),n.addEventListener("keydown",e=>{"Enter"!==e.key||a.disabled||a.click(),"Escape"===e.key&&i.close()})}_isValidUrl(e){try{const t=new URL(e);return"http:"===t.protocol||"https:"===t.protocol}catch(e){return!1}}async _handleUrlUpload(e){try{const t=await fetch(e);if(!t.ok)throw new Error(`Failed to fetch video: ${t.statusText}`);const i=await t.blob();if(!i.type.startsWith("video/"))throw new Error("The URL does not point to a valid video file.");const o=new File([i],e.split("/").pop()||"remote-video.mp4",{type:i.type});this.handleFiles([o])}catch(e){if(e.message.includes("Failed to fetch"))throw new Error("CORS Error: Cannot access this URL. The server must allow cross-origin requests.");throw e}}_generateId(){return"undefined"!=typeof crypto&&crypto.randomUUID?crypto.randomUUID():"id-"+Date.now()+"-"+Math.random().toString(36).substr(2,9)}_toggleSettingsMenu(e,t){const i=document.querySelector(".playlist-context-menu"),o=i&&i.dataset.index==e;this._closeAllMenus(),o||this._createSettingsMenu(e,t)}_createSettingsMenu(e,t){const i=document.getElementById("playlist-settings-menu-template");if(!i)return;const o=i.content.cloneNode(!0).querySelector(".playlist-context-menu");o.dataset.index=e;this.items[e];o.querySelectorAll(".playlist-menu-item").forEach(t=>{t.addEventListener("click",i=>{if(i.stopPropagation(),t.classList.contains("disabled"))return;const o=t.dataset.action;this._handleMenuAction(o,e),this._closeAllMenus()})}),document.body.appendChild(o),this._positionSettingsMenu(o,t),requestAnimationFrame(()=>{o.classList.add("visible")})}_positionSettingsMenu(e,t){const i=t.getBoundingClientRect(),o=e.getBoundingClientRect(),n=window.innerHeight;window.innerWidth;let a=i.bottom+5,s=i.right-o.width;a+o.height>n-10&&(a=i.top-o.height-5),s<10&&(s=i.left),e.style.top=`${a}px`,e.style.left=`${s}px`}_closeAllMenus(){document.querySelectorAll(".playlist-context-menu").forEach(e=>{e.classList.remove("visible"),setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},200)})}_handleMenuAction(e,t){const i=this.items[t];switch(console.log(`Menu Action: ${e} on item "${i.title}" (Index: ${t})`),e){case"convert":this._openConversionModal(t);break;case"download-manage":this._openTrackManager(t);break;case"trim":this._openTrimModal(t);break;case"resize":this._openResizeModal(t);break;case"info":this._openInfoModal(t);break;case"merge":this._openMergeModal(t);break;case"create-gif":this._openGifModal(t)}}async _openMergeModal(e){const t=document.getElementById("merge-modal-content-template"),i=document.getElementById("merge-modal-footer-template"),o=document.getElementById("merge-item-template");if(!t||!i||!o)return;const n=new Modal({maxWidth:"900px"});n.setTitle("Merge Videos"),n.setBody(t.content.cloneNode(!0)),n.setFooter(i.content.cloneNode(!0));const a=n.modal,s=a.querySelector(".available-list"),r=a.querySelector(".selected-list"),l=a.querySelector(".merge-btn"),d=a.querySelector(".selection-count"),c=a.querySelector(".empty-selection-state"),u=a.querySelector("#merge-width"),h=a.querySelector("#merge-height"),m=a.querySelector(".max-resolution-hint"),p=a.querySelector(".scale-select"),y=a.querySelector("#merge-bg-color");let f=[];const g=async()=>{if(0===f.length)return u.value="",h.value="",void(m.textContent="Select videos to detect resolution");m.textContent="Detecting resolution...";let e=0,t=0;for(const i of f){if(i.videoInfo)await this._ensureMetadata(i);else{i.duration;i.duration="Loading...",S(),await this._ensureMetadata(i),S()}i.videoInfo&&(e=Math.max(e,i.videoInfo.width),t=Math.max(t,i.videoInfo.height))}e>0&&t>0?(u.value=e,h.value=t,m.textContent=`Max detected: ${e}×${t}`):m.textContent="Could not detect resolution"},v=async()=>{d.textContent=`${f.length} selected`,f.length>=2?l.removeAttribute("disabled"):l.setAttribute("disabled","true"),f.length>0?c.classList.add("hidden"):c.classList.remove("hidden"),await g()},b=()=>{s.innerHTML="";const e=this.items.filter(e=>!e.type||e.type.startsWith("video/"));0!==e.length?e.forEach((e,t)=>{const i=o.content.cloneNode(!0).querySelector(".merge-item");i.querySelector(".drag-handle").remove(),i.querySelector(".remove-item-btn").remove();const n=i.querySelector(".item-title");n.textContent=e.title,n.title=e.title,i.querySelector(".item-dur").textContent=e.duration||"--:--";const a=f.includes(e);a&&(i.classList.add("bg-primary","text-white"),i.classList.remove("hover:bg-tertiary")),i.addEventListener("click",()=>{a?f=f.filter(t=>t!==e):f.push(e),b(),S(),v()}),s.appendChild(i)}):s.innerHTML='<div class="empty-state text-center p-md text-muted text-sm italic">No videos available</div>'},S=()=>{r.innerHTML="",0!==f.length?f.forEach((e,t)=>{if(!e)return void console.warn("Undefined item in selectedVideos at index",t);const i=o.content.cloneNode(!0).querySelector(".merge-item"),n=i.querySelector(".item-title");n.textContent=e.title,n.title=e.title,i.querySelector(".item-dur").textContent=e.duration||"--:--",i.querySelector(".remove-item-btn").addEventListener("click",t=>{t.stopPropagation(),f=f.filter(t=>t!==e),b(),S(),v()}),i.addEventListener("dragstart",e=>{e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",t),i.classList.add("opacity-50")}),i.addEventListener("dragend",()=>{i.classList.remove("opacity-50"),r.querySelectorAll(".merge-item").forEach(e=>e.classList.remove("border-primary"))}),i.addEventListener("dragover",e=>{e.preventDefault(),e.dataTransfer.dropEffect="move",i.classList.add("border-primary")}),i.addEventListener("dragleave",()=>{i.classList.remove("border-primary")}),i.addEventListener("drop",e=>{e.preventDefault();const i=parseInt(e.dataTransfer.getData("text/plain")),o=t;if(i!==o){const e=f[i];f.splice(i,1),f.splice(o,0,e),S()}}),r.appendChild(i)}):r.appendChild(c)};"number"==typeof e&&this.items[e]&&(f.push(this.items[e]),this.items[e+1]&&f.push(this.items[e+1])),n.open(),b(),S(),v(),l.addEventListener("click",async()=>{if(f.length<2)return;const e=parseInt(u.value),t=parseInt(h.value),i=p.value,o=y.value,n=a.querySelector('input[name="addToPlaylist"]').checked;if(!e||!t||e<128||t<128)return void alert("Please enter valid resolution dimensions (minimum 128×128)");a.querySelector(".options-group").classList.add("disabled"),u.disabled=!0,h.disabled=!0,p.disabled=!0,y.disabled=!0,l.disabled=!0,l.innerHTML='<span class="spinner-sm border-2 border-current border-t-transparent rounded-full w-4 h-4 animate-spin mr-xs"></span> Merging...';const s=a.querySelector(".merge-progress"),r=s.querySelector(".progress-bar-fill"),d=s.querySelector(".progress-percentage"),c=a.querySelector(".merge-error"),m=a.querySelector(".merge-success"),g=a.querySelector(".download-btn");s.classList.remove("hidden"),c.classList.add("hidden"),m.classList.add("hidden");try{const a=[];for(const e of f)if(e.file)a.push(e.file);else{if(!e.url)throw new Error(`Cannot access content for video: ${e.title}`);{const t=await fetch(e.url),i=await t.blob();a.push(i)}}const s=await MediaProcessor.merge({inputs:a,format:"mp4",resolution:{width:e,height:t},scaleMode:i,backgroundColor:o,onProgress:e=>{const t=Math.round(100*e);r.style.width=`${t}%`,d.textContent=`${t}%`}});m.classList.remove("hidden"),l.innerHTML="Merged";const c=URL.createObjectURL(s),u=`merged-${(new Date).toISOString().replace(/[:.]/g,"-")}.mp4`;if(g.href=c,g.download=u,g.classList.remove("hidden"),n){const e={title:u,url:c,duration:"...",thumbnail:"",isLocal:!0,file:new File([s],u,{type:"video/mp4"}),id:this._generateId()},t=this.items.indexOf(f[f.length-1]);-1!==t?this.items.splice(t+1,0,e):this.items.push(e),this._saveState(),this.render(),this._processMetadata([e])}}catch(e){console.error("Merge failed:",e),c.textContent=`Merge failed: ${e.message}`,c.classList.remove("hidden"),l.disabled=!1,l.innerHTML='<span class="mr-xs">Merge</span><svg width="16" height="16" fill="currentColor"><use href="assets/icons/sprite.svg#icon-layers"></use></svg>'}})}_openConversionModal(e){const t=this.items[e],i=document.getElementById("conversion-content-template"),o=document.getElementById("conversion-footer-template");if(console.log("Opening Conversion Modal",{index:e}),!i||!o)return void console.error("Conversion modal templates not found!");const n=new Modal({maxWidth:"500px"});n.setTitle("Convert & Optimize Video"),n.setBody(i.content.cloneNode(!0)),n.setFooter(o.content.cloneNode(!0));const a=n.modal,s=a.querySelector(".source-filename");s&&(s.textContent=t.title,s.title=t.title);const r=a.querySelector(".convert-btn"),l=a.querySelector(".download-btn"),d=a.querySelector(".progress-section"),c=a.querySelector(".progress-bar-fill"),u=a.querySelector(".progress-percentage"),h=a.querySelector(".success-message"),m=a.querySelector(".error-message"),p=a.querySelectorAll("input"),y=a.querySelector(".quality-slider"),f=a.querySelector(".quality-value"),g=a.querySelector(".estimated-reduction"),v=()=>{const e=parseInt(y.value);let t="Medium (60%)",i="~40% smaller";100===e?(t="Original (100%)",i="No size reduction"):80===e?(t="High (80%)",i="~20% smaller"):40===e&&(t="Low (40%)",i="~60% smaller"),f.textContent=t,g.textContent=i};y.addEventListener("input",v),v();const b=n.closeBtn.cloneNode(!0);n.closeBtn.parentNode.replaceChild(b,n.closeBtn),n.closeBtn=b,n.closeBtn.addEventListener("click",()=>{r.disabled&&!l.classList.contains("hidden")||n.close()});n.overlay.cloneNode(!0);const S=n.close.bind(n);n.close=()=>{r.disabled&&!l.classList.contains("hidden")||S()},r.addEventListener("click",async()=>{const i=a.querySelector('input[name="format"]:checked').value,o=a.querySelector('input[name="addToPlaylist"]').checked,s=parseInt(y.value);if("keep"===i&&100===s)return m.textContent="No changes selected. Please choose a different format or reduce quality.",void m.classList.remove("hidden");p.forEach(e=>e.disabled=!0),y.disabled=!0,r.disabled=!0,n.closeBtn.disabled=!0,d.classList.remove("hidden"),m.classList.add("hidden"),h.classList.add("hidden"),l.classList.add("hidden");try{await this._startConversion(e,i,s,o,e=>{const t=Math.round(100*e)+"%";c.style.width=t,u.textContent=t}),h.classList.remove("hidden"),d.classList.add("hidden"),l.classList.remove("hidden");const a="keep"===i?t.title.split(".").pop():i;l.title=`Download ${a.toUpperCase()}`,l.setAttribute("aria-label",`Download ${a.toUpperCase()}`),p.forEach(e=>{e.parentElement.classList.contains("disabled")||(e.disabled=!1)}),y.disabled=!1,r.disabled=!1,n.closeBtn.disabled=!1}catch(e){console.error("Conversion failed:",e),m.textContent=`Operation failed: ${e.message}`,m.classList.remove("hidden"),d.classList.add("hidden"),p.forEach(e=>{e.parentElement.classList.contains("disabled")||(e.disabled=!1)}),y.disabled=!1,r.disabled=!1,n.closeBtn.disabled=!1}}),n.open()}async _startConversion(e,t,i,o,n){const a=this.items[e];let s;if(a.file)s=a.file;else{const e=await fetch(a.url);s=await e.blob()}let r=t;if("keep"===t){r=a.title.split(".").pop().toLowerCase(),["mp4","webm","mov"].includes(r)||(console.warn(`Format ${r} not explicitly supported for writing, defaulting to MP4.`),r="mp4")}try{const e=await MediaProcessor.process({source:s,format:r,quality:i,onProgress:n});this._handleConversionSuccess(e,a,r,o)}catch(e){throw console.error("Conversion failed:",e),e}}_handleConversionSuccess(e,t,i,o){const n=t.title.replace(/\.[^/.]+$/,"")+`-converted.${i}`,a=URL.createObjectURL(e),s=document.querySelector(".conversion-modal .download-btn");if(s&&(s.href=a,s.download=n),o){const i={title:n,url:a,file:new File([e],n,{type:e.type}),duration:t.duration,type:"video"},o=this.items.indexOf(t);this.items.splice(o+1,0,i),this.render()}}async _openTrimModal(e){const t=this.items[e],i=document.getElementById("trim-content-template"),o=document.getElementById("trim-footer-template");if(!i||!o)return;const n=new Modal({maxWidth:"600px"});n.setTitle("Trim Video"),n.setBody(i.content.cloneNode(!0)),n.setFooter(o.content.cloneNode(!0));const a=n.modal;n.open();const s=a.querySelector("#trim-player-container");let r=null;s&&(r=new CorePlayer("trim-player-container",{mode:"player",controls:{playPause:!0,volume:!1,time:!0,progress:!0,captions:!1,settings:!1,fullscreen:!1,loop:!1,speed:!1,modeToggle:!1},autoplay:!1}));const l=a.querySelector(".trim-loading"),d=a.querySelector(".trim-content"),c=a.querySelector(".source-filename"),u=a.querySelector("#trim-start-input"),h=a.querySelector("#trim-end-input"),m=a.querySelector(".trim-duration"),p=a.querySelector(".total-duration"),y=a.querySelector(".timeline-slider"),f=a.querySelector(".timeline-range"),g=a.querySelector(".start-handle"),v=a.querySelector(".end-handle"),b=a.querySelector('input[name="addToPlaylist"]'),S=a.querySelector(".trim-btn"),w=a.querySelector(".download-btn"),L=a.querySelector(".progress-section"),x=a.querySelector(".progress-bar-fill"),I=a.querySelector(".progress-percentage"),E=a.querySelector(".error-message"),q=a.querySelector(".success-message");S.disabled=!0;const k=e=>{const t=Math.floor(e/3600),i=Math.floor(e%3600/60),o=Math.floor(e%60);return`${t.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`};c.textContent=t.title,c.title=t.title,await this._ensureMetadata(t);let C=0;if(t.duration&&"string"==typeof t.duration&&"--:--"!==t.duration){const e=t.duration.split(":").map(Number);3===e.length?C=3600*e[0]+60*e[1]+e[2]:2===e.length&&(C=60*e[0]+e[1])}l.classList.add("hidden"),d.classList.remove("hidden"),S.disabled=!1,p.textContent=k(C);let M=0,_=C;if(r){const e=t.url||URL.createObjectURL(t.file);await r.load(e,!1),r.loopMode="ab",r.loopStart=M,r.loopEnd=_}const $=()=>{document.activeElement!==u&&(u.value=k(M)),document.activeElement!==h&&(h.value=k(_));const e=Math.max(0,_-M);m.textContent=k(e);const t=M/C*100,i=_/C*100;g.style.left=`${t}%`,v.style.left=`${i}%`,f.style.left=`${t}%`,f.style.left=`${t}%`,f.style.width=i-t+"%",r&&(r.loopStart=M,r.loopEnd=_,"ab"!==r.loopMode&&(r.loopMode="ab"));const o=M<_&&_-M>=1;S.disabled=!o,o?E.classList.add("hidden"):(M>=_?E.textContent="Start time must be before end time.":_-M<1&&(E.textContent="Duration must be at least 1 second."),E.classList.remove("hidden"))};$();const T=(e,t)=>{const i=(e=>{if("number"==typeof e)return e;const t=e.split(":").map(Number);return 3===t.length?3600*t[0]+60*t[1]+t[2]:2===t.length?60*t[0]+t[1]:0})(e.value);t?i>=0&&i<C&&(M=i):i>0&&i<=C&&(_=i),$()};u.addEventListener("change",()=>T(u,!0)),h.addEventListener("change",()=>T(h,!1));const N=(e,t)=>{e.addEventListener("mousedown",e=>{e.preventDefault();const i=e=>((e,t)=>{const i=y.getBoundingClientRect(),o=e.clientX-i.left,n=Math.max(0,Math.min(1,o/i.width))*C;t?(n<_-1&&(M=n),r&&r.seek(M)):(n>M+1&&(_=n),r&&r.seek(_)),$()})(e,t),o=()=>{document.removeEventListener("mousemove",i),document.removeEventListener("mouseup",o)};document.addEventListener("mousemove",i),document.addEventListener("mouseup",o)})};N(g,!0),N(v,!1);const B=n.close.bind(n);n.close=()=>{r&&r.destroy(),B()},S.addEventListener("click",async()=>{a.classList.add("processing"),S.disabled=!0,n.closeBtn.disabled=!0,L.classList.remove("hidden"),E.classList.add("hidden"),q.classList.add("hidden");try{let e;if(t.file)e=t.file;else{const i=await fetch(t.url);e=await i.blob()}const i=await MediaProcessor.process({source:e,format:"mp4",quality:100,startTime:M,endTime:_,onProgress:e=>{const t=Math.round(100*e);x.style.width=`${t}%`,I.textContent=`${t}%`}});q.classList.remove("hidden");const o="mp4",a=t.title.replace(/\.[^/.]+$/,"")+`-trimmed-${Math.round(M)}-${Math.round(_)}.${o}`,s=URL.createObjectURL(i);if(w.href=s,w.download=a,w.classList.remove("hidden"),b.checked){const e={id:Date.now().toString(),title:a,url:s,file:new File([i],a,{type:`video/${o}`}),duration:k(_-M),type:"video",isLocal:!0,isNew:!0},n=this.items.indexOf(t)+1;this.items.splice(n,0,e),this.render()}n.closeBtn.disabled=!1}catch(e){console.error("Trimming failed:",e),E.textContent=`Trimming failed: ${e.message}`,E.classList.remove("hidden"),S.disabled=!1,n.closeBtn.disabled=!1,L.classList.add("hidden")}})}async _openTrackManager(e){const t=this.items[e],i=document.getElementById("track-management-content-template");if(!i)return;const o=new Modal({maxWidth:"700px"});o.setTitle("Video & Audio Tracks"),o.setBody(i.content.cloneNode(!0));const n=o.modal;n.querySelector(".source-filename").textContent=`Source: ${t.title}`,o.open();try{let e;if(t.file)e=t.file;else{const i=await fetch(t.url);e=await i.blob()}const i=await MediaProcessor.getTracks(e);n.querySelector(".tracks-loading").classList.add("hidden"),n.querySelector(".tracks-content").classList.remove("hidden"),this._renderTracks(i,t,n)}catch(e){console.error("Failed to load tracks:",e),n.querySelector(".tracks-loading").classList.add("hidden"),n.querySelector(".mb-modal-body").insertAdjacentHTML("beforeend",`<div class="p-md text-danger">Failed to load tracks: ${e.message}</div>`)}}_renderTracks(e,t,i){const o=i.querySelector(".video-track-list"),n=i.querySelector(".audio-track-list"),a=i.querySelector(".video-tracks-section .track-count"),s=i.querySelector(".audio-tracks-section .track-count"),r=i.querySelector(".video-tracks-section .no-tracks-message"),l=i.querySelector(".audio-tracks-section .no-tracks-message");a.textContent=e.video.length,s.textContent=e.audio.length,0===e.video.length&&r.classList.remove("hidden"),0===e.audio.length&&l.classList.remove("hidden");const d=document.getElementById("track-card-template"),c=(e,i,o)=>{e.forEach((e,n)=>{const a=d.content.cloneNode(!0).querySelector(".track-card");a.querySelector(".track-index").textContent=n+1,a.querySelector(".meta-codec").textContent=e.codecString||e.codec||"Unknown",a.querySelector(".meta-language").textContent=e.language||"und";let s="";s="video"===o?`${e.width}x${e.height}`:`${e.channels}ch, ${e.sampleRate}Hz`,a.querySelector(".meta-details").textContent=s;const r=a.querySelector(".download-track-btn"),l=a.querySelector(".add-to-playlist-btn"),c=a.querySelector(".progress-container");let u="mp4";if("audio"===o){const t=(e.codec||"").toLowerCase();u=t.includes("mp3")?"mp3":t.includes("aac")||t.includes("mp4a")?"aac":t.includes("pcm")||""===t?"wav":"m4a"}r.addEventListener("click",()=>{this._extractTrack(this.items.indexOf(t),n,o,u,!1,c,r,l)}),l.addEventListener("click",()=>{const e=u,i=`${t.title.replace(/\.[^/.]+$/,"")}-${o}-track${n+1}.${e}`;this.items.some(e=>e.title===i)?alert(`Track "${i}" is already in the playlist.`):this._extractTrack(this.items.indexOf(t),n,o,u,!0,c,r,l)}),i.appendChild(a)})};c(e.video,o,"video"),c(e.audio,n,"audio")}async _extractTrack(e,t,i,o,n,a,s,r){const l=this.items[e];s.classList.add("hidden"),r.classList.add("hidden"),a.classList.remove("hidden");try{let e;if(l.file)e=l.file;else{const t=await fetch(l.url);e=await t.blob()}const a=await MediaProcessor.extractTrack({source:e,trackIndex:t,trackType:i,format:o,onProgress:e=>{}});this._handleExtractionSuccess(a,l,i,t,o,n)}catch(e){console.error("Extraction failed:",e),alert(`Extraction failed: ${e.message}`)}finally{s.classList.remove("hidden"),r.classList.remove("hidden"),a.classList.add("hidden")}}_handleExtractionSuccess(e,t,i,o,n,a){const s=n,r=`${t.title.replace(/\.[^/.]+$/,"")}-${i}-track${o+1}.${s}`,l=URL.createObjectURL(e);if(a){const o={title:r,url:l,file:new File([e],r,{type:e.type}),duration:t.duration,type:"video"===i?"video":"audio",isAudioOnly:"audio"===i},n=this.items.indexOf(t);this.items.splice(n+1,0,o),this.render(),setTimeout(()=>{const e=this.container.querySelector(`[data-index="${n+1}"]`);e&&e.scrollIntoView({behavior:"smooth",block:"nearest"})},100)}else{const e=document.createElement("a");e.href=l,e.download=r,document.body.appendChild(e),e.click(),document.body.removeChild(e)}}async _openResizeModal(e){const t=this.items[e],i=document.getElementById("resize-content-template"),o=document.getElementById("resize-footer-template");if(!i||!o)return;const n=new Modal({maxWidth:"550px"});n.setTitle("Resize Video"),n.setBody(i.content.cloneNode(!0)),n.setFooter(o.content.cloneNode(!0));const a=n.modal,s=a.querySelector(".current-resolution"),r=a.querySelector(".current-aspect-ratio"),l=a.querySelector("#resize-width"),d=a.querySelector("#resize-height"),c=a.querySelector(".aspect-lock-btn"),u=a.querySelectorAll(".preset-btn"),h=a.querySelector('input[name="addToPlaylist"]'),m=a.querySelector(".resize-btn"),p=a.querySelector(".download-btn"),y=a.querySelector(".resize-progress"),f=a.querySelector(".progress-bar-fill"),g=a.querySelector(".progress-percentage"),v=a.querySelector(".status-text"),b=a.querySelector(".resize-error"),S=a.querySelector(".resize-success");n.open();let w=0,L=0,x=0,I=!0;const E=(e,t,i)=>{"width"!==i&&(l.value=Math.round(e)),"height"!==i&&(d.value=Math.round(t))};try{if(await this._ensureMetadata(t),!(t.videoInfo&&t.videoInfo.width&&t.videoInfo.height))throw new Error("No video metadata available");w=t.videoInfo.width,L=t.videoInfo.height,x=w/L,s.textContent=`${w}x${L}`,r.textContent=((e,t)=>{const i=(e,t)=>t?i(t,e%t):e,o=i(e,t);return`${e/o}:${t/o}`})(w,L),E(w,L)}catch(e){console.error("Failed to load video info:",e),s.textContent="Unknown",b.textContent="Failed to load video info. Resizing may not work.",b.classList.remove("hidden")}c.addEventListener("click",()=>{if(I=!I,c.setAttribute("aria-pressed",I),c.classList.toggle("jellyjump-btn-primary",I),c.classList.toggle("jellyjump-btn-secondary",!I),I){const e=parseInt(l.value)||w;E(e,e/x,"width")}}),l.addEventListener("input",()=>{const e=parseInt(l.value);I&&e&&x&&E(e,e/x,"width")}),d.addEventListener("input",()=>{const e=parseInt(d.value);I&&e&&x&&E(e*x,e,"height")}),u.forEach(e=>{e.addEventListener("click",()=>{let t;switch(e.dataset.preset){case"1080p":t=1080;break;case"720p":t=720;break;case"480p":t=480;break;case"360p":t=360}t&&(E(t*x,t),u.forEach(e=>e.classList.remove("jellyjump-btn-primary")),u.forEach(e=>e.classList.add("jellyjump-btn-secondary")),e.classList.remove("jellyjump-btn-secondary"),e.classList.add("jellyjump-btn-primary"))})}),m.addEventListener("click",async()=>{const e=parseInt(l.value),i=parseInt(d.value);if(!e||!i||e<128||i<128)return b.textContent="Dimensions must be at least 128px.",void b.classList.remove("hidden");if(e%2!=0||i%2!=0)return b.textContent="Dimensions must be even numbers.",void b.classList.remove("hidden");b.classList.add("hidden"),y.classList.remove("hidden"),m.disabled=!0,n.closeBtn.disabled=!0,v.textContent=`Resizing to ${e}x${i}...`;try{let o;if(t.file)o=t.file;else{const e=await fetch(t.url);o=await e.blob()}const a=await MediaProcessor.process({source:o,format:"mp4",quality:100,resize:{width:e,height:i},onProgress:e=>{const t=Math.round(100*e);f.style.width=`${t}%`,g.textContent=`${t}%`}});S.classList.remove("hidden"),y.classList.add("hidden");const s="mp4",r=t.title.replace(/\.[^/.]+$/,"")+`-${e}x${i}.${s}`,l=URL.createObjectURL(a);if(p.href=l,p.download=r,p.classList.remove("hidden"),m.disabled=!1,m.classList.remove("hidden"),v.textContent="Resizing video...",f.style.width="0%",g.textContent="0%",h.checked){const e={id:Date.now().toString(),title:r,url:l,file:new File([a],r,{type:`video/${s}`}),duration:t.duration,type:"video",isLocal:!0,isNew:!0},i=this.items.indexOf(t)+1;this.items.splice(i,0,e),this.render()}n.closeBtn.disabled=!1}catch(e){console.error("Resize failed:",e),b.textContent=`Resize failed: ${e.message}`,b.classList.remove("hidden"),y.classList.add("hidden"),m.disabled=!1,n.closeBtn.disabled=!1}})}async _openGifModal(e){const t=this.items[e],i=document.getElementById("gif-content-template"),o=document.getElementById("gif-footer-template");if(!i||!o)return void console.error("GIF modal templates not found!");const n=new Modal({maxWidth:"600px"});n.setTitle("Create GIF"),n.setBody(i.content.cloneNode(!0)),n.setFooter(o.content.cloneNode(!0));const a=n.modal;n.open();const s=a.querySelector("#gif-player-container");let r=null;s&&(r=new CorePlayer("gif-player-container",{mode:"player",controls:{playPause:!0,volume:!1,time:!0,progress:!0,captions:!1,settings:!1,fullscreen:!1,loop:!1,speed:!1,modeToggle:!1},autoplay:!1}));const l=a.querySelector(".gif-loading"),d=a.querySelector(".gif-content"),c=a.querySelector(".source-filename"),u=a.querySelector(".source-duration"),h=a.querySelector(".source-resolution");c.textContent=t.title,c.title=t.title,await this._ensureMetadata(t),l.classList.add("hidden"),d.classList.remove("hidden");let m=0;if(t.duration&&"string"==typeof t.duration&&"--:--"!==t.duration){const e=t.duration.split(":").map(Number);2===e.length?m=60*e[0]+e[1]:3===e.length&&(m=3600*e[0]+60*e[1]+e[2])}if(u.textContent=this._formatDuration(m),h.textContent=t.videoInfo?`${t.videoInfo.width}×${t.videoInfo.height}`:"Unknown",r){const e=t.url||URL.createObjectURL(t.file);await r.load(e,!1),r.loopMode="ab",r.loopStart=0,r.loopEnd=Math.min(m,10)}const p=a.querySelector("#gif-start-input"),y=a.querySelector("#gif-end-input"),f=a.querySelector(".gif-duration"),g=a.querySelector(".time-validation-error"),v=a.querySelector("#gif-fps"),b=a.querySelector("#gif-size"),S=a.querySelector("#gif-quality"),w=a.querySelector("#gif-quality-value"),L=a.querySelector(".create-gif-btn"),x=a.querySelector(".download-btn"),I=a.querySelector(".progress-section"),E=a.querySelector(".progress-bar-fill"),q=a.querySelector(".progress-percentage"),k=a.querySelector(".gif-preview-section"),C=a.querySelector(".gif-preview-image"),M=a.querySelector(".gif-file-size"),_=a.querySelector(".error-message"),$=a.querySelector(".success-message");y.value=this._formatTime(Math.min(m,10));const T=()=>{const e=this._parseTime(p.value),t=this._parseTime(y.value),i=t-e;return r&&(r.loopStart=e,r.loopEnd=t),g.classList.add("hidden"),L.disabled=!1,e>=t?(g.textContent="Start time must be before end time",g.classList.remove("hidden"),L.disabled=!0,!1):i<.5?(g.textContent="GIF duration must be at least 0.5 seconds",g.classList.remove("hidden"),L.disabled=!0,!1):i>60?(g.textContent="GIF duration must not exceed 60 seconds",g.classList.remove("hidden"),L.disabled=!0,!1):t>m?(g.textContent="End time exceeds video duration",g.classList.remove("hidden"),L.disabled=!0,!1):(f.textContent=`${i.toFixed(1)}s`,!0)};p.addEventListener("input",T),y.addEventListener("input",T),S.addEventListener("input",()=>{const e=parseInt(S.value);w.textContent={40:"Low",60:"Medium",80:"High",100:"Original"}[e]||"Medium"}),L.addEventListener("click",async()=>{if(!T())return;const e=this._parseTime(p.value),i=this._parseTime(y.value),o=parseInt(v.value),n=b.value,s=parseInt(S.value),r=a.querySelector('input[name="addToPlaylist"]').checked;p.disabled=!0,y.disabled=!0,v.disabled=!0,b.disabled=!0,S.disabled=!0,L.disabled=!0,I.classList.remove("hidden"),_.classList.add("hidden"),$.classList.add("hidden");try{let a,l,d;if("original"===n)a=t.videoInfo.width,l=t.videoInfo.height;else{l={720:720,480:480,360:360}[n],a=Math.round(t.videoInfo.width/t.videoInfo.height*l)}if(t.file)d=t.file;else{if(!t.url)throw new Error("Cannot access video file");{const e=await fetch(t.url),i=await e.blob();d=new File([i],t.title,{type:i.type})}}const c=await MediaProcessor.createGif({input:d,startTime:e,duration:i-e,fps:o,width:a,height:l,quality:s,onProgress:e=>{const t=Math.round(100*e);E.style.width=`${t}%`,q.textContent=`${t}%`}});$.classList.remove("hidden");const u=URL.createObjectURL(c);C.src=u,M.textContent=this._formatFileSize(c.size),k.classList.remove("hidden");const h=Math.round(e).toString().padStart(2,"0")+"-"+Math.round(i).toString().padStart(2,"0"),m=`${t.title.replace(/\.[^.]+$/,"")}-${h}.gif`;if(x.href=u,x.download=m,x.classList.remove("hidden"),r){const o={title:m,url:u,duration:this._formatDuration(i-e),thumbnail:u,isLocal:!0,file:new File([c],m,{type:"image/gif"}),id:this._generateId(),type:"image/gif"},n=this.items.indexOf(t);-1!==n?this.items.splice(n+1,0,o):this.items.push(o),this._saveState(),this.render()}p.disabled=!1,y.disabled=!1,v.disabled=!1,b.disabled=!1,S.disabled=!1,L.disabled=!1}catch(e){console.error("GIF creation failed:",e),_.textContent=`GIF creation failed: ${e.message}`,_.classList.remove("hidden"),p.disabled=!1,y.disabled=!1,v.disabled=!1,b.disabled=!1,S.disabled=!1,L.disabled=!1}});const N=n.close.bind(n);n.close=()=>{r&&r.destroy(),N()},T()}async _openInfoModal(e){const t=this.items[e],i=document.getElementById("info-content-template"),o=document.getElementById("info-footer-template");if(!i)return;const n=new Modal({maxWidth:"600px"});n.setTitle("Video Information"),n.setBody(i.content.cloneNode(!0)),o&&n.setFooter(o.content.cloneNode(!0));const a=n.modal,s=a.querySelector(".info-loading"),r=a.querySelector(".info-modal-content"),l=a.querySelectorAll(".copy-btn"),d=a.querySelector(".copy-all-btn");n.open();try{await this._ensureMetadata(t);let e=null;const i=(e,t=1)=>{if(0===e)return"0 Bytes";const i=t<0?0:t,o=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,o)).toFixed(i))+" "+["Bytes","KB","MB","GB","TB"][o]};let o="0 Bytes";if(t.file)o=i(t.file.size);else if(t.url)try{const e=(await fetch(t.url,{method:"HEAD"})).headers.get("content-length");e&&(o=i(parseInt(e)))}catch(e){o="Unknown"}const l={filename:t.title,format:t.file?t.file.type.split("/")[0]:"Unknown",mimeType:t.file?t.file.type:"Unknown",size:o,duration:t.duration||"Unknown",videoCodec:t.videoInfo?t.videoInfo.codec.toUpperCase():"N/A",videoCodecString:t.videoInfo?t.videoInfo.codec:"N/A",resolution:t.videoInfo?`${t.videoInfo.width}x${t.videoInfo.height}`:"N/A",codedResolution:t.videoInfo?`${t.videoInfo.codedWidth}x${t.videoInfo.codedHeight}`:"N/A",fps:"Calculating...",videoBitrate:"Calculating...",rotation:t.videoInfo?`${t.videoInfo.rotation}°`:"N/A",hdr:t.videoInfo?t.videoInfo.hasHDR?"Yes":"No":"N/A",audioCodec:t.audioInfo?t.audioInfo.codec.toUpperCase():"N/A",audioCodecString:t.audioInfo?t.audioInfo.codec:"N/A",channels:t.audioInfo?2===t.audioInfo.channels?"Stereo (2)":`${t.audioInfo.channels} Channels`:"N/A",sampleRate:t.audioInfo?`${(t.audioInfo.sampleRate/1e3).toFixed(1)} kHz`:"N/A",language:t.audioInfo?"und"===t.audioInfo.languageCode?"Undetermined":t.audioInfo.languageCode:"N/A"};if(t.videoInfo&&t.file)try{const i=await MediaProcessor.getTracks(t.file);e=i.video?i.video[0]:null}catch(e){console.warn("Could not get video track for packet stats:",e)}s.classList.add("hidden"),r.classList.remove("hidden"),Object.keys(l).forEach(e=>{const t=a.querySelector(`[data-key="${e}"]`);if(t){t.textContent=l[e];const i=t.parentElement.querySelector(".copy-btn");i&&(i.dataset.value=l[e])}}),n.body.dataset.rawInfo=JSON.stringify(l),e&&e.computePacketStats(50).then(e=>{const t=a.querySelector('.info-value[data-key="fps"]'),i=a.querySelector('.info-value[data-key="videoBitrate"]'),o=JSON.parse(n.body.dataset.rawInfo||"{}");if(t){const i=`${Math.round(e.averagePacketRate)} fps`;t.textContent=i;const n=t.parentElement.querySelector(".copy-btn");n&&(n.dataset.value=i),o.fps=i}if(i){const t=`${(e.averageBitrate/1e6).toFixed(1)} Mbps`;i.textContent=t;const n=i.parentElement.querySelector(".copy-btn");n&&(n.dataset.value=t),o.videoBitrate=t}n.body.dataset.rawInfo=JSON.stringify(o)}).catch(console.error)}catch(e){console.error("Failed to load video info:",e),s&&s.classList.add("hidden"),r&&r.classList.remove("hidden")}l.forEach(e=>{e.addEventListener("click",async()=>{const t=e.dataset.value;if(t)try{await navigator.clipboard.writeText(t),this._showToast("Copied to clipboard!")}catch(e){console.error("Failed to copy:",e)}})}),d&&d.addEventListener("click",async()=>{try{const e=JSON.parse(n.body.dataset.rawInfo||"{}"),t=`Video Information\n-----------------\nFilename: ${e.filename}\nFormat: ${e.format}\nMIME Type: ${e.mimeType}\nSize: ${e.size}\nDuration: ${e.duration}\n\nVideo Stream\n------------\nCodec: ${e.videoCodec} (${e.videoCodecString})\nResolution: ${e.resolution} (Coded: ${e.codedResolution})\nFrame Rate: ${e.fps}\nBitrate: ${e.videoBitrate}\nRotation: ${e.rotation}\nHDR: ${e.hdr}\n\nAudio Stream\n------------\nCodec: ${e.audioCodec} (${e.audioCodecString})\nChannels: ${e.channels}\nSample Rate: ${e.sampleRate}\nLanguage: ${e.language}\n`;await navigator.clipboard.writeText(t),this._showToast("All info copied to clipboard!")}catch(e){console.error("Failed to copy all:",e)}})}async _getFormattedMetadata(e,t){const i=new MediaBunny.Input({source:new MediaBunny.BlobSource(e),formats:MediaBunny.ALL_FORMATS}),o=await i.getFormat(),n=(await i.getTracks(),await i.getPrimaryVideoTrack()),a=await i.getPrimaryAudioTrack(),s=e=>e?e.toUpperCase():"N/A";var r;return{metadata:{filename:t,format:o?o.name:"Unknown",mimeType:o?o.mimeType:e.type,size:((e,t=1)=>{if(0===e)return"0 Bytes";const i=t<0?0:t,o=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,o)).toFixed(i))+" "+["Bytes","KB","MB","GB","TB"][o]})(e.size),duration:(r=n?await n.computeDuration():a?await a.computeDuration():0,[Math.floor(r/3600),Math.floor(r%3600/60),Math.floor(r%60)].map(e=>e<10?"0"+e:e).filter((e,t)=>"00"!==e||t>0).join(":")),videoCodec:n?s(n.codec):"N/A",videoCodecString:n?await n.getCodecParameterString():"N/A",resolution:n?`${n.displayWidth}x${n.displayHeight}`:"N/A",codedResolution:n?`${n.codedWidth}x${n.codedHeight}`:"N/A",fps:"Calculating...",videoBitrate:"Calculating...",rotation:n?`${n.rotation}°`:"N/A",hdr:n?await n.hasHighDynamicRange()?"Yes":"No":"N/A",audioCodec:a?s(a.codec):"N/A",audioCodecString:a?await a.getCodecParameterString():"N/A",channels:a?2===a.numberOfChannels?"Stereo (2)":`${a.numberOfChannels} Channels`:"N/A",sampleRate:a?`${(a.sampleRate/1e3).toFixed(1)} kHz`:"N/A",language:a?"und"===a.languageCode?"Undetermined":a.languageCode:"N/A"},videoTrack:n}}_showToast(e){const t=document.createElement("div");t.textContent=e,t.style.cssText="\n            position: fixed;\n            bottom: 20px;\n            left: 50%;\n            transform: translateX(-50%);\n            background: var(--accent-primary);\n            color: #000;\n            padding: 10px 20px;\n            border-radius: 4px;\n            font-weight: bold;\n            z-index: 3000;\n            opacity: 0;\n            transition: opacity 0.3s;\n        ",document.body.appendChild(t),requestAnimationFrame(()=>t.style.opacity="1"),setTimeout(()=>{t.style.opacity="0",setTimeout(()=>document.body.removeChild(t),300)},2e3)}_parseTime(e){const t=e.split(":").map(e=>parseFloat(e)||0);return 3===t.length?3600*t[0]+60*t[1]+t[2]:2===t.length?60*t[0]+t[1]:t[0]||0}_formatTime(e){const t=Math.floor(e/3600),i=Math.floor(e%3600/60),o=Math.floor(e%60);return`${t.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`}_formatFileSize(e){const t=["B","KB","MB","GB"];let i=e,o=0;for(;i>=1024&&o<t.length-1;)i/=1024,o++;return`${i.toFixed(1)} ${t[o]}`}}