import{IndexedDBService}from"./IndexedDBService.js";import{MediaBunny}from"../core/MediaBunny.js";import{MediaProcessor}from"../core/MediaProcessor.js";import{CorePlayer}from"../core/Player.js";import{Modal as ConfirmModal}from"../utils/Modal.js";import{Modal as DialogModal}from"./Modal.js";import{MenuRouter}from"./menu/MenuRouter.js";import{RecordMenu}from"./menu/RecordMenu.js";import{PlaylistStorage}from"./PlaylistStorage.js";import{MediaMetadata}from"../utils/MediaMetadata.js";import{FileDropHandler}from"../utils/FileDropHandler.js";import{ElectronHelper}from"../utils/ElectronHelper.js";import{formatTime,parseTime,formatDuration,formatFileSize,generateId}from"../utils/mediaUtils.js";import{M3UParser}from"../utils/M3UParser.js";const LAZY_FOLDER_THRESHOLD=50;export class Playlist{constructor(e,t){this.container=e,this.player=t,this.items=[],this.activeIndex=-1,this.storage=new IndexedDBService,this.expandedFolders=new Set,this.searchQuery="",this.storage=new IndexedDBService,this.saveTimeout=null,this.container.innerHTML="",setInterval(()=>{this.player&&this.player.isPlaying&&this._savePlaybackProgress()},1e3),this._createHeader(),this._createListContainer(),this.fileDropHandler=new FileDropHandler(this.container,e=>this.handleFiles(e)),window.addEventListener("beforeunload",()=>{console.log("[Playlist] beforeunload - saving state"),this._saveState(),console.log("[Playlist] beforeunload - revoking blob URLs");for(const e of this.items)e.url&&e.url.startsWith("blob:")&&(URL.revokeObjectURL(e.url),e.url=null)}),this._initKeyboardShortcuts(),this._initPlayerNavigation(),this._initUrlUpload(),this._loadSavedPlaylist(),document.addEventListener("click",e=>{e.target.closest(".playlist-context-menu")||e.target.closest(".playlist-settings-btn")||this._closeAllMenus()}),document.addEventListener("keydown",e=>{"Escape"===e.key&&this._closeAllMenus()})}_initPlayerNavigation(){this.player?(this.player.setNavigationCallbacks(()=>this.playPrevious(),()=>this.playNext()),this.player.setPlayCallback(()=>{this.items.length>0&&this.selectItem(0)})):console.error("Playlist: Player instance is missing!")}_initKeyboardShortcuts(){document.addEventListener("keydown",e=>{if("INPUT"!==e.target.tagName&&"TEXTAREA"!==e.target.tagName&&(!e.shiftKey||"N"!==e.key&&"n"!==e.key||(e.preventDefault(),this.playNext()),!e.shiftKey||"P"!==e.key&&"p"!==e.key||(e.preventDefault(),this.playPrevious()),"Delete"!==e.key&&"Backspace"!==e.key||this.activeIndex>=0&&confirm("Remove current video from playlist?")&&this.removeItem(this.activeIndex),(e.ctrlKey||e.metaKey)&&("u"===e.key||"U"===e.key))){e.preventDefault();const t=document.getElementById("mb-file-input");t&&t.click()}})}_createHeader(){const e=document.getElementById("playlist-header-controls-template");if(!e)return void console.error("Playlist header template not found!");const t=e.content.cloneNode(!0),i=document.createElement("div");i.className="playlist-header",i.appendChild(t),this.container.parentNode.insertBefore(i,this.container);const a=document.querySelector(".playlist-section"),l=document.getElementById("sidebar-toggle-btn");a&&l?import("./SidebarToggle.js").then(({SidebarToggle:e})=>{new e(a,l)}).catch(e=>{console.error("Failed to load SidebarToggle:",e)}):console.warn("Sidebar toggle elements not found",{sidebarElement:a,toggleButton:l});const s=i.querySelector("#mb-add-files"),n=i.querySelector("#mb-add-folder"),o=i.querySelector("#mb-clear-playlist"),r=i.querySelector("#mb-playlist-search-input"),d=i.querySelector("#mb-playlist-search-clear");if(r){const e=((e,t)=>{let i;return function(...a){clearTimeout(i),i=setTimeout(()=>{clearTimeout(i),e(...a)},t)}})(e=>{this.searchQuery=e.target.value.trim().toLowerCase(),this.searchQuery?d?.classList.remove("hidden"):d?.classList.add("hidden"),this.render()},300);r.addEventListener("input",e),r.addEventListener("keydown",e=>{"Escape"===e.key&&(r.value="",this.searchQuery="",d?.classList.add("hidden"),this.render(),r.blur())})}d&&d.addEventListener("click",()=>{r.value="",this.searchQuery="",d.classList.add("hidden"),this.render(),r.focus()}),s&&s.addEventListener("click",async()=>{if(ElectronHelper.isElectron()){const e=await ElectronHelper.openFileDialog();e.success&&e.files&&this.handleElectronFiles(e.files)}else document.getElementById("mb-file-input").click()}),n&&n.addEventListener("click",()=>{document.getElementById("mb-folder-input").click()}),o&&o.addEventListener("click",()=>{this.clear()});const c=i.querySelector("#mb-scroll-to-playing");c&&c.addEventListener("click",()=>{this.scrollToPlaying()});const h=document.getElementById("mb-file-input"),m=document.getElementById("mb-folder-input");h&&h.addEventListener("change",e=>{this.handleFiles(e.target.files),e.target.value=""}),m&&m.addEventListener("change",e=>{this.handleFiles(e.target.files),e.target.value=""})}_createListContainer(){this.container.classList.add("playlist-items")}_initMobileDrawer(){const e=document.getElementById("playlist-toggle"),t=document.getElementById("playlist-overlay"),i=this.container.closest(".playlist-section");if(e&&t&&i){const a=()=>{window.innerWidth<=768?e.style.display="flex":(e.style.display="none",i.classList.remove("open"),t.classList.remove("visible"))};window.addEventListener("resize",a),a();const l=()=>{i.classList.contains("open")?(i.classList.remove("open"),t.classList.remove("visible"),e.setAttribute("aria-expanded","false")):(i.classList.add("open"),t.classList.add("visible"),e.setAttribute("aria-expanded","true"))};e.addEventListener("click",l),t.addEventListener("click",l)}}_initKeyboardShortcuts(){document.addEventListener("keydown",e=>{["INPUT","TEXTAREA","SELECT"].includes(document.activeElement.tagName)||(e.shiftKey&&"n"===e.key.toLowerCase()?(e.preventDefault(),this.playNext()):e.shiftKey&&"p"===e.key.toLowerCase()?(e.preventDefault(),this.playPrevious()):"Delete"===e.key||e.key)})}_setupPlayerNavigation(){this.player&&"function"==typeof this.player.setNavigationCallbacks&&(this.player.setNavigationCallbacks(()=>this.playPrevious(),()=>this.playNext()),this.player.onEnded=()=>this.playNext(),this._updatePlayerNavigationState())}_canGoPrevious(){return this.activeIndex>0&&this.items.length>0}_canGoNext(){return this.activeIndex>=0&&this.activeIndex<this.items.length-1}_updatePlayerNavigationState(){this.player&&"function"==typeof this.player.updateNavigationButtons&&this.player.updateNavigationButtons(this._canGoPrevious(),this._canGoNext())}scrollToPlaying(){if(this.activeIndex<0||this.activeIndex>=this.items.length)return void console.log("[Playlist] No active item to scroll to");const e=document.querySelector("#mb-playlist-search-input");if(e&&e.value){e.value="",this.searchQuery="";const t=document.querySelector("#mb-playlist-search-clear");t?.classList.add("hidden"),this.render()}const t=this.items[this.activeIndex];if(t.path&&t.path.includes("/")){const e=t.path.split("/");let i="";for(let t=0;t<e.length-1;t++)i=i?`${i}/${e[t]}`:e[t],this.expandedFolders.add(i);this.render()}const i=this.container.querySelector(`.playlist-item[data-index="${this.activeIndex}"]`);i&&(i.scrollIntoView({behavior:"smooth",block:"center"}),i.classList.add("playlist-item--highlight"),setTimeout(()=>{i.classList.remove("playlist-item--highlight")},1500))}playPrevious(){this.activeIndex>0&&this.selectItem(this.activeIndex-1)}async _loadSavedPlaylist(){try{const{items:e,playbackState:t}=await PlaylistStorage.loadPlaylist();if(e.length>0){if(this.items=e,this.render(),t){let e=-1;if(t.activeId&&(e=this.items.findIndex(e=>e.id===t.activeId)),-1===e&&"number"==typeof t.index&&(e=t.index),e>=0&&e<this.items.length){const t=this.items[e];console.log("[Playlist] Restoring item:",t.title,{isLocal:t.isLocal,hasFile:!!t.file,url:t.url,localPath:t.localPath}),await this.selectItem(e,!1)}}}else this.render()}catch(e){console.error("Error loading playlist:",e),this.render()}}_saveState(){const e=this.player?.currentTime||0;PlaylistStorage.savePlaylist(this.items,this.activeIndex,e)}_savePlaybackProgress(){const e=this.items[this.activeIndex],t=this.player?.currentTime||0;PlaylistStorage.savePlaybackProgress(e,this.activeIndex,t)}handleFiles(e){const t=Array.from(e).filter(e=>e.type.startsWith("video/")||e.type.startsWith("audio/"));if(0===t.length)return void alert("Please select valid video or audio files.");const i=t.map(e=>{let t=e.webkitRelativePath||e.name;t.includes("/")||(t=e.name);const i=e.type.startsWith("audio/"),a={title:e.name,url:URL.createObjectURL(e),duration:"Loading...",thumbnail:"",isLocal:!0,isAudio:i,needsReload:!1,file:e,fileSize:e.size,fileType:e.type,mimeType:e.type,path:t,id:generateId()};return e.path&&(a.localPath=e.path,console.log("[Electron] Storing localPath for:",e.name,"->",e.path)),a});this.addItems(i),this._processMetadata(i),this.items.length===i.length&&this.selectItem(0)}async handleElectronFiles(e){const t=["mp3","flac","aac","ogg","wav","m4a","opus","wma"],i=["mp4","mkv","avi","webm","mov","m4v","wmv","flv",...t],a=e.filter(e=>{const t=e.name.split(".").pop().toLowerCase();return i.includes(t)});if(0===a.length)return void alert("Please select valid video or audio files.");const l=a.map(e=>{const i=e.name.split(".").pop().toLowerCase(),a={mp4:"video/mp4",mkv:"video/x-matroska",avi:"video/x-msvideo",webm:"video/webm",mov:"video/quicktime",m4v:"video/x-m4v",wmv:"video/x-ms-wmv",flv:"video/x-flv",mp3:"audio/mpeg",flac:"audio/flac",aac:"audio/aac",ogg:"audio/ogg",wav:"audio/wav",m4a:"audio/mp4",opus:"audio/opus",wma:"audio/x-ms-wma"}[i]||"video/mp4",l=i&&t.includes(i);return{title:e.name,url:"",duration:"Loading...",thumbnail:"",isLocal:!0,isAudio:l,needsReload:!1,file:null,fileSize:e.size,fileType:a,mimeType:a,path:e.name,localPath:e.path,id:generateId()}});this.addItems(l),this._processMetadata(l),this.items.length===l.length&&this.selectItem(0)}async _processMetadata(e){await MediaMetadata.processMetadata(e,e=>this._updateItemUI(e),()=>this._saveState())}async _ensureMetadata(e){await MediaMetadata.ensureMetadata(e,()=>this._saveState())}async _getVideoDuration(e){return await MediaMetadata.getVideoDuration(e)}async _prefetchMetadata(e){if(e.isStream)console.log("[Playlist] Skipping metadata prefetch for stream:",e.title);else if(e.videoInfo||e.audioInfo)console.log("[Playlist] Metadata already cached for:",e.title);else try{console.log("[Playlist] Prefetching metadata for:",e.title),await this._ensureMetadata(e),console.log("[Playlist] Metadata prefetch complete:",e.title)}catch(t){console.warn("[Playlist] Metadata prefetch failed for:",e.title,t)}}_updateItemUI(e){const t=this.items.indexOf(e);if(-1===t)return;const i=this.container.querySelector(`.playlist-item[data-index="${t}"]`);if(i){let t=i.querySelector(".playlist-thumbnail-overlay");if(!t){t=document.createElement("div"),t.className="playlist-thumbnail-overlay";const e=i.querySelector(".playlist-thumbnail");e&&e.appendChild(t)}t&&(t.textContent=e.duration);const a=i.querySelector(".playlist-thumbnail");a&&e.thumbnail&&(a.style.backgroundImage=`url(${e.thumbnail})`,a.style.backgroundSize="cover",a.style.backgroundPosition="center",Array.from(a.children).forEach(e=>{e.classList.contains("playlist-thumbnail-overlay")||(e.style.display="none")}))}}_updateStreamItemMetadata(e,t){if(this.player.isLive)e.duration="LIVE",e.isLive=!0;else{const t=()=>{this.player.duration&&this.player.duration>0&&(e.duration=formatDuration(this.player.duration),this._updateItemUI(e),this._saveState())};setTimeout(t,500),setTimeout(t,2e3)}this._captureStreamThumbnail(e,t),this._updateItemUI(e)}_captureStreamThumbnail(e,t){const i=++this._thumbnailCaptureId||1;if(this._thumbnailCaptureId=i,e.thumbnail)return void console.log(`[Playlist] Keeping existing thumbnail for: ${e.title}`);const a=(l,s,n)=>{if(this._thumbnailCaptureId===i&&this.activeIndex===t)try{const t=document.createElement("canvas");t.width=80,t.height=45;const i=t.getContext("2d");i.drawImage(this.player.canvas,0,0,t.width,t.height);const l=i.getImageData(0,0,t.width,t.height).data;let s=0;const n=10;for(let e=0;e<l.length;e+=16)(l[e]>n||l[e+1]>n||l[e+2]>n)&&s++;if(s<.05*(t.width*t.height/4))return;e.thumbnail=t.toDataURL("image/jpeg",.5),this._updateItemUI(e),this._saveState(),console.log(`[Playlist] Captured thumbnail via render loop for: ${e.title}`),this.player.afterFrameRenderCallbacks=this.player.afterFrameRenderCallbacks.filter(e=>e!==a)}catch(e){console.warn("[Playlist] Failed to capture thumbnail in render loop:",e),this.player.afterFrameRenderCallbacks=this.player.afterFrameRenderCallbacks.filter(e=>e!==a)}else this.player.afterFrameRenderCallbacks=this.player.afterFrameRenderCallbacks.filter(e=>e!==a)};this.player.afterFrameRenderCallbacks.push(a),setTimeout(()=>{this.player.afterFrameRenderCallbacks=this.player.afterFrameRenderCallbacks.filter(e=>e!==a)},6e4)}_updateLocalItemMetadata(e,t){const i=()=>{if(this.player.duration&&this.player.duration>0){const t=formatDuration(this.player.duration);e.duration!==t&&(e.duration=t,this._updateItemUI(e),this._saveState())}};setTimeout(i,300),setTimeout(i,1e3),e.thumbnail||setTimeout(()=>{try{if(e.thumbnail)return;const t=this.player.canvas;if(t&&t.width>0&&t.height>0){const i=document.createElement("canvas");i.width=80,i.height=45;i.getContext("2d").drawImage(t,0,0,i.width,i.height);const a=i.toDataURL("image/jpeg",.5);e.thumbnail=a,this._updateItemUI(e),this._saveState(),console.log(`[Playlist] Captured thumbnail for local file: ${e.title}`)}}catch(e){console.warn("[Playlist] Failed to capture local file thumbnail:",e)}},500)}addItem(e){e.id||(e.id=generateId()),this.items.push(e),this._saveState(),this.render(),this._updatePlayerNavigationState()}async addItems(e){const t=[],i=[];for(const a of e){const e=a.url?.toLowerCase()||"";e.endsWith(".m3u")||e.includes(".m3u")&&!e.includes(".m3u8")?t.push(a):(a.id||(a.id=generateId()),i.push(a))}if(i.length>0){const e=this.items.length;this.items=[...this.items,...i],this._saveState(),this.render(),this._updatePlayerNavigationState(),1===i.length&&0===t.length&&this.selectItem(e)}for(const e of t)try{console.log(`[Playlist] Expanding M3U playlist: ${e.title||e.url}`),await this._handleM3UPlaylist(e.url)}catch(t){console.error(`[Playlist] Failed to expand M3U: ${e.url}`,t),e.id||(e.id=generateId()),this.items.push(e),this._saveState(),this.render()}}removeItem(e){e<0||e>=this.items.length||(e===this.activeIndex?this.items.length>1?e<this.items.length-1?(this.selectItem(e+1),this.activeIndex--):this.selectItem(e-1):this.clear(!1):e<this.activeIndex&&this.activeIndex--,this.items.splice(e,1),this._saveState(),this.render(),this._updatePlayerNavigationState())}async clear(e=!0){(!e||e&&confirm("Are you sure you want to clear the playlist? This will reset the application state."))&&(this.player.reset(),this.items=[],this.activeIndex=-1,await this.storage.clear(),this.render(),this._updatePlayerNavigationState(),console.log("Application state reset successfully"))}playNext(){this.activeIndex<this.items.length-1?this.selectItem(this.activeIndex+1):"playlist"===this.player.loopMode?this.selectItem(0):console.log("Playlist ended")}async selectItem(e,t=!0){if(!(e<0||e>=this.items.length)){this.player&&"function"==typeof this.player.resetUI&&this.player.resetUI();try{const i=this.player.isPlaying;if((this.player.isPlaying||this.player.videoTrack||this.player.audioTrack)&&(this.player.pause(!1),await new Promise(e=>setTimeout(e,50))),-1!==this.activeIndex&&this.activeIndex!==e){const e=this.items[this.activeIndex];e&&e.isLocal&&e.url&&(console.log(`Releasing memory for: ${e.title}`),URL.revokeObjectURL(e.url),e.url=null,e.file=null)}const a=this.items[e];if(a.needsReload)return void alert("This local file needs to be re-uploaded.");if(this.activeIndex=e,RecordMenu.handleItemChange(this),a.isLive||a.isStream||a.url&&a.url.includes(".m3u8")){a.isStream=!0;const i=t&&this.player.isPlaying;return await this.player.load(a.url,i,a.id,null),this._updateStreamItemMetadata(a,e),this._updateUI(),this._saveState(),this._updatePlayerNavigationState(),void(i&&this.player.play())}if(!a.blob_url)try{if(a.isLocal||!a.url||a.isStream)this.player.ui&&this.player.ui.loader&&this.player.ui.loader.classList.add("visible"),console.log(`Loading file from storage: ${a.title}`),this.player.already_fetching=!0,await MediaMetadata.getProcessedSourceURL(a);else{const e=await MediaMetadata.checkCache(a);e?(console.log(`[Playlist] Playing from cache: ${a.title}`),a.blob_url=URL.createObjectURL(e),a.file=e):(console.log(`[Playlist] Playing directly from URL (background caching): ${a.title}`),a.blob_url=a.url,MediaMetadata.cacheInBackground(a,()=>{console.log(`[Playlist] Background cache complete for: ${a.title}`),this._saveState()}))}this.player.already_fetching&&(a.blob_url.startsWith("blob:"),this.player.already_fetching=!1)}catch(t){console.error("Error loading file from storage:",t),this.player.ui&&this.player.ui.loader&&this.player.ui.loader.classList.remove("visible");try{console.log("Showing modal for file not found...");await ConfirmModal.confirm({title:"File Not Found",message:`"${a.title}" could not be loaded.\n\nThis file was likely too large to save in browser storage (>500MB) and needs to be re-added to the playlist.`,confirmText:"Remove",cancelText:"Keep",confirmStyle:"danger",icon:"âš ï¸"})&&(this.items.splice(e,1),this.activeIndex>=e&&(this.activeIndex=Math.max(-1,this.activeIndex-1)),this._saveState(),this.render(),this._updatePlayerNavigationState())}catch(e){console.error("Error showing modal:",e)}return}if(!a.blob_url)return void console.error("Video URL is null, cannot load:",a.title);const l=t&&i;this.player.onSubtitleChange=e=>{a.subtitleTracks=e.map(e=>({id:e.id,name:e.name,cues:[...e.cues]})),this._saveState(),console.log(`Saved ${e.length} subtitle track(s) for: ${a.title}`)},await this.player.load(a.blob_url,l,a.id,a.subtitleTracks||null,{isAudio:a.isAudio}),this._updateLocalItemMetadata(a,e),this._updateUI(),this._saveState(),this._updatePlayerNavigationState(),l&&this.player.play(),this._prefetchMetadata(a)}finally{this._isSelectingItem=!1}}}render(){if(this.container.innerHTML="",0===this.items.length){const e=document.getElementById("playlist-empty-template").content.cloneNode(!0);return void this.container.appendChild(e)}if(this.searchQuery){const e=this.items.filter(e=>e.title.toLowerCase().includes(this.searchQuery));if(0===e.length){const e=document.createElement("div");e.className="playlist-placeholder",e.textContent="No matches found",this.container.appendChild(e)}else{const t=50;if(e.slice(0,t).forEach(e=>{const t=this.items.indexOf(e);this.container.appendChild(this._createPlaylistItemElement({...e,originalIndex:t}))}),e.length>t){const i=document.createElement("div");i.style.padding="10px",i.style.textAlign="center",i.style.color="var(--text-secondary)",i.style.fontSize="12px",i.textContent=`Showing top ${t} of ${e.length} matches. Refine search to see more.`,this.container.appendChild(i)}}}else{const e=this._buildTree(this.items);this.container.appendChild(this._renderTreeLevel(e))}this._updateUI()}_buildTree(e){const t={name:"root",children:{},items:[]};return e.forEach((e,i)=>{const a=(e.path||e.title||"Unknown").split("/");if(1===a.length)return void t.items.push({...e,originalIndex:i});let l=t;for(let e=0;e<a.length-1;e++){const t=a[e];l.children[t]||(l.children[t]={name:t,path:a.slice(0,e+1).join("/"),children:{},items:[]}),l=l.children[t]}l.items.push({...e,originalIndex:i})}),t}_renderTreeLevel(e){const t=document.createElement("div");return t.className="playlist-tree-level",Object.values(e.children).forEach(e=>{t.appendChild(this._createFolderElement(e))}),e.items.forEach(e=>{t.appendChild(this._createPlaylistItemElement(e))}),t}_createFolderElement(e){const t=document.createElement("div");t.className="playlist-folder";const i=this.expandedFolders.has(e.path),a=this._countFolderChildren(e),l=a>50&&!i,s=this._createFolderHeader(e,i,a),n=document.createElement("div");return n.className="playlist-children "+(i?"":"hidden"),l?(n.dataset.lazyFolder=e.path,n.dataset.needsRender="true",this._lazyFolderData=this._lazyFolderData||new Map,this._lazyFolderData.set(e.path,e)):n.appendChild(this._renderTreeLevel(e)),this._attachFolderEvents(s,n,e),t.appendChild(s),t.appendChild(n),t}_countFolderChildren(e){let t=e.items?.length||0;if(e.children)for(const i of Object.values(e.children))t+=this._countFolderChildren(i);return t}_createFolderHeader(e,t,i=0){const a=document.getElementById("playlist-folder-header-template").content.cloneNode(!0),l=a.querySelector(".playlist-folder-header"),s=l.querySelector(".playlist-toggle"),n=l.querySelector(".folder-name"),o=l.querySelector(".folder-remove-btn");return t&&s.classList.add("expanded"),n.textContent=i>0?`${e.name} (${i})`:e.name,o.setAttribute("aria-label",`Remove folder ${e.name}`),a.firstElementChild}_attachFolderEvents(e,t,i){e.querySelector(".playlist-folder-info").addEventListener("click",a=>{a.stopPropagation();t.classList.contains("hidden")?("true"===t.dataset.needsRender&&this._renderLazyFolderContent(t,i),t.classList.remove("hidden"),e.querySelector(".playlist-toggle").classList.add("expanded"),this.expandedFolders.add(i.path)):(t.classList.add("hidden"),e.querySelector(".playlist-toggle").classList.remove("expanded"),this.expandedFolders.delete(i.path))}),e.querySelector(".folder-remove-btn").addEventListener("click",e=>{e.stopPropagation(),confirm(`Delete folder "${i.name}" and all its contents?`)&&this.removeFolder(i.path)})}_renderLazyFolderContent(e,t){delete e.dataset.needsRender,delete e.dataset.lazyFolder,e.appendChild(this._renderTreeLevel(t))}_createPlaylistItemElement(e){const t=this._createItemHTML(e,e.originalIndex).querySelector(".playlist-item");return this._attachItemEvents(t),t}_attachItemEvents(e){e.addEventListener("click",t=>{if(t.target.closest(".playlist-remove-btn")||t.target.closest(".playlist-download-btn"))return;const i=parseInt(e.dataset.index);this.selectItem(i)});const t=e.querySelector(".playlist-download-btn");t&&t.addEventListener("click",t=>{t.stopPropagation();const i=parseInt(e.dataset.index);this._downloadItem(i)});const i=e.querySelector(".playlist-remove-btn");i&&i.addEventListener("click",t=>{t.stopPropagation();const i=parseInt(e.dataset.index);this.removeItem(i)});const a=e.querySelector(".playlist-settings-btn");a&&a.addEventListener("click",t=>{t.stopPropagation();const i=parseInt(e.dataset.index);this._toggleSettingsMenu(i,a)})}_updateUI(){if(this.container.querySelectorAll(".playlist-item").forEach(e=>e.classList.remove("active")),this.activeIndex>=0){const e=this.container.querySelector(`.playlist-item[data-index="${this.activeIndex}"]`);e&&(e.classList.add("active"),e.scrollIntoView({behavior:"smooth",block:"nearest"}))}}removeFolder(e){const t=this.activeIndex>=0&&this.activeIndex<this.items.length?this.items[this.activeIndex]:null,i=this.items.length;if(this.items=this.items.filter(t=>{const i=t.path||"";return i!==e&&!i.startsWith(e+"/")}),this.items.length!==i){if(t){const e=this.items.indexOf(t);-1===e?(this.activeIndex=-1,this.player&&this.player.reset()):this.activeIndex=e}else this.activeIndex=-1;this._saveState(),this.render()}}_sanitizeFilename(e){let t=e.replace(/[<>:"/\\|?*]/g,"_");return t.match(/\.\w+$/)||(t+=".mp4"),t}async _downloadItem(e){if(e<0||e>=this.items.length)return;const t=this.items[e],i=this.container.querySelector(`[data-index="${e}"] .playlist-download-btn`);try{let e=t.title||"video";if(t.file&&t.file.name&&(e=t.file.name),e=this._sanitizeFilename(e),!t.blob_url){if(i){const e=document.getElementById("loading-spinner-template").content.cloneNode(!0);i.innerHTML="",i.appendChild(e),i.style.opacity="1"}console.log(`Getting source for download: ${t.title}`),await MediaMetadata.getProcessedSourceURL(t,()=>this._saveState()),i&&(i.style.opacity="")}const a=document.getElementById("mb-download-link");if(a.href=t.blob_url,a.download=e,a.click(),t.blob_url&&setTimeout(()=>URL.revokeObjectURL(t.blob_url),100),console.log(`Downloading: ${e}`),i){const e=document.getElementById("playlist-item-template"),t=e.content.cloneNode(!0).querySelector(".playlist-download-btn svg").cloneNode(!0);i.innerHTML="",i.appendChild(t)}}catch(e){if(console.error("Download failed:",e),alert(`Failed to download video: ${e.message}\n\nThis may be due to CORS restrictions on the remote server.`),i){const e=document.getElementById("playlist-item-template").content.cloneNode(!0).querySelector(".playlist-download-btn svg").cloneNode(!0);i.innerHTML="",i.appendChild(e)}}}_createItemHTML(e,t){const i=document.getElementById("playlist-item-template").content.cloneNode(!0),a=i.querySelector(".playlist-item"),l=a.querySelector(".playlist-thumbnail"),s=a.querySelector(".playlist-title"),n=a.querySelector(".playlist-duration");if(a.dataset.index=t,a.setAttribute("aria-label",`Play ${e.title||"Unknown Video"}`),e.needsReload&&a.classList.add("needs-reload"),e.error&&a.classList.add("error"),e.thumbnail)l.style.backgroundImage=`url(${e.thumbnail})`,l.style.backgroundSize="cover",l.style.backgroundPosition="center";else{const e=document.getElementById("video-placeholder-template").content.cloneNode(!0);l.appendChild(e)}const o=document.createElement("div");o.className="playlist-thumbnail-overlay",o.textContent=e.duration||"--:--",l.appendChild(o);let r=e.title||"Unknown Video";if(r=r.replace(/\.[^/.]+$/,""),r=r.replace(/[_-]/g," "),r=r.replace(/\b\w/g,e=>e.toUpperCase()),s.textContent=r,s.setAttribute("title",r),e.needsReload){const e=document.getElementById("missing-file-status-template").content.cloneNode(!0);s.appendChild(e)}return n&&(n.style.display="none"),i}_initUrlUpload(){const e=document.getElementById("mb-add-url");e?e.addEventListener("click",()=>{this._openUrlModal()}):console.warn("URL Upload button not found")}_openUrlModal(){const e=document.getElementById("url-upload-content-template"),t=document.getElementById("url-upload-footer-template");if(!e||!t)return;const i=new DialogModal({maxWidth:"500px"});i.setTitle("Add Video from URL"),i.setBody(e.content.cloneNode(!0)),i.setFooter(t.content.cloneNode(!0));const a=i.modal,l=a.querySelector("#url-input"),s=a.querySelector(".mb-modal-add"),n=a.querySelector(".mb-modal-cancel"),o=a.querySelector(".mb-modal-error"),r=a.querySelector(".mb-modal-loading");i.open(),setTimeout(()=>l.focus(),100),l.addEventListener("input",()=>{const e=this._isValidUrl(l.value);s.disabled=!e,o.style.display="none"}),s.addEventListener("click",async()=>{const e=l.value.trim();if(e){l.disabled=!0,s.disabled=!0,n.disabled=!0,i.closeBtn.disabled=!0,r.style.display="flex",o.style.display="none";try{await this._handleUrlUpload(e),i.close()}catch(e){l.disabled=!1,s.disabled=!1,n.disabled=!1,i.closeBtn.disabled=!1,r.style.display="none",o.textContent=e.message,o.style.display="block"}}}),n.addEventListener("click",()=>i.close()),l.addEventListener("keydown",e=>{"Enter"!==e.key||s.disabled||s.click(),"Escape"===e.key&&i.close()})}_isValidUrl(e){try{const t=new URL(e);return"http:"===t.protocol||"https:"===t.protocol}catch(e){return!1}}async _handleUrlUpload(e){try{const t=e.toLowerCase();if(t.endsWith(".m3u")||t.includes(".m3u")&&!t.includes(".m3u8"))return void await this._handleM3UPlaylist(e);if(t.includes(".m3u8")||t.includes("/hls/")||t.includes("/live/")){let t=new URL(e).pathname.split("/").pop()||"stream";t=t.split("?")[0];const i={title:t.replace(".m3u8","")||"Live Stream",url:e,blob_url:e,duration:"LIVE",thumbnail:"",isLocal:!1,isStream:!0,file:null,fileType:"application/vnd.apple.mpegurl",mimeType:"application/vnd.apple.mpegurl",id:generateId()};return this.addItem(i),void(1===this.items.length&&this.selectItem(0))}if([".mp3",".flac",".aac",".ogg",".wav",".m4a",".opus",".wma"].some(e=>t.endsWith(e))){let i=new URL(e).pathname.split("/").pop()||"audio";i=i.split("?")[0];const a={title:i.replace(/\.[^/.]+$/,"")||"Audio Track",url:e,blob_url:e,duration:"Loading...",thumbnail:"",isLocal:!1,isAudio:!0,file:null,fileType:this._getAudioMimeType(t),mimeType:this._getAudioMimeType(t),id:generateId()};return this.addItem(a),void(1===this.items.length&&this.selectItem(0))}const i=await fetch(e,{method:"HEAD"});if(!i.ok){const t=await fetch(e);if(!t.ok)throw new Error(`Failed to fetch video: ${t.statusText}`)}const a=i.headers.get("content-type")||"video/mp4";if(!["video/","application/vnd.apple.mpegurl","application/x-mpegurl"].some(e=>a.toLowerCase().includes(e.toLowerCase())))throw new Error("The URL does not point to a valid video file or stream.");const l=new URL(e).pathname,s={title:l.split("/").pop()||"remote-video.mp4",url:e,duration:"Loading...",thumbnail:"",isLocal:!1,file:null,fileType:a,mimeType:a,id:generateId()};this.addItem(s),this._processMetadata([s]),1===this.items.length&&this.selectItem(0)}catch(e){if(e.message.includes("Failed to fetch")||"TypeError"===e.name)throw new Error("CORS Error: Cannot access this URL. The server must allow cross-origin requests.");throw e}}async _handleM3UPlaylist(e){try{const t=await M3UParser.fetchAndParse(e);if(!t||0===t.length)throw new Error("No channels found in this playlist.");let i=new URL(e).pathname.split("/").pop()||"IPTV Playlist";i=i.replace(".m3u","").replace(/_/g," "),i=i.charAt(0).toUpperCase()+i.slice(1);const a=t.map(e=>{const t=e.group||"Uncategorized",a=e.name||"Unknown Channel",l=`${i}/${t}/${a}`;return{title:a,url:e.url,blob_url:e.url,duration:"LIVE",thumbnail:e.logo||"",isLocal:!1,isStream:!0,isLive:!0,file:null,fileType:"application/vnd.apple.mpegurl",mimeType:"application/vnd.apple.mpegurl",path:l,id:e.id||generateId(),m3uData:{tvgId:e.tvgId,tvgName:e.tvgName,language:e.language,country:e.country,group:e.group}}});a.forEach(e=>{e.id||(e.id=generateId())}),this.items=[...this.items,...a],this._saveState(),this.render(),this._updatePlayerNavigationState(),this._showToast(`Added ${t.length} channels from ${i}`),console.log(`[M3U] Imported ${t.length} channels from: ${e}`)}catch(e){if(console.error("[M3U] Failed to import playlist:",e),e.message.includes("Failed to fetch")||"TypeError"===e.name)throw new Error("CORS Error: Cannot access this M3U playlist. The server must allow cross-origin requests.");throw e}}_getAudioMimeType(e){const t={".mp3":"audio/mpeg",".flac":"audio/flac",".aac":"audio/aac",".ogg":"audio/ogg",".wav":"audio/wav",".m4a":"audio/mp4",".opus":"audio/opus",".wma":"audio/x-ms-wma"};for(const[i,a]of Object.entries(t))if(e.endsWith(i))return a;return"audio/mpeg"}_toggleSettingsMenu(e,t){const i=document.querySelector(".playlist-context-menu"),a=i&&i.dataset.index==e;this._closeAllMenus(),a||this._createSettingsMenu(e,t)}_createSettingsMenu(e,t){const i=document.getElementById("playlist-settings-menu-template");if(!i)return;const a=i.content.cloneNode(!0).querySelector(".playlist-context-menu");a.dataset.index=e;const l=this.items[e].isLive;a.querySelectorAll(".playlist-menu-item").forEach(e=>{const t=e.dataset.action;l?"info"===t||"record"===t?(e.style.display="flex","record"===t&&(RecordMenu.isRecording?(e.querySelector(".menu-label").textContent="Stop Recording",e.querySelector(".menu-icon").textContent="â¹ï¸",e.classList.add("text-red-500")):(e.querySelector(".menu-label").textContent="Record Stream...",e.querySelector(".menu-icon").textContent="ðŸ”´",e.classList.remove("text-red-500")))):e.style.display="none":e.style.display="record"===t?"none":"flex"}),l?a.querySelectorAll(".menu-divider").forEach(e=>{e.style.display="none"}):a.querySelectorAll(".menu-divider").forEach(e=>{e.style.display="block"}),a.querySelectorAll(".playlist-menu-item").forEach(t=>{t.addEventListener("click",i=>{if(i.stopPropagation(),t.classList.contains("disabled"))return;const a=t.dataset.action;MenuRouter.init(a,e,this),this._closeAllMenus(),this.player.pause()})}),document.body.appendChild(a),this._positionSettingsMenu(a,t),requestAnimationFrame(()=>{a.classList.add("visible")})}_positionSettingsMenu(e,t){const i=t.getBoundingClientRect(),a=e.getBoundingClientRect(),l=window.innerHeight;let s=i.bottom+5,n=i.right-a.width;s+a.height>l-10&&(s=i.top-a.height-5),s<10&&(s=10),n<10&&(n=i.left),e.style.top=`${s}px`,e.style.left=`${n}px`}_closeAllMenus(){document.querySelectorAll(".playlist-context-menu").forEach(e=>{e.classList.remove("visible"),setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},200)})}async _getFormattedMetadata(e,t){return await MediaMetadata.getFormattedMetadata(e,t)}_showToast(e){const t=document.createElement("div");t.textContent=e,t.style.cssText="\n            position: fixed;\n            bottom: 20px;\n            left: 50%;\n            transform: translateX(-50%);\n            background: var(--accent-primary);\n            color: #000;\n            padding: 10px 20px;\n            border-radius: 4px;\n            font-weight: bold;\n            z-index: 3000;\n            opacity: 0;\n            transition: opacity 0.3s;\n        ",document.body.appendChild(t),requestAnimationFrame(()=>t.style.opacity="1"),setTimeout(()=>{t.style.opacity="0",setTimeout(()=>document.body.removeChild(t),300)},2e3)}}