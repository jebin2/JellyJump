import{IndexedDBService}from"./IndexedDBService.js";import{MediaBunny}from"../core/MediaBunny.js";import{MediaProcessor}from"../core/MediaProcessor.js";import{Modal}from"./Modal.js";export class Playlist{constructor(e,t){this.container=e,this.player=t,this.items=[],this.activeIndex=-1,this.storage=new IndexedDBService,this.expandedFolders=new Set,this.storage=new IndexedDBService,this.saveTimeout=null,this.container.innerHTML="",setInterval(()=>{this.player&&this.player.isPlaying&&this._savePlaybackProgress()},1e3),this._createHeader(),this._createListContainer(),this._attachDragEvents(),window.addEventListener("beforeunload",()=>{this._saveState()}),this._initKeyboardShortcuts(),this._initPlayerNavigation(),this._initUrlUpload(),this._loadSavedPlaylist(),document.addEventListener("click",e=>{e.target.closest(".playlist-context-menu")||e.target.closest(".playlist-settings-btn")||this._closeAllMenus()}),document.addEventListener("keydown",e=>{"Escape"===e.key&&this._closeAllMenus()})}_initPlayerNavigation(){this.player?(this.player.setNavigationCallbacks(()=>this.playPrevious(),()=>this.playNext()),this.player.setPlayCallback(()=>{this.items.length>0&&this.selectItem(0)})):console.error("Playlist: Player instance is missing!")}_initKeyboardShortcuts(){document.addEventListener("keydown",e=>{if("INPUT"!==e.target.tagName&&"TEXTAREA"!==e.target.tagName&&(!e.shiftKey||"N"!==e.key&&"n"!==e.key||(e.preventDefault(),this.playNext()),!e.shiftKey||"P"!==e.key&&"p"!==e.key||(e.preventDefault(),this.playPrevious()),"Delete"!==e.key&&"Backspace"!==e.key||this.activeIndex>=0&&confirm("Remove current video from playlist?")&&this.removeItem(this.activeIndex),(e.ctrlKey||e.metaKey)&&("u"===e.key||"U"===e.key))){e.preventDefault();const t=document.getElementById("mb-file-input");t&&t.click()}})}_createHeader(){const e=document.getElementById("playlist-header-controls-template");if(!e)return void console.error("Playlist header template not found!");const t=e.content.cloneNode(!0),i=document.createElement("div");i.className="playlist-header",i.appendChild(t),this.container.parentNode.insertBefore(i,this.container);const s=document.querySelector(".playlist-section"),n=document.getElementById("sidebar-toggle-btn");s&&n?import("./SidebarToggle.js").then(({SidebarToggle:e})=>{new e(s,n)}).catch(e=>{console.error("Failed to load SidebarToggle:",e)}):console.warn("Sidebar toggle elements not found",{sidebarElement:s,toggleButton:n});const a=i.querySelector("#mb-add-files"),o=i.querySelector("#mb-add-folder"),l=i.querySelector("#mb-clear-playlist");a&&a.addEventListener("click",()=>{document.getElementById("mb-file-input").click()}),o&&o.addEventListener("click",()=>{document.getElementById("mb-folder-input").click()}),l&&l.addEventListener("click",()=>{this.clear()});const r=document.getElementById("mb-file-input"),d=document.getElementById("mb-folder-input");r&&r.addEventListener("change",e=>{this.handleFiles(e.target.files),e.target.value=""}),d&&d.addEventListener("change",e=>{this.handleFiles(e.target.files),e.target.value=""})}_createListContainer(){this.container.classList.add("playlist-items")}_initMobileDrawer(){const e=document.getElementById("playlist-toggle"),t=document.getElementById("playlist-overlay"),i=this.container.closest(".playlist-section");if(e&&t&&i){const s=()=>{window.innerWidth<=768?e.style.display="flex":(e.style.display="none",i.classList.remove("open"),t.classList.remove("visible"))};window.addEventListener("resize",s),s();const n=()=>{i.classList.contains("open")?(i.classList.remove("open"),t.classList.remove("visible"),e.setAttribute("aria-expanded","false")):(i.classList.add("open"),t.classList.add("visible"),e.setAttribute("aria-expanded","true"))};e.addEventListener("click",n),t.addEventListener("click",n)}}_initKeyboardShortcuts(){document.addEventListener("keydown",e=>{["INPUT","TEXTAREA","SELECT"].includes(document.activeElement.tagName)||(e.shiftKey&&"n"===e.key.toLowerCase()?(e.preventDefault(),this.playNext()):e.shiftKey&&"p"===e.key.toLowerCase()?(e.preventDefault(),this.playPrevious()):"Delete"===e.key||e.key)})}_setupPlayerNavigation(){this.player&&"function"==typeof this.player.setNavigationCallbacks&&(this.player.setNavigationCallbacks(()=>this.playPrevious(),()=>this.playNext()),this.player.onEnded=()=>this.playNext(),this._updatePlayerNavigationState())}_canGoPrevious(){return this.activeIndex>0&&this.items.length>0}_canGoNext(){return this.activeIndex>=0&&this.activeIndex<this.items.length-1}_updatePlayerNavigationState(){this.player&&"function"==typeof this.player.updateNavigationButtons&&this.player.updateNavigationButtons(this._canGoPrevious(),this._canGoNext())}playPrevious(){this.activeIndex>0&&this.selectItem(this.activeIndex-1)}async _loadSavedPlaylist(){try{const e=await this.storage.loadPlaylist();if(e.length>0){this.items=e,this.render();const t=await this.storage.loadPlaybackState();if(t){let e=-1;if(t.activeId&&(e=this.items.findIndex(e=>e.id===t.activeId)),-1===e&&"number"==typeof t.index&&(e=t.index),e>=0&&e<this.items.length){this.activeIndex=e;const t=this.items[this.activeIndex];t.needsReload||(await this.player.load(t.url,!1,t.id),this._updateUI(),this._updatePlayerNavigationState())}}}else this.render()}catch(e){console.error("Error loading playlist:",e),this.render()}}_saveState(){this.storage.savePlaylist(this.items);const e=this.items[this.activeIndex];this.storage.savePlaybackState({index:this.activeIndex,activeId:e?e.id:null,time:this.player.currentTime||0})}_savePlaybackProgress(){const e=this.items[this.activeIndex];if(e){const t=this.player.currentTime||0;this.storage.savePlaybackState({index:this.activeIndex,activeId:e.id,time:t});try{const i={videoIdentifier:e.id,timestamp:t,savedAt:(new Date).toISOString()};localStorage.setItem(`jellyjump-state-${e.id}`,JSON.stringify(i))}catch(e){console.warn("Failed to sync state to localStorage:",e)}}}_attachDragEvents(){const e=this.container.closest(".playlist-section");["dragenter","dragover","dragleave","drop"].forEach(t=>{e.addEventListener(t,e=>{e.preventDefault(),e.stopPropagation()},!1)}),["dragenter","dragover"].forEach(t=>{e.addEventListener(t,()=>{e.classList.add("drag-over")},!1)}),["dragleave","drop"].forEach(t=>{e.addEventListener(t,()=>{e.classList.remove("drag-over")},!1)}),e.addEventListener("drop",async e=>{const t=e.dataTransfer,i=t.items;if(i){const e=[],t=[];for(let s=0;s<i.length;s++){const n=i[s].webkitGetAsEntry?i[s].webkitGetAsEntry():null;n?t.push(this._scanEntry(n)):"file"===i[s].kind&&e.push(i[s].getAsFile())}const s=(await Promise.all(t)).flat(),n=[...e,...s];this.handleFiles(n)}else this.handleFiles(t.files)},!1)}_scanEntry(e){return new Promise(t=>{if(e.isFile)e.file(i=>{!i.webkitRelativePath&&e.fullPath&&Object.defineProperty(i,"webkitRelativePath",{value:e.fullPath.substring(1)}),t([i])});else if(e.isDirectory){e.createReader().readEntries(async e=>{const i=e.map(e=>this._scanEntry(e)),s=await Promise.all(i);t(s.flat())})}else t([])})}handleFiles(e){const t=Array.from(e).filter(e=>e.type.startsWith("video/"));if(0===t.length)return void alert("Please select valid video files.");const i=t.map(e=>{let t=e.webkitRelativePath||e.name;return t.includes("/")||(t=e.name),{title:e.name,url:URL.createObjectURL(e),duration:"Loading...",thumbnail:"",isLocal:!0,needsReload:!1,file:e,path:t,id:this._generateId()}});this.addItems(i),this._processMetadata(i),this.items.length===i.length&&this.selectItem(0)}async _processMetadata(e){for(const t of e)if(t.isLocal&&t.file)try{const e=await this._getVideoDuration(t.file);t.duration=this._formatDuration(e),this._updateItemUI(t),this._saveState()}catch(e){console.warn("Failed to load metadata for",t.title,e),t.duration="--:--",this._updateItemUI(t)}}async _getVideoDuration(e){try{const t=e instanceof File?new MediaBunny.BlobSource(e):new MediaBunny.UrlSource(e),i=new MediaBunny.Input({source:t,formats:MediaBunny.ALL_FORMATS});return await i.computeDuration()}catch(e){return console.error("Error getting video duration:",e),0}}_formatDuration(e){if(!e||isNaN(e))return"--:--";return`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,"0")}`}_updateItemUI(e){const t=this.items.indexOf(e);if(-1===t)return;const i=this.container.querySelector(`.playlist-item[data-index="${t}"]`);if(i){const t=i.querySelector(".playlist-duration");t&&(t.textContent=e.duration)}}addItem(e){e.id||(e.id=this._generateId()),this.items.push(e),this._saveState(),this.render(),this._updatePlayerNavigationState()}addItems(e){e.forEach(e=>{e.id||(e.id=this._generateId())});const t=this.items.length;this.items=[...this.items,...e],this._saveState(),this.render(),this._updatePlayerNavigationState(),1===e.length&&this.selectItem(t)}removeItem(e){e<0||e>=this.items.length||(e===this.activeIndex?this.items.length>1?e<this.items.length-1?(this.selectItem(e+1),this.activeIndex--):this.selectItem(e-1):this.clear(!1):e<this.activeIndex&&this.activeIndex--,this.items.splice(e,1),this._saveState(),this.render(),this._updatePlayerNavigationState())}async clear(e=!0){(!e||e&&confirm("Are you sure you want to clear the playlist? This will reset the application state."))&&(this.player.reset(),this.items=[],this.activeIndex=-1,await this.storage.clear(),this.render(),this._updatePlayerNavigationState(),console.log("Application state reset successfully"))}playNext(){this.activeIndex<this.items.length-1?this.selectItem(this.activeIndex+1):"playlist"===this.player.loopMode?this.selectItem(0):console.log("Playlist ended")}async selectItem(e){if(e<0||e>=this.items.length)return;const t=this.items[e];t.needsReload?alert("This local file needs to be re-uploaded."):(this.activeIndex=e,await this.player.load(t.url,!0,t.id),this._updateUI(),this._saveState(),this._updatePlayerNavigationState(),this.player.play())}render(){if(this.container.innerHTML="",0===this.items.length){const e=document.getElementById("playlist-empty-template").content.cloneNode(!0);return void this.container.appendChild(e)}const e=this._buildTree(this.items);this.container.appendChild(this._renderTreeLevel(e)),this._updateUI()}_buildTree(e){const t={name:"root",children:{},items:[]};return e.forEach((e,i)=>{const s=(e.path||e.title||"Unknown").split("/");if(1===s.length)return void t.items.push({...e,originalIndex:i});let n=t;for(let e=0;e<s.length-1;e++){const t=s[e];n.children[t]||(n.children[t]={name:t,path:s.slice(0,e+1).join("/"),children:{},items:[]}),n=n.children[t]}n.items.push({...e,originalIndex:i})}),t}_renderTreeLevel(e){const t=document.createElement("div");return t.className="playlist-tree-level",Object.values(e.children).forEach(e=>{t.appendChild(this._createFolderElement(e))}),e.items.forEach(e=>{t.appendChild(this._createPlaylistItemElement(e))}),t}_createFolderElement(e){const t=document.createElement("div");t.className="playlist-folder";const i=this.expandedFolders.has(e.path),s=this._createFolderHeader(e,i),n=document.createElement("div");return n.className="playlist-children "+(i?"":"hidden"),n.appendChild(this._renderTreeLevel(e)),this._attachFolderEvents(s,n,e),t.appendChild(s),t.appendChild(n),t}_createFolderHeader(e,t){const i=document.getElementById("playlist-folder-header-template").content.cloneNode(!0),s=i.querySelector(".playlist-folder-header"),n=s.querySelector(".playlist-toggle"),a=s.querySelector(".folder-name"),o=s.querySelector(".folder-remove-btn");return t&&n.classList.add("expanded"),a.textContent=e.name,o.setAttribute("aria-label",`Remove folder ${e.name}`),i.firstElementChild}_attachFolderEvents(e,t,i){e.querySelector(".playlist-folder-info").addEventListener("click",s=>{s.stopPropagation();t.classList.contains("hidden")?(t.classList.remove("hidden"),e.querySelector(".playlist-toggle").classList.add("expanded"),this.expandedFolders.add(i.path)):(t.classList.add("hidden"),e.querySelector(".playlist-toggle").classList.remove("expanded"),this.expandedFolders.delete(i.path))}),e.querySelector(".folder-remove-btn").addEventListener("click",e=>{e.stopPropagation(),confirm(`Delete folder "${i.name}" and all its contents?`)&&this.removeFolder(i.path)})}_createPlaylistItemElement(e){const t=this._createItemHTML(e,e.originalIndex).querySelector(".playlist-item");return this._attachItemEvents(t),t}_attachItemEvents(e){e.addEventListener("click",t=>{if(t.target.closest(".playlist-remove-btn")||t.target.closest(".playlist-download-btn"))return;const i=parseInt(e.dataset.index);this.selectItem(i)});const t=e.querySelector(".playlist-download-btn");t&&t.addEventListener("click",t=>{t.stopPropagation();const i=parseInt(e.dataset.index);this._downloadItem(i)});const i=e.querySelector(".playlist-remove-btn");i&&i.addEventListener("click",t=>{t.stopPropagation();const i=parseInt(e.dataset.index);this.removeItem(i)});const s=e.querySelector(".playlist-settings-btn");s&&s.addEventListener("click",t=>{t.stopPropagation();const i=parseInt(e.dataset.index);this._toggleSettingsMenu(i,s)})}_updateUI(){if(this.container.querySelectorAll(".playlist-item").forEach(e=>e.classList.remove("active")),this.activeIndex>=0){const e=this.container.querySelector(`.playlist-item[data-index="${this.activeIndex}"]`);e&&(e.classList.add("active"),e.scrollIntoView({behavior:"smooth",block:"nearest"}))}}removeFolder(e){const t=this.activeIndex>=0&&this.activeIndex<this.items.length?this.items[this.activeIndex]:null,i=this.items.length;if(this.items=this.items.filter(t=>{const i=t.path||"";return i!==e&&!i.startsWith(e+"/")}),this.items.length!==i){if(t){const e=this.items.indexOf(t);-1===e?(this.activeIndex=-1,this.player&&this.player.reset()):this.activeIndex=e}else this.activeIndex=-1;this._saveState(),this.render()}}_sanitizeFilename(e){let t=e.replace(/[<>:"/\\|?*]/g,"_");return t.match(/\.\w+$/)||(t+=".mp4"),t}async _downloadItem(e){if(e<0||e>=this.items.length)return;const t=this.items[e],i=this.container.querySelector(`[data-index="${e}"] .playlist-download-btn`);try{let e=t.title||"video";t.file&&t.file.name&&(e=t.file.name),e=this._sanitizeFilename(e);let s=t.url,n=null;if(!t.url.startsWith("blob:")){if(i){const e=document.getElementById("loading-spinner-template").content.cloneNode(!0);i.innerHTML="",i.appendChild(e),i.style.opacity="1"}console.log(`Fetching remote file: ${t.url}`);const e=await fetch(t.url);if(!e.ok)throw new Error(`Failed to fetch file: ${e.statusText}`);const a=await e.blob();n=URL.createObjectURL(a),s=n,i.style.opacity=""}const a=document.getElementById("mb-download-link");if(a.href=s,a.download=e,a.click(),n&&setTimeout(()=>URL.revokeObjectURL(n),100),console.log(`Downloading: ${e}`),i){const e=document.getElementById("playlist-item-template"),t=e.content.cloneNode(!0).querySelector(".playlist-download-btn svg").cloneNode(!0);i.innerHTML="",i.appendChild(t)}}catch(e){if(console.error("Download failed:",e),alert(`Failed to download video: ${e.message}\n\nThis may be due to CORS restrictions on the remote server.`),i){const e=document.getElementById("playlist-item-template").content.cloneNode(!0).querySelector(".playlist-download-btn svg").cloneNode(!0);i.innerHTML="",i.appendChild(e)}}}_createItemHTML(e,t){const i=document.getElementById("playlist-item-template").content.cloneNode(!0),s=i.querySelector(".playlist-item"),n=s.querySelector(".playlist-thumbnail"),a=s.querySelector(".playlist-title"),o=s.querySelector(".playlist-duration");if(s.dataset.index=t,s.setAttribute("aria-label",`Play ${e.title||"Unknown Video"}`),e.needsReload&&s.classList.add("needs-reload"),e.error&&s.classList.add("error"),e.thumbnail)n.innerHTML=`<img src="${e.thumbnail}" alt="${e.title}" loading="lazy">`;else{const e=document.getElementById("video-placeholder-template").content.cloneNode(!0);n.appendChild(e)}const l=e.title||"Unknown Video";if(a.textContent=l,a.setAttribute("title",l),e.needsReload){const e=document.getElementById("missing-file-status-template").content.cloneNode(!0);a.appendChild(e)}return o.textContent=e.duration||"--:--",i}_initUrlUpload(){const e=document.getElementById("mb-add-url");e?e.addEventListener("click",()=>{this._openUrlModal()}):console.warn("URL Upload button not found")}_openUrlModal(){const e=document.getElementById("url-upload-content-template"),t=document.getElementById("url-upload-footer-template");if(!e||!t)return;const i=new Modal({maxWidth:"500px"});i.setTitle("Add Video from URL"),i.setBody(e.content.cloneNode(!0)),i.setFooter(t.content.cloneNode(!0));const s=i.modal,n=s.querySelector("#url-input"),a=s.querySelector(".mb-modal-add"),o=s.querySelector(".mb-modal-cancel"),l=s.querySelector(".mb-modal-error"),r=s.querySelector(".mb-modal-loading");i.open(),setTimeout(()=>n.focus(),100),n.addEventListener("input",()=>{const e=this._isValidUrl(n.value);a.disabled=!e,l.style.display="none"}),a.addEventListener("click",async()=>{const e=n.value.trim();if(e){n.disabled=!0,a.disabled=!0,o.disabled=!0,i.closeBtn.disabled=!0,r.style.display="flex",l.style.display="none";try{await this._handleUrlUpload(e),i.close()}catch(e){n.disabled=!1,a.disabled=!1,o.disabled=!1,i.closeBtn.disabled=!1,r.style.display="none",l.textContent=e.message,l.style.display="block"}}}),o.addEventListener("click",()=>i.close()),n.addEventListener("keydown",e=>{"Enter"!==e.key||a.disabled||a.click(),"Escape"===e.key&&i.close()})}_isValidUrl(e){try{const t=new URL(e);return"http:"===t.protocol||"https:"===t.protocol}catch(e){return!1}}async _handleUrlUpload(e){try{const t=await fetch(e);if(!t.ok)throw new Error(`Failed to fetch video: ${t.statusText}`);const i=await t.blob();if(!i.type.startsWith("video/"))throw new Error("The URL does not point to a valid video file.");const s=new File([i],e.split("/").pop()||"remote-video.mp4",{type:i.type});this.handleFiles([s])}catch(e){if(e.message.includes("Failed to fetch"))throw new Error("CORS Error: Cannot access this URL. The server must allow cross-origin requests.");throw e}}_generateId(){return"undefined"!=typeof crypto&&crypto.randomUUID?crypto.randomUUID():"id-"+Date.now()+"-"+Math.random().toString(36).substr(2,9)}_toggleSettingsMenu(e,t){const i=document.querySelector(".playlist-context-menu"),s=i&&i.dataset.index==e;this._closeAllMenus(),s||this._createSettingsMenu(e,t)}_createSettingsMenu(e,t){const i=document.getElementById("playlist-settings-menu-template");if(!i)return;const s=i.content.cloneNode(!0).querySelector(".playlist-context-menu");s.dataset.index=e;this.items[e];if(e>=this.items.length-1){const e=s.querySelector('[data-action="merge"]');e&&(e.classList.add("disabled"),e.setAttribute("title","Cannot merge: Last item in playlist"))}else{const t=this.items[e+1],i=s.querySelector('[data-action="merge"]');i&&i.setAttribute("title",`Merge with "${t.title}"`)}s.querySelectorAll(".playlist-menu-item").forEach(t=>{t.addEventListener("click",i=>{if(i.stopPropagation(),t.classList.contains("disabled"))return;const s=t.dataset.action;this._handleMenuAction(s,e),this._closeAllMenus()})}),document.body.appendChild(s),this._positionSettingsMenu(s,t),requestAnimationFrame(()=>{s.classList.add("visible")})}_positionSettingsMenu(e,t){const i=t.getBoundingClientRect(),s=e.getBoundingClientRect(),n=window.innerHeight;window.innerWidth;let a=i.bottom+5,o=i.right-s.width;a+s.height>n-10&&(a=i.top-s.height-5),o<10&&(o=i.left),e.style.top=`${a}px`,e.style.left=`${o}px`}_closeAllMenus(){document.querySelectorAll(".playlist-context-menu").forEach(e=>{e.classList.remove("visible"),setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},200)})}_handleMenuAction(e,t){const i=this.items[t];switch(console.log(`Menu Action: ${e} on item "${i.title}" (Index: ${t})`),e){case"convert":this._openConversionModal(t);break;case"download-manage":this._openTrackManager(t);break;case"trim":this._openTrimModal(t);break;case"resize":case"info":case"merge":case"create-gif":alert(`Feature "${e}" coming in Phase 33+`)}}_openConversionModal(e){const t=this.items[e],i=document.getElementById("conversion-content-template"),s=document.getElementById("conversion-footer-template");if(console.log("Opening Conversion Modal",{index:e}),!i||!s)return void console.error("Conversion modal templates not found!");const n=new Modal({maxWidth:"500px"});n.setTitle("Convert & Optimize Video"),n.setBody(i.content.cloneNode(!0)),n.setFooter(s.content.cloneNode(!0));const a=n.modal,o=a.querySelector(".source-filename");o&&(o.textContent=t.title,o.title=t.title);const l=a.querySelector(".convert-btn"),r=a.querySelector(".download-btn"),d=a.querySelector(".progress-section"),c=a.querySelector(".progress-bar-fill"),h=a.querySelector(".progress-percentage"),m=a.querySelector(".success-message"),u=a.querySelector(".error-message"),p=a.querySelectorAll("input"),y=a.querySelector(".quality-slider"),v=a.querySelector(".quality-value"),g=a.querySelector(".estimated-reduction"),f=()=>{const e=parseInt(y.value);let t="Medium (60%)",i="~40% smaller";100===e?(t="Original (100%)",i="No size reduction"):80===e?(t="High (80%)",i="~20% smaller"):40===e&&(t="Low (40%)",i="~60% smaller"),v.textContent=t,g.textContent=i};y.addEventListener("input",f),f();const b=n.closeBtn.cloneNode(!0);n.closeBtn.parentNode.replaceChild(b,n.closeBtn),n.closeBtn=b,n.closeBtn.addEventListener("click",()=>{l.disabled&&!r.classList.contains("hidden")||n.close()});n.overlay.cloneNode(!0);const S=n.close.bind(n);n.close=()=>{l.disabled&&!r.classList.contains("hidden")||S()},l.addEventListener("click",async()=>{const i=a.querySelector('input[name="format"]:checked').value,s=a.querySelector('input[name="addToPlaylist"]').checked,o=parseInt(y.value);if("keep"===i&&100===o)return u.textContent="No changes selected. Please choose a different format or reduce quality.",void u.classList.remove("hidden");p.forEach(e=>e.disabled=!0),y.disabled=!0,l.disabled=!0,n.closeBtn.disabled=!0,d.classList.remove("hidden"),u.classList.add("hidden"),m.classList.add("hidden"),r.classList.add("hidden");try{await this._startConversion(e,i,o,s,e=>{const t=Math.round(100*e)+"%";c.style.width=t,h.textContent=t}),m.classList.remove("hidden"),d.classList.add("hidden"),r.classList.remove("hidden");const a="keep"===i?t.title.split(".").pop():i;r.title=`Download ${a.toUpperCase()}`,r.setAttribute("aria-label",`Download ${a.toUpperCase()}`),p.forEach(e=>{e.parentElement.classList.contains("disabled")||(e.disabled=!1)}),y.disabled=!1,l.disabled=!1,n.closeBtn.disabled=!1}catch(e){console.error("Conversion failed:",e),u.textContent=`Operation failed: ${e.message}`,u.classList.remove("hidden"),d.classList.add("hidden"),p.forEach(e=>{e.parentElement.classList.contains("disabled")||(e.disabled=!1)}),y.disabled=!1,l.disabled=!1,n.closeBtn.disabled=!1}}),n.open()}async _startConversion(e,t,i,s,n){const a=this.items[e];let o;if(a.file)o=a.file;else{const e=await fetch(a.url);o=await e.blob()}let l=t;if("keep"===t){l=a.title.split(".").pop().toLowerCase(),["mp4","webm","mov"].includes(l)||(console.warn(`Format ${l} not explicitly supported for writing, defaulting to MP4.`),l="mp4")}try{const e=await MediaProcessor.process({source:o,format:l,quality:i,onProgress:n});this._handleConversionSuccess(e,a,l,s)}catch(e){throw console.error("Conversion failed:",e),e}}_handleConversionSuccess(e,t,i,s){const n=t.title.replace(/\.[^/.]+$/,"")+`-converted.${i}`,a=URL.createObjectURL(e),o=document.querySelector(".conversion-modal .download-btn");if(o&&(o.href=a,o.download=n),s){const i={title:n,url:a,file:new File([e],n,{type:e.type}),duration:t.duration,type:"video"},s=this.items.indexOf(t);this.items.splice(s+1,0,i),this.render()}}async _openTrimModal(e){const t=this.items[e],i=document.getElementById("trim-content-template"),s=document.getElementById("trim-footer-template");if(!i||!s)return;const n=new Modal({maxWidth:"600px"});n.setTitle("Trim Video"),n.setBody(i.content.cloneNode(!0)),n.setFooter(s.content.cloneNode(!0));const a=n.modal;n.open();const o=a.querySelector(".trim-loading"),l=a.querySelector(".trim-content"),r=a.querySelector(".source-filename"),d=a.querySelector("#trim-start-input"),c=a.querySelector("#trim-end-input"),h=a.querySelector(".trim-duration"),m=a.querySelector(".total-duration"),u=a.querySelector(".timeline-slider"),p=a.querySelector(".timeline-range"),y=a.querySelector(".start-handle"),v=a.querySelector(".end-handle"),g=a.querySelector(".preview-btn"),f=a.querySelector(".stop-preview-btn"),b=a.querySelector('input[name="addToPlaylist"]'),S=a.querySelector(".trim-btn"),L=a.querySelector(".download-btn"),x=a.querySelector(".progress-section"),w=a.querySelector(".progress-bar-fill"),E=a.querySelector(".progress-percentage"),I=a.querySelector(".error-message"),k=a.querySelector(".success-message");S.disabled=!0;const _=e=>{const t=Math.floor(e/3600),i=Math.floor(e%3600/60),s=Math.floor(e%60);return`${t.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`},q=e=>{if("number"==typeof e)return e;const t=e.split(":").map(Number);return 3===t.length?3600*t[0]+60*t[1]+t[2]:2===t.length?60*t[0]+t[1]:0};r.textContent=t.title,r.title=t.title;let C=0;try{if(t.duration)C=q(t.duration);else{const e=document.createElement("video");e.preload="metadata",e.src=t.url||URL.createObjectURL(t.file),await new Promise(t=>{e.onloadedmetadata=()=>{C=e.duration,t()},e.onerror=()=>{console.warn("Could not load video metadata"),t()}})}}catch(e){console.error("Failed to get duration:",e),C=60}o.classList.add("hidden"),l.classList.remove("hidden"),S.disabled=!1,m.textContent=_(C);let P,M=0,T=C,N=!1;const B=()=>{document.activeElement!==d&&(d.value=_(M)),document.activeElement!==c&&(c.value=_(T));const e=Math.max(0,T-M);h.textContent=_(e);const t=M/C*100,i=T/C*100;y.style.left=`${t}%`,v.style.left=`${i}%`,p.style.left=`${t}%`,p.style.width=i-t+"%";const s=M<T&&T-M>=1;S.disabled=!s,s?I.classList.add("hidden"):(M>=T?I.textContent="Start time must be before end time.":T-M<1&&(I.textContent="Duration must be at least 1 second."),I.classList.remove("hidden"))};B();const $=(e,t)=>{const i=q(e.value);t?i>=0&&i<C&&(M=i):i>0&&i<=C&&(T=i),B()};d.addEventListener("change",()=>$(d,!0)),c.addEventListener("change",()=>$(c,!1));const U=(e,t)=>{e.addEventListener("mousedown",e=>{e.preventDefault();const i=e=>((e,t)=>{const i=u.getBoundingClientRect(),s=e.clientX-i.left,n=Math.max(0,Math.min(1,s/i.width))*C;t?n<T-1&&(M=n):n>M+1&&(T=n),B()})(e,t),s=()=>{document.removeEventListener("mousemove",i),document.removeEventListener("mouseup",s)};document.addEventListener("mousemove",i),document.addEventListener("mouseup",s)})};U(y,!0),U(v,!1),g.addEventListener("click",()=>{if(N)return;const e=document.querySelector("video");e&&(N=!0,g.classList.add("hidden"),f.classList.remove("hidden"),e.currentTime=M,e.play(),P=setInterval(()=>{e.currentTime>=T&&(e.currentTime=M)},100))}),f.addEventListener("click",()=>{if(!N)return;const e=document.querySelector("video");e&&e.pause(),N=!1,clearInterval(P),g.classList.remove("hidden"),f.classList.add("hidden")});const F=n.close.bind(n);n.close=()=>{N&&f.click(),F()},S.addEventListener("click",async()=>{N&&f.click(),a.classList.add("processing"),S.disabled=!0,n.closeBtn.disabled=!0,x.classList.remove("hidden"),I.classList.add("hidden"),k.classList.add("hidden");try{let e;if(t.file)e=t.file;else{const i=await fetch(t.url);e=await i.blob()}const i=await MediaProcessor.process({source:e,format:"mp4",quality:100,startTime:M,endTime:T,onProgress:e=>{const t=Math.round(100*e);w.style.width=`${t}%`,E.textContent=`${t}%`}});k.classList.remove("hidden");const s="mp4",a=t.title.replace(/\.[^/.]+$/,"")+`-trimmed-${Math.round(M)}-${Math.round(T)}.${s}`,o=URL.createObjectURL(i);if(L.href=o,L.download=a,L.classList.remove("hidden"),L.classList.remove("hidden"),b.checked){const e={id:Date.now().toString(),title:a,url:o,file:new File([i],a,{type:`video/${s}`}),duration:_(T-M),type:"video",isLocal:!0,isNew:!0},n=this.items.indexOf(t)+1;this.items.splice(n,0,e),this.render()}n.closeBtn.disabled=!1}catch(e){console.error("Trimming failed:",e),I.textContent=`Trimming failed: ${e.message}`,I.classList.remove("hidden"),S.disabled=!1,n.closeBtn.disabled=!1,x.classList.add("hidden")}})}async _openTrackManager(e){const t=this.items[e],i=document.getElementById("track-management-content-template");if(!i)return;const s=new Modal({maxWidth:"700px"});s.setTitle("Video & Audio Tracks"),s.setBody(i.content.cloneNode(!0));const n=s.modal;n.querySelector(".source-filename").textContent=`Source: ${t.title}`,s.open();try{let e;if(t.file)e=t.file;else{const i=await fetch(t.url);e=await i.blob()}const i=await MediaProcessor.getTracks(e);n.querySelector(".tracks-loading").classList.add("hidden"),n.querySelector(".tracks-content").classList.remove("hidden"),this._renderTracks(i,t,n)}catch(e){console.error("Failed to load tracks:",e),n.querySelector(".tracks-loading").classList.add("hidden"),n.querySelector(".mb-modal-body").insertAdjacentHTML("beforeend",`<div class="p-md text-danger">Failed to load tracks: ${e.message}</div>`)}}_renderTracks(e,t,i){const s=i.querySelector(".video-track-list"),n=i.querySelector(".audio-track-list"),a=i.querySelector(".video-tracks-section .track-count"),o=i.querySelector(".audio-tracks-section .track-count"),l=i.querySelector(".video-tracks-section .no-tracks-message"),r=i.querySelector(".audio-tracks-section .no-tracks-message");a.textContent=e.video.length,o.textContent=e.audio.length,0===e.video.length&&l.classList.remove("hidden"),0===e.audio.length&&r.classList.remove("hidden");const d=document.getElementById("track-card-template"),c=(e,i,s)=>{e.forEach((e,n)=>{const a=d.content.cloneNode(!0).querySelector(".track-card");a.querySelector(".track-index").textContent=n+1,a.querySelector(".meta-codec").textContent=e.codecString||e.codec||"Unknown",a.querySelector(".meta-language").textContent=e.language||"und";let o="";o="video"===s?`${e.width}x${e.height}`:`${e.channels}ch, ${e.sampleRate}Hz`,a.querySelector(".meta-details").textContent=o;const l=a.querySelector(".download-track-btn"),r=a.querySelector(".add-to-playlist-btn"),c=a.querySelector(".progress-container");let h="mp4";if("audio"===s){const t=(e.codec||"").toLowerCase();h=t.includes("mp3")?"mp3":t.includes("aac")||t.includes("mp4a")?"aac":t.includes("pcm")||""===t?"wav":"m4a"}l.addEventListener("click",()=>{this._extractTrack(this.items.indexOf(t),n,s,h,!1,c,l,r)}),r.addEventListener("click",()=>{const e=h,i=`${t.title.replace(/\.[^/.]+$/,"")}-${s}-track${n+1}.${e}`;this.items.some(e=>e.title===i)?alert(`Track "${i}" is already in the playlist.`):this._extractTrack(this.items.indexOf(t),n,s,h,!0,c,l,r)}),i.appendChild(a)})};c(e.video,s,"video"),c(e.audio,n,"audio")}async _extractTrack(e,t,i,s,n,a,o,l){const r=this.items[e];o.classList.add("hidden"),l.classList.add("hidden"),a.classList.remove("hidden");try{let e;if(r.file)e=r.file;else{const t=await fetch(r.url);e=await t.blob()}const a=await MediaProcessor.extractTrack({source:e,trackIndex:t,trackType:i,format:s,onProgress:e=>{}});this._handleExtractionSuccess(a,r,i,t,s,n)}catch(e){console.error("Extraction failed:",e),alert(`Extraction failed: ${e.message}`)}finally{o.classList.remove("hidden"),l.classList.remove("hidden"),a.classList.add("hidden")}}_handleExtractionSuccess(e,t,i,s,n,a){const o=n,l=`${t.title.replace(/\.[^/.]+$/,"")}-${i}-track${s+1}.${o}`,r=URL.createObjectURL(e);if(a){const s={title:l,url:r,file:new File([e],l,{type:e.type}),duration:t.duration,type:"video"===i?"video":"audio",isAudioOnly:"audio"===i},n=this.items.indexOf(t);this.items.splice(n+1,0,s),this.render(),setTimeout(()=>{const e=this.container.querySelector(`[data-index="${n+1}"]`);e&&e.scrollIntoView({behavior:"smooth",block:"nearest"})},100)}else{const e=document.createElement("a");e.href=r,e.download=l,document.body.appendChild(e),e.click(),document.body.removeChild(e)}}}