export class ScreenshotManager{constructor(t){this.player=t,this.wasPlayingBeforeCapture=!1,this.screenshotDataUrl=null,this.screenshotTimestamp=null,this.ui={btn:null,modal:null,preview:null,timestamp:null,downloadBtn:null,cancelBtn:null,closeBtn:null,prevBtn:null,nextBtn:null}}init(){this._createUI(),this._cacheElements(),this._attachEvents()}_createUI(){const t=this.player.container.querySelector("#mb-fullscreen-btn");if(t){const e=document.getElementById("screenshot-button-template").content.cloneNode(!0);t.parentNode.insertBefore(e,t)}const e=document.getElementById("screenshot-modal-template").content.cloneNode(!0);document.body.appendChild(e)}_cacheElements(){const t=this.player.container;this.ui.btn=t.querySelector("#mb-screenshot-btn"),this.ui.modal=document.querySelector(".jellyjump-screenshot-modal"),this.ui.modal&&(this.ui.preview=this.ui.modal.querySelector("#mb-screenshot-preview"),this.ui.timestamp=this.ui.modal.querySelector("#mb-screenshot-timestamp"),this.ui.downloadBtn=this.ui.modal.querySelector("#mb-screenshot-download"),this.ui.cancelBtn=this.ui.modal.querySelector("#mb-screenshot-cancel"),this.ui.closeBtn=this.ui.modal.querySelector("#mb-screenshot-close"),this.ui.prevBtn=this.ui.modal.querySelector("#mb-screenshot-prev"),this.ui.nextBtn=this.ui.modal.querySelector("#mb-screenshot-next"))}_attachEvents(){this.ui.btn&&this.ui.btn.addEventListener("click",()=>this.capture()),this.ui.downloadBtn&&this.ui.downloadBtn.addEventListener("click",()=>this.download()),this.ui.cancelBtn&&this.ui.cancelBtn.addEventListener("click",()=>this.closeModal()),this.ui.closeBtn&&this.ui.closeBtn.addEventListener("click",()=>this.closeModal()),this.ui.prevBtn&&this.ui.prevBtn.addEventListener("click",()=>this.captureAdjacentFrame(-1)),this.ui.nextBtn&&this.ui.nextBtn.addEventListener("click",()=>this.captureAdjacentFrame(1)),this.ui.modal&&this.ui.modal.addEventListener("click",t=>{t.target===this.ui.modal&&this.closeModal()})}async capture(){const t=this.player.isStreamMode,e=this.player.videoSink&&this.player.videoTrack,s=this.player.canvas&&this.player.ctx;if(e||s)try{let i,a;if(this.wasPlayingBeforeCapture=this.player.isPlaying,this.player.isPlaying&&this.player.pause(),t&&s)i=this.player.canvas.toDataURL("image/png"),a=this.player.currentTime||0,console.log("[Screenshot] Captured from stream canvas");else{if(!e)return void console.error("No capture method available");{const t=await this.player.videoSink.getCanvas(this.player.currentTime);if(!t||!t.canvas)return void console.error("Failed to capture frame");i=t.canvas.toDataURL("image/png"),a=t.timestamp}}this.showModal(i,a)}catch(t){console.error("Error capturing frame:",t)}else console.warn("No video loaded")}async captureAdjacentFrame(t){if(this.player.videoSink&&this.player.videoTrack)try{const e=1/(this.player.frameRate||30);let s=(this.screenshotTimestamp||this.player.currentTime)+t*e;s=Math.max(0,Math.min(this.player.duration,s));const i=await this.player.videoSink.getCanvas(s);if(!i||!i.canvas)return void console.error("Failed to capture adjacent frame");const a=i.canvas.toDataURL("image/png");this.ui.preview.src=a,this.screenshotDataUrl=a,this.screenshotTimestamp=i.timestamp;const n=this._formatTime(i.timestamp);this.ui.timestamp.textContent=`at ${n}`}catch(t){console.error("Error capturing adjacent frame:",t)}}showModal(t,e){if(!this.ui.modal)return;this.ui.preview.src=t,this.screenshotDataUrl=t,this.screenshotTimestamp=e;const s=this._formatTime(e);this.ui.timestamp.textContent=`at ${s}`,document.body.style.overflow="hidden",this.ui.modal.style.display="flex"}closeModal(){this.ui.modal&&(this.ui.modal.style.display="none",document.body.style.overflow="",this.ui.preview.src="",this.screenshotDataUrl=null,this.screenshotTimestamp=null,this.wasPlayingBeforeCapture&&(this.player.play(),this.wasPlayingBeforeCapture=!1))}download(){if(this.screenshotDataUrl)try{const t=`screenshot-${Math.floor(this.screenshotTimestamp||this.player.currentTime)}s.png`,e=document.getElementById("mb-download-link");e.href=this.screenshotDataUrl,e.download=t,e.click(),this.closeModal()}catch(t){console.error("Error downloading screenshot:",t)}}isModalOpen(){return this.ui.modal&&"none"!==this.ui.modal.style.display}_formatTime(t){const e=Math.floor(t/60),s=Math.floor(t%60);return`${e}:${s<10?"0":""}${s}`}}