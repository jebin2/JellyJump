export class IndexedDBService{constructor(){this.DB_NAME="JellyJumpDB",this.DB_VERSION=1,this.STORES={PLAYLIST:"playlist",FILES:"files",STATE:"state"},this.db=null,this.initPromise=this._init()}_init(){return new Promise((e,t)=>{const i=indexedDB.open(this.DB_NAME,this.DB_VERSION);i.onerror=e=>{console.error("IndexedDB error:",e.target.error),t(e.target.error)},i.onsuccess=t=>{this.db=t.target.result,e(this.db)},i.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains(this.STORES.PLAYLIST)||t.createObjectStore(this.STORES.PLAYLIST,{keyPath:"id"}),t.objectStoreNames.contains(this.STORES.FILES)||t.createObjectStore(this.STORES.FILES,{keyPath:"id"}),t.objectStoreNames.contains(this.STORES.STATE)||t.createObjectStore(this.STORES.STATE,{keyPath:"key"})}})}async ready(){return this.db||await this.initPromise,this.db}async _ensureConnection(){await this.ready(),this.db||(console.warn("[IndexedDB] Connection not available, reinitializing..."),this.initPromise=this._init(),await this.initPromise)}async _withTransaction(e,t,i){return await this._ensureConnection(),new Promise((r,o)=>{try{const s=this.db.transaction(e,t);i(s,r,o)}catch(s){"InvalidStateError"===s.name?(console.warn("[IndexedDB] Connection was closing, reinitializing and retrying..."),this.db=null,this.initPromise=this._init(),this.initPromise.then(()=>{this._withTransaction(e,t,i).then(r).catch(o)}).catch(o)):o(s)}})}async savePlaylist(e){return this._withTransaction([this.STORES.PLAYLIST,this.STORES.FILES],"readwrite",(t,i,r)=>{t.oncomplete=()=>{e.length>0?localStorage.setItem(this.DB_NAME+"-playlist","true"):localStorage.removeItem(this.DB_NAME+"-playlist");for(const t of e)t.isLocal&&t.file&&(console.log(`[IndexedDB] Releasing memory for persisted file: ${t.title}`),t.file=null);i()},t.onerror=e=>r(e.target.error);const o=t.objectStore(this.STORES.PLAYLIST),s=t.objectStore(this.STORES.FILES);o.clear(),e.forEach(e=>{const t={id:e.id,title:e.title,duration:e.duration,thumbnail:e.thumbnail,isLocal:e.isLocal,isRemoteUrl:e.isRemoteUrl,path:e.path,url:e.isRemoteUrl||!e.isLocal?e.url:"",originalIndex:e.originalIndex,fileSize:e.fileSize,fileType:e.fileType,mimeType:e.mimeType,localPath:e.localPath};if(o.put(t),e.isLocal&&e.file){const t=524288e3;e.file.size<t?s.put({id:e.id,blob:e.file,name:e.file.name||e.title,type:e.file.type}):console.warn(`[IndexedDB] File ${e.title} too large to persist (${(e.file.size/1024/1024).toFixed(2)} MB)`)}})})}async loadPlaylist(){return this._withTransaction([this.STORES.PLAYLIST],"readonly",(e,t,i)=>{const r=e.objectStore(this.STORES.PLAYLIST).getAll();r.onsuccess=()=>{const e=r.result.map(e=>{const t={...e};return t.isLocal&&!t.isRemoteUrl&&(t.file=null,t.url=null,t.needsReload=!1),t});t(e)},r.onerror=()=>i(r.error)})}async loadFile(e){return this._withTransaction([this.STORES.FILES],"readonly",(t,i,r)=>{const o=t.objectStore(this.STORES.FILES).get(e);o.onsuccess=()=>{const e=o.result;if(e){const t=new File([e.blob],e.name,{type:e.type});i(t)}else i(null)},o.onerror=()=>r(o.error)})}async saveFile(e,t,i,r){return t.size>524288e3?(console.warn(`[IndexedDB] File too large to save: ${(t.size/1024/1024).toFixed(2)} MB`),!1):this._withTransaction([this.STORES.FILES],"readwrite",(o,s,n)=>{o.objectStore(this.STORES.FILES).put({id:e,blob:t,name:i,type:r}),o.oncomplete=()=>{console.log(`[IndexedDB] File saved: ${i} (${(t.size/1024/1024).toFixed(2)} MB)`),s(!0)},o.onerror=()=>n(o.error)})}async savePlaybackState(e){return this._withTransaction([this.STORES.STATE],"readwrite",(t,i,r)=>{t.objectStore(this.STORES.STATE).put({key:"playback",...e}),t.oncomplete=()=>i(),t.onerror=()=>r(t.error)})}async loadPlaybackState(){return this._withTransaction([this.STORES.STATE],"readonly",(e,t,i)=>{const r=e.objectStore(this.STORES.STATE).get("playback");r.onsuccess=()=>t(r.result),r.onerror=()=>i(r.error)})}async clear(){return this._withTransaction([this.STORES.PLAYLIST,this.STORES.FILES,this.STORES.STATE],"readwrite",(e,t)=>{e.objectStore(this.STORES.PLAYLIST).clear(),e.objectStore(this.STORES.FILES).clear(),e.objectStore(this.STORES.STATE).clear(),e.oncomplete=()=>{localStorage.removeItem(this.DB_NAME+"-playlist"),t()}})}}