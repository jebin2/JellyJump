export class AudioVisualizer{constructor(t){this.canvas=t,this.ctx=t.getContext("2d"),this.analyser=null,this.dataArray=null,this.animationId=null,this.isRunning=!1,this.raindrops=[],this.maxRaindrops=200,this.smoothing=.8,this.bassLevel=0,this.midLevel=0,this.highLevel=0,this.simulatedMode=!1,this.simulatedTime=0,this.lightningAlpha=0,this.lastBassLevel=0,this.lightningThreshold=.7,this.clouds=[],this.trees=[],this.cloudsInitialized=!1,console.log("[AudioVisualizer] Created for canvas:",t.width,"x",t.height)}connect(t,i){this.analyser=t.createAnalyser(),this.analyser.fftSize=256,this.analyser.smoothingTimeConstant=this.smoothing,i.connect(this.analyser),this.analyser.connect(t.destination);const s=this.analyser.frequencyBinCount;this.dataArray=new Uint8Array(s),this._initRaindrops(),this.ripples=[],console.log("[AudioVisualizer] Connected - Rain mode with depth layers")}_initRaindrops(){this.raindrops=[];[{count:60,speedMult:.5,opacityMult:.4,thicknessMult:.6},{count:80,speedMult:1,opacityMult:.7,thicknessMult:1},{count:60,speedMult:1.5,opacityMult:1,thicknessMult:1.3}].forEach((t,i)=>{for(let s=0;s<t.count;s++)this.raindrops.push(this._createRaindrop(t,i))})}_createRaindrop(t={},i=1){const s=t.speedMult||1,h=t.opacityMult||1,a=t.thicknessMult||1;return{x:Math.random()*this.canvas.width,y:Math.random()*this.canvas.height-this.canvas.height,speed:(2+3*Math.random())*s,length:(10+20*Math.random())*(.7+.15*i),opacity:(.2+.5*Math.random())*h,thickness:(1+2*Math.random())*a,layer:i}}start(){this.isRunning||(this.analyser||(this.simulatedMode=!0,console.log("[AudioVisualizer] Starting in simulated mode")),this.isRunning=!0,this._initRaindrops(),this._animate(),console.log("[AudioVisualizer] Started"))}stop(){this.isRunning=!1,this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null),console.log("[AudioVisualizer] Stopped")}_animate(){this.isRunning&&(this.animationId=requestAnimationFrame(()=>this._animate()),this._updateAudioLevels(),this._draw())}_updateAudioLevels(){if(this.simulatedMode||!this.analyser){this.simulatedTime+=.05;const t=(Math.sin(this.simulatedTime)+1)/2,i=(Math.sin(1.5*this.simulatedTime)+1)/2,s=(Math.sin(2.2*this.simulatedTime)+1)/2;return this.bassLevel=.3+.5*t,this.midLevel=.2+.4*i,void(this.highLevel=.1+.3*s)}this.analyser.getByteFrequencyData(this.dataArray);const t=this.dataArray.length;let i=0,s=0,h=0;const a=Math.floor(.15*t),e=Math.floor(.5*t);for(let n=0;n<t;n++)n<a?i+=this.dataArray[n]:n<e?s+=this.dataArray[n]:h+=this.dataArray[n];this.bassLevel=i/(255*a)*1.5,this.midLevel=s/(255*(e-a)),this.highLevel=h/(255*(t-e))}_draw(){const t=this.canvas.width,i=this.canvas.height,s=this.bassLevel>this.lightningThreshold&&this.bassLevel>this.lastBassLevel+.2;this.lastBassLevel=this.bassLevel,s&&(this.lightningAlpha=.8+.2*Math.random());const h=this.ctx.createLinearGradient(0,0,0,i);h.addColorStop(0,"#050510"),h.addColorStop(.4,"#0a0a1a"),h.addColorStop(1,"#151525"),this.ctx.fillStyle=h,this.ctx.fillRect(0,0,t,i),this.cloudsInitialized&&0!==this.clouds.length||this._initCloudsAndTrees(t,i),this._drawClouds(t,i),this._drawTrees(t,i);const a=1+4*this.bassLevel,e=(this.bassLevel+this.midLevel+this.highLevel)/3,n=this.raindrops.length;for(let s=0;s<n;s++){const h=this.raindrops[s];h.y+=h.speed*a,h.x+=2*(this.midLevel-.5)*(2===h.layer?1.5:1),h.y>i&&(h.layer>=1&&Math.random()>.5&&this.ripples.push({x:h.x,y:i-5,radius:2,maxRadius:15+10*Math.random(),opacity:.6+.3*e}),h.y=-h.length,h.x=Math.random()*t),h.x<0&&(h.x=t),h.x>t&&(h.x=0),this._drawRaindrop(h,e)}this._updateAndDrawRipples(),this._drawGroundEffect(e),this.lightningAlpha>0&&(this._drawLightning(t,i),this.lightningAlpha*=.85,this.lightningAlpha<.05&&(this.lightningAlpha=0))}_drawRaindrop(t,i){const s=200+40*i,h=t.opacity*(.5+.5*i);this.ctx.beginPath(),this.ctx.strokeStyle=`hsla(${s}, 80%, 60%, ${h})`,this.ctx.lineWidth=t.thickness,this.ctx.lineCap="round",this.ctx.moveTo(t.x,t.y),this.ctx.lineTo(t.x,t.y+t.length),this.ctx.stroke()}_updateAndDrawRipples(){this.canvas.height;for(let t=this.ripples.length-1;t>=0;t--){const i=this.ripples[t];i.radius+=.8,i.opacity*=.92,i.opacity<.05||i.radius>i.maxRadius?this.ripples.splice(t,1):(this.ctx.beginPath(),this.ctx.ellipse(i.x,i.y,i.radius,.3*i.radius,0,0,2*Math.PI),this.ctx.strokeStyle=`rgba(150, 200, 255, ${i.opacity})`,this.ctx.lineWidth=1.5,this.ctx.stroke())}this.ripples.length>50&&(this.ripples=this.ripples.slice(-50))}_initCloudsAndTrees(t,i){this.clouds=[];const s=8+Math.floor(5*Math.random());for(let h=0;h<s;h++)this.clouds.push({x:Math.random()*t*1.5-.25*t,y:Math.random()*i*.25,width:100+150*Math.random(),height:30+40*Math.random(),speed:.2+.3*Math.random(),opacity:.3+.3*Math.random()});this.trees=[];const h=12+Math.floor(8*Math.random());for(let i=0;i<h;i++)this.trees.push({x:i/h*t+80*(Math.random()-.5),height:60+100*Math.random(),width:20+30*Math.random(),type:Math.random()>.5?"pine":"round"});this.cloudsInitialized=!0}_drawClouds(t,i){for(const i of this.clouds)i.x+=i.speed*(1+.5*this.midLevel),i.x>t+i.width&&(i.x=-i.width),this.ctx.fillStyle=`rgba(30, 35, 50, ${i.opacity})`,this.ctx.beginPath(),this.ctx.ellipse(i.x,i.y,i.width/2,i.height/2,0,0,2*Math.PI),this.ctx.fill(),this.ctx.beginPath(),this.ctx.ellipse(i.x-.3*i.width,i.y+5,.3*i.width,.4*i.height,0,0,2*Math.PI),this.ctx.fill(),this.ctx.beginPath(),this.ctx.ellipse(i.x+.25*i.width,i.y+8,.35*i.width,.35*i.height,0,0,2*Math.PI),this.ctx.fill()}_drawTrees(t,i){const s=i-5;for(const t of this.trees)if(this.ctx.fillStyle="rgba(10, 12, 20, 0.9)","pine"===t.type)this.ctx.beginPath(),this.ctx.moveTo(t.x,s-t.height),this.ctx.lineTo(t.x-t.width/2,s),this.ctx.lineTo(t.x+t.width/2,s),this.ctx.closePath(),this.ctx.fill(),this.ctx.beginPath(),this.ctx.moveTo(t.x,s-1.1*t.height),this.ctx.lineTo(t.x-.35*t.width,s-.4*t.height),this.ctx.lineTo(t.x+.35*t.width,s-.4*t.height),this.ctx.closePath(),this.ctx.fill();else{const i=.2*t.width;this.ctx.fillRect(t.x-i/2,s-.4*t.height,i,.4*t.height),this.ctx.beginPath(),this.ctx.arc(t.x,s-.6*t.height,.4*t.width,0,2*Math.PI),this.ctx.fill()}}_drawGroundEffect(t){const i=this.canvas.width,s=this.canvas.height,h=60+40*t,a=this.ctx.createLinearGradient(0,s,0,s-h);if(a.addColorStop(0,`rgba(50, 150, 255, ${.1+.2*t})`),a.addColorStop(1,"transparent"),this.ctx.fillStyle=a,this.ctx.fillRect(0,s-h,i,h),t>.3){const h=Math.floor(10*t);for(let a=0;a<h;a++){const h=Math.random()*i,a=s-5-15*Math.random(),e=1+2*Math.random();this.ctx.beginPath(),this.ctx.arc(h,a,e,0,2*Math.PI),this.ctx.fillStyle=`rgba(100, 200, 255, ${.2+.3*t})`,this.ctx.fill()}}}_drawLightning(t,i){const s=this.ctx.createRadialGradient(t/2,i/3,0,t/2,i/3,Math.max(t,i));s.addColorStop(0,`rgba(255, 255, 255, ${this.lightningAlpha})`),s.addColorStop(.3,`rgba(200, 220, 255, ${.7*this.lightningAlpha})`),s.addColorStop(1,`rgba(100, 150, 255, ${.2*this.lightningAlpha})`),this.ctx.fillStyle=s,this.ctx.fillRect(0,0,t,i),this.lightningAlpha>.5&&this._drawLightningBolt(t,i)}_drawLightningBolt(t,i){const s=t*(.3+.4*Math.random()),h=.6*i;this.ctx.beginPath(),this.ctx.strokeStyle=`rgba(255, 255, 255, ${this.lightningAlpha})`,this.ctx.lineWidth=2+2*Math.random(),this.ctx.lineCap="round",this.ctx.lineJoin="round";let a=s,e=0;this.ctx.moveTo(a,e);const n=8+Math.floor(5*Math.random()),l=h/n;for(let t=0;t<n;t++)if(a+=60*(Math.random()-.5),e+=l,this.ctx.lineTo(a,e),Math.random()>.7){const t=a+80*(Math.random()-.5),i=e+.5*l;this.ctx.moveTo(a,e),this.ctx.lineTo(t,i),this.ctx.moveTo(a,e)}this.ctx.stroke(),this.ctx.shadowColor="rgba(150, 200, 255, 0.8)",this.ctx.shadowBlur=20,this.ctx.stroke(),this.ctx.shadowBlur=0}disconnect(){this.stop(),this.analyser&&(this.analyser.disconnect(),this.analyser=null),this.dataArray=null,this.raindrops=[],console.log("[AudioVisualizer] Disconnected")}drawStaticBackground(){const t=this.canvas.width,i=this.canvas.height,s=this.ctx.createRadialGradient(t/2,i/2,0,t/2,i/2,Math.max(t,i)/2);s.addColorStop(0,"#1a1a2e"),s.addColorStop(1,"#0a0a12"),this.ctx.fillStyle=s,this.ctx.fillRect(0,0,t,i);for(let s=0;s<50;s++){const s=Math.random()*t,h=Math.random()*i,a=10+15*Math.random();this.ctx.beginPath(),this.ctx.strokeStyle=`rgba(100, 180, 255, ${.1+.2*Math.random()})`,this.ctx.lineWidth=1,this.ctx.moveTo(s,h),this.ctx.lineTo(s,h+a),this.ctx.stroke()}this.ctx.save(),this.ctx.translate(t/2,i/2-20),this.ctx.fillStyle="rgba(100, 200, 255, 0.6)",this.ctx.font=Math.min(t,i)/4+"px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("â™ª",0,0),this.ctx.restore(),this.ctx.fillStyle="rgba(150, 200, 255, 0.5)",this.ctx.font="14px sans-serif",this.ctx.textAlign="center",this.ctx.fillText("Press play to start",t/2,i/2+50)}}