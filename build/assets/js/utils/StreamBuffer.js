export class StreamBuffer{constructor(){this.segments=[],this.totalBytes=0,this.maxBytes=104857600,this.isCapturing=!1,this.onSegmentAdded=null,this.onBufferFull=null}getHLSConfig(){const t=this;return{enableWorker:!0,lowLatencyMode:!0,backBufferLength:90,maxBufferLength:30,maxMaxBufferLength:60,startLevel:-1,xhrSetup:(e,s)=>{if(t.isCapturing&&(s.includes(".ts")||s.includes(".m4s"))){const n=e.onload;e.onload=function(){e.response&&e.response instanceof ArrayBuffer&&t._addSegment({url:s,data:new Uint8Array(e.response),timestamp:Date.now()}),n&&n.apply(this,arguments)}}}}}startCapture(){this.isCapturing=!0,console.log("[StreamBuffer] Capture started")}stopCapture(){this.isCapturing=!1,console.log("[StreamBuffer] Capture stopped")}_addSegment(t){this.segments.some(e=>e.url===t.url)||(this.segments.push(t),this.totalBytes+=t.data.byteLength,console.log(`[StreamBuffer] Captured segment: ${(t.data.byteLength/1024).toFixed(1)}KB. Total: ${this.segments.length} segments, ${(this.totalBytes/1024/1024).toFixed(2)}MB`),this._trimBuffer(),this.onSegmentAdded&&this.onSegmentAdded(t,this.segments.length,this.totalBytes))}_trimBuffer(){for(;this.totalBytes>this.maxBytes&&this.segments.length>1;){const t=this.segments.shift();this.totalBytes-=t.data.byteLength,console.log(`[StreamBuffer] Trimmed segment, buffer now ${(this.totalBytes/1024/1024).toFixed(2)}MB`)}}toBlob(){if(0===this.segments.length)return null;const t=this.segments.map(t=>t.data),e=new Blob(t,{type:"video/mp2t"});return console.log(`[StreamBuffer] Created blob: ${(e.size/1024/1024).toFixed(2)}MB from ${this.segments.length} segments`),e}toBlobURL(){const t=this.toBlob();return t?URL.createObjectURL(t):null}hasEnoughData(){return this.segments.length>=3}getStats(){return{segmentCount:this.segments.length,totalBytes:this.totalBytes,totalMB:(this.totalBytes/1024/1024).toFixed(2),isCapturing:this.isCapturing,hasEnoughData:this.hasEnoughData()}}clear(){this.segments=[],this.totalBytes=0,console.log("[StreamBuffer] Buffer cleared")}setMaxSize(t){this.maxBytes=1024*t*1024,this._trimBuffer()}}