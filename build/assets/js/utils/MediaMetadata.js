import{MediaBunny}from"../core/MediaBunny.js";import{MediaProcessor}from"../core/MediaProcessor.js";import{IndexedDBService}from"../player/IndexedDBService.js";import{formatDuration}from"./mediaUtils.js";import{ElectronHelper}from"./ElectronHelper.js";const _dbService=new IndexedDBService;export class MediaMetadata{static async processMetadata(e,t,a){for(const o of e)if(o.isLocal&&o.file){o.duration="Loading...",t&&t(o);try{await this.ensureMetadata(o,a),t&&t(o),a&&a()}catch(e){console.warn("Failed to load metadata for",o.title,e),o.duration="--:--",t&&t(o)}}}static async checkCache(e){if(!e.id)return null;try{const t=await _dbService.loadFile(e.id);if(t)return console.log("[Cache] Found in cache:",e.title),t}catch(e){console.warn("[Cache] Error checking cache:",e)}return null}static async cacheInBackground(e,t){if(e.url&&e.id){console.log("[Cache] Starting background cache for:",e.title);try{if(await this.checkCache(e))return void console.log("[Cache] Item already cached, skipping download:",e.title);const a=await fetch(e.url);if(!a.ok)throw new Error(`Failed to fetch: ${a.statusText}`);const o=await a.blob(),i=o.size/1024/1024;if(i>500)return void console.warn(`[Cache] Video too large to cache (${i.toFixed(2)} MB)`);const r=e.title||"video";await _dbService.saveFile(e.id,o,r,o.type)&&(console.log("[Cache] Successfully cached in background:",e.title),t&&t())}catch(e){console.warn("[Cache] Background caching failed:",e)}}}static async getSourceBlob(e,t){if(e.file)return e.file;if(ElectronHelper.isElectron()&&e.localPath){if(!await ElectronHelper.fileExists(e.localPath))throw new Error("File no longer exists at path: "+e.localPath);const t=await ElectronHelper.readFileAsBlob(e.localPath,e.mimeType);if(!t)throw new Error("Failed to read file from disk");return t}const a=await this.checkCache(e);if(a)return a;if(e.url){console.log("[Cache] Fetching remote video (blocking):",e.title);const a=await fetch(e.url);if(!a.ok)throw new Error(`Failed to fetch video: ${a.statusText}`);const o=await a.blob(),i=o.size/1024/1024;if(i>500)return console.warn(`[Cache] Video too large to cache (${i.toFixed(2)} MB)`),o;if(e.id){const a=e.title||"video";await _dbService.saveFile(e.id,o,a,o.type)&&(t&&t(),console.log("[Cache] Blob persisted to IndexedDB:",e.title))}return o}throw new Error("No source available for item")}static async getProcessedSourceURL(e,t){if(e.blob_url&&e.blob_url.startsWith("blob:"))return e.blob_url;const a=await this.getSourceBlob(e,t);return e.blob_url=URL.createObjectURL(a),e.blob_url}static async ensureMetadata(e,t){if(e.videoInfo||e.audioInfo)return;const a=await MediaMetadata.getProcessedSourceURL(e,t),{videoInfo:o,audioInfo:i,duration:r,videoTracks:n,audioTracks:c}=await MediaProcessor.getMetadata(a);e.videoInfo=o,e.audioInfo=i,e.videoTracks=n,e.audioTracks=c,e.duration&&"--:--"!==e.duration&&"Loading..."!==e.duration||(e.duration=formatDuration(r)),t&&t()}static async getVideoDuration(e){try{const t=e instanceof File?new MediaBunny.BlobSource(e):new MediaBunny.UrlSource(e),a=new MediaBunny.Input({source:t,formats:MediaBunny.ALL_FORMATS});return await a.computeDuration()}catch(e){return console.error("Error getting video duration:",e),0}}static async getFormattedMetadata(e,t){const a=new MediaBunny.Input({source:new MediaBunny.BlobSource(e),formats:MediaBunny.ALL_FORMATS}),o=await a.getFormat(),i=(await a.getTracks(),await a.getPrimaryVideoTrack()),r=await a.getPrimaryAudioTrack(),n=e=>e?e.toUpperCase():"N/A";var c;return{metadata:{filename:t,format:o?o.name:"Unknown",mimeType:o?o.mimeType:e.type,size:((e,t=1)=>{if(0===e)return"0 Bytes";const a=t<0?0:t,o=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,o)).toFixed(a))+" "+["Bytes","KB","MB","GB","TB"][o]})(e.size),duration:(c=i?await i.computeDuration():r?await r.computeDuration():0,[Math.floor(c/3600),Math.floor(c%3600/60),Math.floor(c%60)].map(e=>e<10?"0"+e:e).filter((e,t)=>"00"!==e||t>0).join(":")),videoCodec:i?n(i.codec):"N/A",videoCodecString:i?await i.getCodecParameterString():"N/A",resolution:i?`${i.displayWidth}x${i.displayHeight}`:"N/A",codedResolution:i?`${i.codedWidth}x${i.codedHeight}`:"N/A",fps:"Calculating...",videoBitrate:"Calculating...",rotation:i?`${i.rotation}Â°`:"N/A",hdr:i?await i.hasHighDynamicRange()?"Yes":"No":"N/A",audioCodec:r?n(r.codec):"N/A",audioCodecString:r?await r.getCodecParameterString():"N/A",channels:r?2===r.numberOfChannels?"Stereo (2)":`${r.numberOfChannels} Channels`:"N/A",sampleRate:r?`${(r.sampleRate/1e3).toFixed(1)} kHz`:"N/A",language:r?"und"===r.languageCode?"Undetermined":r.languageCode:"N/A"},videoTrack:i}}}