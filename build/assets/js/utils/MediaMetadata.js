import{MediaBunny}from"../core/MediaBunny.js";import{MediaProcessor}from"../core/MediaProcessor.js";import{IndexedDBService}from"../player/IndexedDBService.js";import{formatDuration}from"./mediaUtils.js";import{ElectronHelper}from"./ElectronHelper.js";const _dbService=new IndexedDBService;export class MediaMetadata{static async processMetadata(e,o,t){for(const a of e)if(a.isLocal&&a.file){a.duration="Loading...",o&&o(a);try{await this.ensureMetadata(a,t),o&&o(a),t&&t()}catch(e){console.warn("Failed to load metadata for",a.title,e),a.duration="--:--",o&&o(a)}}}static async getSourceBlob(e,o){if(e.file)return e.file;if(ElectronHelper.isElectron()&&e.localPath){if(!await ElectronHelper.fileExists(e.localPath))throw new Error("File no longer exists at path: "+e.localPath);const o=await ElectronHelper.readFileAsBlob(e.localPath,e.mimeType);if(!o)throw new Error("Failed to read file from disk");return o}if(e.isLocal&&e.id){console.log("[Cache] Loading cached file from IndexedDB:",e.title);const o=await _dbService.loadFile(e.id);if(o)return console.log("[Cache] File loaded from IndexedDB:",e.title),o;console.warn("[Cache] File not found in IndexedDB, falling back to URL:",e.title)}if(e.url){console.log("[Cache] Fetching remote video for caching:",e.title);const t=await fetch(e.url);if(!t.ok)throw new Error(`Failed to fetch video: ${t.statusText}`);const a=await t.blob(),r=a.size/1024/1024;console.log(`[Cache] Downloaded ${r.toFixed(2)} MB`);const i=500;if(r>i)return console.warn(`[Cache] Video too large to cache (${r.toFixed(2)} MB > ${i} MB)`),console.warn("[Cache] Returning blob without caching (will re-fetch on next operation)"),a;if(e.id){const t=e.title||"video";await _dbService.saveFile(e.id,a,t,a.type)&&(e.isLocal=!0,o&&o(),console.log("[Cache] Blob persisted to IndexedDB, releasing from memory:",e.title))}return a}throw new Error("No source available for item")}static async getProcessedSourceURL(e,o){if(e.url&&!e.url.startsWith("blob:"))return e.url;if(e.isLocal&&e.url&&e.url.startsWith("blob:"))return e.url;const t=await this.getSourceBlob(e,o);e.isRemoteUrl||(e.isLocal=!0);const a=URL.createObjectURL(t);return e.isRemoteUrl?(e._playbackUrl=a,a):(e.url=a,e.url)}static async ensureMetadata(e,o){if(e.videoInfo||e.audioInfo)return;const t=await MediaMetadata.getProcessedSourceURL(e,o),{videoInfo:a,audioInfo:r,duration:i,videoTracks:n,audioTracks:c}=await MediaProcessor.getMetadata(t);e.videoInfo=a,e.audioInfo=r,e.videoTracks=n,e.audioTracks=c,e.duration&&"--:--"!==e.duration&&"Loading..."!==e.duration||(e.duration=formatDuration(i)),o&&o()}static async getVideoDuration(e){try{const o=e instanceof File?new MediaBunny.BlobSource(e):new MediaBunny.UrlSource(e),t=new MediaBunny.Input({source:o,formats:MediaBunny.ALL_FORMATS});return await t.computeDuration()}catch(e){return console.error("Error getting video duration:",e),0}}static async getFormattedMetadata(e,o){const t=new MediaBunny.Input({source:new MediaBunny.BlobSource(e),formats:MediaBunny.ALL_FORMATS}),a=await t.getFormat(),r=(await t.getTracks(),await t.getPrimaryVideoTrack()),i=await t.getPrimaryAudioTrack(),n=e=>e?e.toUpperCase():"N/A";var c;return{metadata:{filename:o,format:a?a.name:"Unknown",mimeType:a?a.mimeType:e.type,size:((e,o=1)=>{if(0===e)return"0 Bytes";const t=o<0?0:o,a=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,a)).toFixed(t))+" "+["Bytes","KB","MB","GB","TB"][a]})(e.size),duration:(c=r?await r.computeDuration():i?await i.computeDuration():0,[Math.floor(c/3600),Math.floor(c%3600/60),Math.floor(c%60)].map(e=>e<10?"0"+e:e).filter((e,o)=>"00"!==e||o>0).join(":")),videoCodec:r?n(r.codec):"N/A",videoCodecString:r?await r.getCodecParameterString():"N/A",resolution:r?`${r.displayWidth}x${r.displayHeight}`:"N/A",codedResolution:r?`${r.codedWidth}x${r.codedHeight}`:"N/A",fps:"Calculating...",videoBitrate:"Calculating...",rotation:r?`${r.rotation}Â°`:"N/A",hdr:r?await r.hasHighDynamicRange()?"Yes":"No":"N/A",audioCodec:i?n(i.codec):"N/A",audioCodecString:i?await i.getCodecParameterString():"N/A",channels:i?2===i.numberOfChannels?"Stereo (2)":`${i.numberOfChannels} Channels`:"N/A",sampleRate:i?`${(i.sampleRate/1e3).toFixed(1)} kHz`:"N/A",language:i?"und"===i.languageCode?"Undetermined":i.languageCode:"N/A"},videoTrack:r}}}