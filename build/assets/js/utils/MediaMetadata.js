import{MediaBunny}from"../core/MediaBunny.js";import{MediaProcessor}from"../core/MediaProcessor.js";import{formatDuration}from"./mediaUtils.js";export class MediaMetadata{static async processMetadata(e,a,o){for(const t of e)if(t.isLocal&&t.file){t.duration="Loading...",a&&a(t);try{const{videoInfo:e,audioInfo:i,duration:n}=await MediaProcessor.getMetadata(t.file);t.duration=formatDuration(n),t.videoInfo=e,t.audioInfo=i,a&&a(t),o&&o()}catch(e){console.warn("Failed to load metadata for",t.title,e),t.duration="--:--",a&&a(t)}}}static async getSourceBlob(e,a){if(e.file)return e.file;if(e.url){console.log("[Cache] Fetching remote video for caching:",e.title);const o=await fetch(e.url);if(!o.ok)throw new Error(`Failed to fetch video: ${o.statusText}`);const t=await o.blob(),i=t.size/1024/1024;console.log(`[Cache] Downloaded ${i.toFixed(2)} MB`);const n=500;return i>n?(console.warn(`[Cache] Video too large to cache (${i.toFixed(2)} MB > ${n} MB)`),console.warn("[Cache] Returning blob without caching (will re-fetch on next operation)"),t):(e.file=t,e.isLocal=!0,a&&a(),console.log("[Cache] Blob cached on item:",e.title),t)}throw new Error("No source available for item")}static async ensureMetadata(e,a){if(e.videoInfo||e.audioInfo)return;const o=await MediaMetadata.getSourceBlob(e,a),{videoInfo:t,audioInfo:i,duration:n}=await MediaProcessor.getMetadata(o);e.videoInfo=t,e.audioInfo=i,e.duration&&"--:--"!==e.duration&&"Loading..."!==e.duration||(e.duration=formatDuration(n)),a&&a()}static async getVideoDuration(e){try{const a=e instanceof File?new MediaBunny.BlobSource(e):new MediaBunny.UrlSource(e),o=new MediaBunny.Input({source:a,formats:MediaBunny.ALL_FORMATS});return await o.computeDuration()}catch(e){return console.error("Error getting video duration:",e),0}}static async getFormattedMetadata(e,a){const o=new MediaBunny.Input({source:new MediaBunny.BlobSource(e),formats:MediaBunny.ALL_FORMATS}),t=await o.getFormat(),i=(await o.getTracks(),await o.getPrimaryVideoTrack()),n=await o.getPrimaryAudioTrack(),r=e=>e?e.toUpperCase():"N/A";var d;return{metadata:{filename:a,format:t?t.name:"Unknown",mimeType:t?t.mimeType:e.type,size:((e,a=1)=>{if(0===e)return"0 Bytes";const o=a<0?0:a,t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(o))+" "+["Bytes","KB","MB","GB","TB"][t]})(e.size),duration:(d=i?await i.computeDuration():n?await n.computeDuration():0,[Math.floor(d/3600),Math.floor(d%3600/60),Math.floor(d%60)].map(e=>e<10?"0"+e:e).filter((e,a)=>"00"!==e||a>0).join(":")),videoCodec:i?r(i.codec):"N/A",videoCodecString:i?await i.getCodecParameterString():"N/A",resolution:i?`${i.displayWidth}x${i.displayHeight}`:"N/A",codedResolution:i?`${i.codedWidth}x${i.codedHeight}`:"N/A",fps:"Calculating...",videoBitrate:"Calculating...",rotation:i?`${i.rotation}Â°`:"N/A",hdr:i?await i.hasHighDynamicRange()?"Yes":"No":"N/A",audioCodec:n?r(n.codec):"N/A",audioCodecString:n?await n.getCodecParameterString():"N/A",channels:n?2===n.numberOfChannels?"Stereo (2)":`${n.numberOfChannels} Channels`:"N/A",sampleRate:n?`${(n.sampleRate/1e3).toFixed(1)} kHz`:"N/A",language:n?"und"===n.languageCode?"Undetermined":n.languageCode:"N/A"},videoTrack:i}}}