import{MediaBunny}from"./MediaBunny.js";export class MediaConverter{static async convert({source:e,format:a,quality:t,onProgress:n}){const r=new MediaBunny.BlobSource(e),o=new MediaBunny.Input({source:r,formats:MediaBunny.ALL_FORMATS});let i;switch(a){case"mp4":i=new MediaBunny.Mp4OutputFormat;break;case"webm":i=new MediaBunny.WebMOutputFormat;break;case"mov":i=new MediaBunny.QuickTimeOutputFormat;break;default:throw new Error(`Unsupported format: ${a}`)}const u=new MediaBunny.Output({format:i,target:new MediaBunny.BufferTarget});let c={};if(t<100){let e;e=t>=80?25e5:t>=60?15e5:8e5,c={bitrate:e,forceTranscode:!0}}const s=await MediaBunny.Conversion.init({input:o,output:u,video:c});return n&&(s.onProgress=n),await s.execute(),new Blob([u.target.buffer],{type:`video/${a}`})}static async getTracks(e){const a=new MediaBunny.BlobSource(e),t=new MediaBunny.Input({source:a,formats:MediaBunny.ALL_FORMATS}),n=await t.getVideoTracks(),r=await t.getAudioTracks(),o=async e=>Promise.all(e.map(async e=>{const a=await e.computeDuration(),t=await e.getCodecParameterString();return{id:e.id,type:e.type,language:e.languageCode,codec:e.codec,codecString:t,duration:a,width:e.displayWidth,height:e.displayHeight,channels:e.numberOfChannels,sampleRate:e.sampleRate}}));return{video:await o(n),audio:await o(r)}}static async extractTrack({source:e,trackIndex:a,trackType:t,format:n,onProgress:r}){const o=new MediaBunny.Input({source:e instanceof Blob?new MediaBunny.BlobSource(e):new MediaBunny.BufferSource(e),formats:MediaBunny.ALL_FORMATS});let i;switch(n){case"mp4":case"m4a":i=new MediaBunny.Mp4OutputFormat;break;case"mp3":i=new MediaBunny.Mp3OutputFormat;break;case"aac":i=new MediaBunny.AdtsOutputFormat;break;case"wav":i=new MediaBunny.WavOutputFormat;break;default:throw new Error(`Unsupported format: ${n}`)}const u=new MediaBunny.Output({format:i,target:new MediaBunny.BufferTarget}),c={input:o,output:u,video:(e,n)=>{const r="video"===t&&n-1===a;return console.log(`[MediaConverter] Video track ${n} (${e.codec}): ${r?"KEEP":"DISCARD"} (Target: ${t} #${a})`),r?{}:{discard:!0}},audio:(e,n)=>{const r="audio"===t&&n-1===a;return console.log(`[MediaConverter] Audio track ${n} (${e.codec}): ${r?"KEEP":"DISCARD"} (Target: ${t} #${a})`),r?{}:{discard:!0}}},s=await MediaBunny.Conversion.init(c);if(!s.isValid){console.error("Conversion invalid:",s.discardedTracks);const e=s.discardedTracks.map(e=>`${e.track.type}: ${e.reason}`).join(", ");throw new Error(`Cannot execute conversion: ${e}`)}r&&(s.onProgress=r),await s.execute();const d="video"===t?`video/${n}`:`audio/${n}`;return new Blob([u.target.buffer],{type:d})}}