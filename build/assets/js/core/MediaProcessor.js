import{MediaBunny}from"./MediaBunny.js";export class MediaProcessor{static async process({source:e,format:a,quality:t,trim:n,onProgress:r}){const o=new MediaBunny.BlobSource(e),i=new MediaBunny.Input({source:o,formats:MediaBunny.ALL_FORMATS});let u;switch(a){case"mp4":u=new MediaBunny.Mp4OutputFormat;break;case"webm":u=new MediaBunny.WebMOutputFormat;break;case"mov":u=new MediaBunny.QuickTimeOutputFormat;break;default:throw new Error(`Unsupported format: ${a}`)}const s=new MediaBunny.Output({format:u,target:new MediaBunny.BufferTarget});let c={};if(t<100){let e;e=t>=80?25e5:t>=60?15e5:8e5,c={bitrate:e,forceTranscode:!0}}const d=await MediaBunny.Conversion.init({input:i,output:s,video:c,trim:n});return r&&(d.onProgress=r),await d.execute(),new Blob([s.target.buffer],{type:`video/${a}`})}static async getTracks(e){const a=new MediaBunny.BlobSource(e),t=new MediaBunny.Input({source:a,formats:MediaBunny.ALL_FORMATS}),n=await t.getVideoTracks(),r=await t.getAudioTracks(),o=async e=>Promise.all(e.map(async e=>{const a=await e.computeDuration(),t=await e.getCodecParameterString();return{id:e.id,type:e.type,language:e.languageCode,codec:e.codec,codecString:t,duration:a,width:e.displayWidth,height:e.displayHeight,channels:e.numberOfChannels,sampleRate:e.sampleRate}}));return{video:await o(n),audio:await o(r)}}static async extractTrack({source:e,trackIndex:a,trackType:t,format:n,onProgress:r}){const o=e instanceof Blob?new MediaBunny.BlobSource(e):new MediaBunny.BufferSource(e),i=new MediaBunny.Input({source:o,formats:MediaBunny.ALL_FORMATS});let u;switch(n){case"mp4":case"m4a":u=new MediaBunny.Mp4OutputFormat;break;case"mp3":u=new MediaBunny.Mp3OutputFormat;break;case"aac":u=new MediaBunny.AdtsOutputFormat;break;case"wav":u=new MediaBunny.WavOutputFormat;break;default:throw new Error(`Unsupported format: ${n}`)}const s=new MediaBunny.Output({format:u,target:new MediaBunny.BufferTarget}),c={input:i,output:s,video:(e,n)=>{const r="video"===t&&n-1===a;return console.log(`[MediaProcessor] Video track ${n} (${e.codec}): ${r?"KEEP":"DISCARD"} (Target: ${t} #${a})`),r?{}:{discard:!0}},audio:(e,n)=>{const r="audio"===t&&n-1===a;return console.log(`[MediaProcessor] Audio track ${n} (${e.codec}): ${r?"KEEP":"DISCARD"} (Target: ${t} #${a})`),r?{}:{discard:!0}}},d=await MediaBunny.Conversion.init(c);if(!d.isValid){console.error("Conversion invalid:",d.discardedTracks);const e=d.discardedTracks.map(e=>`${e.track.type}: ${e.reason}`).join(", ");throw new Error(`Cannot execute conversion: ${e}`)}r&&(d.onProgress=r),await d.execute();const p="video"===t?`video/${n}`:`audio/${n}`;return new Blob([s.target.buffer],{type:p})}}