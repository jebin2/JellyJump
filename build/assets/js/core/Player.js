import{MediaBunny}from"./MediaBunny.js";import{PLAYER_CONFIG}from"./config.js";import{SubtitleManager}from"./SubtitleManager.js";import{ScreenshotManager}from"../player/ScreenshotManager.js";import{VideoFilters}from"../player/VideoFilters.js";import{AudioEqualizer}from"../player/AudioEqualizer.js";import{HLSPlayer}from"./HLSPlayer.js";import{StreamDetector}from"../utils/StreamDetector.js";export class CorePlayer{constructor(t,e={}){this.container=document.getElementById(t),this.container?(this.config={...PLAYER_CONFIG,...e},this.canvas=null,this.ctx=null,this.isPlaying=!1,this.currentTime=0,this.duration=0,this.playbackRate=parseFloat(localStorage.getItem("jellyjump-speed"))||1,this.loopMode="off",this.loopStart=null,this.loopEnd=null,this.animationFrameId=null,this.controlBarMode=e.controlBarMode||"overlay",this.autoHideTimer=null,this.config.controls={controlBar:!0,playPause:!0,navigation:!0,volume:!0,time:!0,progress:!0,captions:!0,settings:!0,fullscreen:!0,loop:!0,speed:!0,filters:!0,equalizer:!0,modeToggle:!0,keyboard:!0,...this.config.controls},this.PRESETS={player:{playPause:!0,volume:!0,time:!0,progress:!0,captions:!0,settings:!0,fullscreen:!0,loop:!0,speed:!0,filters:!0,equalizer:!0,modeToggle:!0},editor:{playPause:!0,volume:!0,time:!0,progress:!0,captions:!0,settings:!1,fullscreen:!0,loop:!1,speed:!0,modeToggle:!1},minimal:{playPause:!0,time:!0,progress:!0,volume:!1,captions:!1,settings:!1,fullscreen:!1,loop:!1,speed:!1,modeToggle:!1}},this.input=null,this.videoTrack=null,this.videoSink=null,this.audioTrack=null,this.audioSink=null,this.audioIteratorCleanupPromise=null,this.subtitleManager=null,this.isSubtitlesEnabled=!1,this.subtitleTracks=[],this.activeSubtitleTrackId=null,this.subtitleTrackCounter=0,this.onSubtitleChange=null,this.screenshotManager=null,this.audioContext=null,this.gainNode=null,this.nextAudioTime=0,this.isAudioInitialized=!1,this.currentAudioSource=null,this.activeSources=[],this.playbackId=0,this.videoFrameIterator=null,this.audioBufferIterator=null,this.nextFrame=null,this.queuedAudioNodes=new Set,this.asyncId=0,this.playbackTimeAtStart=0,this.audioContextStartTime=null,this.afterFrameRenderCallbacks=[],this.ui={controls:null,playBtn:null,prevBtn:null,nextBtn:null,progressBar:null,progressContainer:null,timeDisplay:null,volumeSlider:null,muteBtn:null,fullscreenBtn:null,loader:null,ccBtn:null,ccMenu:null,ccMenu:null,audioBtn:null,audioMenu:null,speedBtn:null,speedMenu:null,loopBtn:null,loopMarkerA:null,loopMarkerB:null,loopRegion:null,loopPanel:null,loopStartInput:null,loopStartInput:null,loopEndInput:null,playOverlay:null},this.onNext=null,this.onPrevious=null,this.onEnded=null,this.currentVideoId=null,this.hlsPlayer=null,this.streamVideo=null,this.isStreamMode=!1,this.isLive=!1,this.liveMode="live",this._handlers={click:t=>this._handleDocumentClick(t)},this.config.controls.fullscreen&&(this._handlers.fullscreen=this._updateFullscreenUI.bind(this)),this.config.controls.keyboard&&(this._handlers.keydown=t=>this._handleKeyboard(t)),this._init()):console.error(`Container with ID "${t}" not found.`)}_init(){this.container.classList.add("jellyjump-container");const t=document.getElementById("player-canvas-template").content.cloneNode(!0);this.canvas=t.querySelector("canvas"),this.ctx=this.canvas.getContext("2d",{willReadFrequently:!0}),this.container.appendChild(t),this.config.controls.captions&&(this.subtitleManager=new SubtitleManager),this.config.controls.settings&&(this.screenshotManager=new ScreenshotManager(this)),this._createControls(),this.config.controls.keyboard&&this._createHelpOverlay(),this._attachEvents(),this.config.controls.controlBar&&this._applyControlBarMode(),this.config.controls.fullscreen&&this._initResizeObserver()}_createHelpOverlay(){const t=document.getElementById("player-help-overlay-template").content.cloneNode(!0),e=t.getElementById("help-navigation-section"),i=t.getElementById("help-editor-section");"player"===this.config.mode?(e&&(e.style.display="block"),i&&(i.style.display="none")):"editor"===this.config.mode&&(e&&(e.style.display="none"),i&&(i.style.display="block"));const s=t.querySelector(".jellyjump-help-title");s&&(s.textContent="Keyboard Shortcuts "+("editor"===this.config.mode?"(Editor Mode)":"(Player Mode)")),this.container.appendChild(t),this.ui.helpOverlay=this.container.querySelector(".jellyjump-help-overlay"),this.ui.closeHelpBtn=this.container.querySelector(".jellyjump-close-help"),this.ui.closeHelpBtn.addEventListener("click",()=>this._toggleHelp()),this.ui.helpOverlay.addEventListener("click",t=>{t.target===this.ui.helpOverlay&&this._toggleHelp()})}_initAudio(){if(this.isAudioInitialized)return;const t=window.AudioContext||window.webkitAudioContext;if(this.audioContext=new t,this.gainNode=this.audioContext.createGain(),this.config.controls.equalizer){this.audioEqualizer=new AudioEqualizer(this.audioContext);this.audioEqualizer.init();this.audioEqualizer.getOutputNode().connect(this.gainNode)}this.gainNode.connect(this.audioContext.destination),this.gainNode.gain.value=this.config.muted?0:this.config.volume,this.isInitialized=!0,this.isAudioInitialized=!0}_createControls(){}_createControls(){const t=document.getElementById("player-loader-template");this.container.appendChild(t.content.cloneNode(!0)),this.ui.loader=this.container.querySelector(".jellyjump-loader");const e=document.getElementById("player-controls-template");if(this.container.appendChild(e.content.cloneNode(!0)),this.config.controls.loop){const t=document.getElementById("player-loop-panel-template");this.container.appendChild(t.content.cloneNode(!0))}if(this.screenshotManager&&this.screenshotManager.init(),this.ui.controls=this.container.querySelector(".jellyjump-controls"),this.ui.playOverlay=this.container.querySelector(".jellyjump-play-overlay"),this.config.controls.playPause&&(this.ui.playBtn=this.container.querySelector("#mb-play-btn")),this.config.controls.navigation&&(this.ui.prevBtn=this.container.querySelector("#mb-prev-btn"),this.ui.nextBtn=this.container.querySelector("#mb-next-btn")),this.config.controls.progress&&(this.ui.progressContainer=this.container.querySelector(".jellyjump-progress-container"),this.ui.progressBar=this.container.querySelector(".jellyjump-progress-bar")),this.config.controls.time&&(this.ui.timeDisplay=this.container.querySelector("#mb-time-display")),this.config.controls.fullscreen&&(this.ui.fullscreenBtn=this.container.querySelector("#mb-fullscreen-btn")),this.config.controls.modeToggle&&(this.ui.modeToggleBtn=this.container.querySelector("#mb-mode-toggle-btn")),this.config.controls.captions&&(this.ui.ccBtn=this.container.querySelector("#mb-cc-btn"),this.ui.ccMenu=this.container.querySelector("#mb-cc-menu"),this.ui.ccInput=this.container.querySelector("#mb-cc-input"),this.ui.audioContainer=this.container.querySelector("#mb-audio-container"),this.ui.audioBtn=this.container.querySelector("#mb-audio-btn"),this.ui.audioMenu=this.container.querySelector("#mb-audio-menu")),this.config.controls.speed&&(this.ui.speedBtn=this.container.querySelector("#mb-speed-btn"),this.ui.speedMenu=this.container.querySelector("#mb-speed-menu")),this.config.controls.loop&&(this.ui.loopBtn=this.container.querySelector("#mb-loop-btn"),this.ui.loopMarkerA=this.container.querySelector(".jellyjump-marker.marker-a"),this.ui.loopMarkerB=this.container.querySelector(".jellyjump-marker.marker-b"),this.ui.loopRegion=this.container.querySelector(".jellyjump-loop-region"),this.ui.loopPanel=this.container.querySelector(".jellyjump-loop-panel"),this.ui.loopStartInput=this.container.querySelector("#mb-loop-start"),this.ui.loopEndInput=this.container.querySelector("#mb-loop-end"),this.ui.loopStatus=this.container.querySelector("#mb-loop-status"),this.ui.setABtn=this.container.querySelector("#mb-set-a-btn"),this.ui.setBBtn=this.container.querySelector("#mb-set-b-btn"),this.ui.clearLoopBtn=this.container.querySelector("#mb-clear-loop-btn"),this.ui.closeLoopPanelBtn=this.container.querySelector(".jellyjump-loop-panel .jellyjump-close-btn")),this.config.controls.filters){const t=document.getElementById("player-filter-panel-template");t&&this.container.appendChild(t.content.cloneNode(!0)),this.ui.filtersBtn=this.container.querySelector("#mb-filters-btn"),this.ui.filterPanel=this.container.querySelector(".jellyjump-filter-panel"),this.ui.brightnessSlider=this.container.querySelector("#mb-filter-brightness"),this.ui.contrastSlider=this.container.querySelector("#mb-filter-contrast"),this.ui.saturationSlider=this.container.querySelector("#mb-filter-saturation"),this.ui.brightnessValue=this.container.querySelector("#mb-brightness-value"),this.ui.contrastValue=this.container.querySelector("#mb-contrast-value"),this.ui.saturationValue=this.container.querySelector("#mb-saturation-value"),this.ui.resetFiltersBtn=this.container.querySelector("#mb-reset-filters-btn"),this.ui.closeFilterPanelBtn=this.container.querySelector(".jellyjump-filter-panel .jellyjump-close-btn"),this.videoFilters=new VideoFilters(this.canvas)}if(this.config.controls.equalizer){const t=document.getElementById("player-audio-panel-template");t&&this.container.appendChild(t.content.cloneNode(!0)),this.ui.audioSettingsBtn=this.container.querySelector("#mb-audio-settings-btn"),this.ui.audioPanel=this.container.querySelector(".jellyjump-eq-panel"),this.ui.panelMuteBtn=this.container.querySelector("#mb-panel-mute-btn"),this.ui.panelVolumeSlider=this.container.querySelector("#mb-panel-volume-slider"),this.ui.panelVolumeValue=this.container.querySelector("#mb-panel-volume-value"),this.ui.eqBassSlider=this.container.querySelector("#mb-eq-bass"),this.ui.eqMidSlider=this.container.querySelector("#mb-eq-mid"),this.ui.eqTrebleSlider=this.container.querySelector("#mb-eq-treble"),this.ui.eqBassValue=this.container.querySelector("#mb-bass-value"),this.ui.eqMidValue=this.container.querySelector("#mb-mid-value"),this.ui.eqTrebleValue=this.container.querySelector("#mb-treble-value"),this.ui.resetEqBtn=this.container.querySelector("#mb-reset-eq-btn"),this.ui.closeAudioPanelBtn=this.container.querySelector(".jellyjump-eq-panel .jellyjump-close-btn")}this._createErrorOverlay(),this._applyControlVisibility(),this.config.controls.speed&&this._updateSpeedMenu()}_applyControlVisibility(){if(!this.ui.controls)return;const t=this.config.controls;this.ui.controls.querySelectorAll("[data-control]").forEach(e=>{const i=e.dataset.control;t[i]&&e.classList.remove("control--hidden")})}_attachEvents(){this.config.controls.playPause&&this.ui.playBtn&&this.ui.playBtn.addEventListener("click",()=>this.togglePlay()),this.canvas.addEventListener("click",()=>this.togglePlay()),this.ui.playOverlay&&this.ui.playOverlay.addEventListener("click",()=>this.play()),this.ui.prevBtn&&this.ui.prevBtn.addEventListener("click",()=>{!this.ui.prevBtn.disabled&&this.onPrevious&&this.onPrevious()}),this.ui.nextBtn&&this.ui.nextBtn.addEventListener("click",()=>{!this.ui.nextBtn.disabled&&this.onNext&&this.onNext()}),this.config.controls.progress&&this.ui.progressContainer&&this.ui.progressContainer.addEventListener("click",t=>this._seek(t)),this.config.controls.volume&&this.ui.volumeSlider&&this.ui.volumeSlider.addEventListener("input",t=>{this.config.volume=parseFloat(t.target.value),this.config.muted=!1,this.gainNode&&(this.gainNode.gain.value=this.config.volume),this._updateVolumeIcon()}),this.config.controls.volume&&this.ui.muteBtn&&this.ui.muteBtn.addEventListener("click",()=>{this.config.muted=!this.config.muted,this.gainNode&&(this.gainNode.gain.value=this.config.muted?0:this.config.volume),this._updateVolumeIcon()}),this.config.controls.fullscreen&&this.ui.fullscreenBtn&&this.ui.fullscreenBtn.addEventListener("click",()=>this.toggleFullscreen()),this.config.controls.fullscreen&&this.ui.modeToggleBtn&&this.ui.modeToggleBtn.addEventListener("click",()=>this.toggleControlBarMode()),this.config.controls.fullscreen&&(this.container.addEventListener("mousemove",t=>this._handleMouseMove(t)),this.container.addEventListener("mouseenter",()=>{"overlay"===this.controlBarMode&&(this.ui.controls.classList.add("visible"),this._clearAutoHideTimer(),this.isPlaying&&this._startAutoHideTimer())}),this.container.addEventListener("mouseleave",()=>{"overlay"===this.controlBarMode&&this.isPlaying&&(this._clearAutoHideTimer(),this.ui.controls.classList.remove("visible"),this.container.classList.add("hide-cursor"))}),this.ui.controls.addEventListener("mouseenter",()=>this._clearAutoHideTimer()),this.ui.controls.addEventListener("mouseleave",()=>{this.isPlaying&&"overlay"===this.controlBarMode&&this._startAutoHideTimer()})),this.config.controls.captions&&this.ui.ccBtn&&(this.ui.ccBtn.addEventListener("click",()=>{this.ui.ccMenu.classList.toggle("visible"),this.ui.ccBtn.setAttribute("aria-expanded",this.ui.ccMenu.classList.contains("visible"))}),this.ui.ccMenu.addEventListener("click",t=>{const e=t.target.closest(".jellyjump-menu-item");if(e)if("mb-upload-cc"===e.id)this.ui.ccInput.click();else{"off"===e.dataset.value&&(this.isSubtitlesEnabled=!1),this._updateSubtitleMenu(),this.ui.ccMenu.classList.remove("visible")}}),this.ui.ccInput.addEventListener("change",t=>{const e=t.target.files[0];if(e){const t=URL.createObjectURL(e);this.loadSubtitle(t),this.ui.ccMenu.classList.remove("visible")}}),this.ui.audioBtn.addEventListener("click",()=>{this.ui.audioMenu.classList.toggle("visible"),this.ui.audioBtn.setAttribute("aria-expanded",this.ui.audioMenu.classList.contains("visible"))}),this.ui.audioMenu.addEventListener("click",t=>{const e=t.target.closest(".jellyjump-menu-item");if(!e)return;const i=parseInt(e.dataset.value);this._switchAudioTrack(i),this.ui.audioMenu.classList.remove("visible")})),this.config.controls.speed&&this.ui.speedBtn&&(this.ui.speedBtn.addEventListener("click",()=>{this.ui.speedMenu.classList.toggle("visible"),this.ui.speedBtn.setAttribute("aria-expanded",this.ui.speedMenu.classList.contains("visible"))}),this.ui.speedMenu.addEventListener("click",t=>{const e=t.target.closest(".jellyjump-menu-item");if(!e)return;const i=parseFloat(e.dataset.value);this.setPlaybackRate(i),this.ui.speedMenu.classList.remove("visible")})),this.config.controls.fullscreen&&(document.addEventListener("fullscreenchange",this._handlers.fullscreen),document.addEventListener("webkitfullscreenchange",this._handlers.fullscreen),document.addEventListener("mozfullscreenchange",this._handlers.fullscreen),document.addEventListener("MSFullscreenChange",this._handlers.fullscreen)),this.config.controls.loop&&(this.ui.loopBtn.addEventListener("click",()=>this.toggleLoopMode()),this.ui.loopBtn.addEventListener("contextmenu",t=>{t.preventDefault(),this.toggleLoopPanel()}),this.ui.closeLoopPanelBtn.addEventListener("click",()=>this.toggleLoopPanel()),this.ui.setABtn.addEventListener("click",()=>this.setLoopStart()),this.ui.setBBtn.addEventListener("click",()=>this.setLoopEnd()),this.ui.clearLoopBtn.addEventListener("click",()=>this.clearLoopMarkers()),this.ui.loopStartInput.addEventListener("change",t=>{const e=this._parseTime(t.target.value);null!==e&&(this.loopStart=e,this.loopMode="ab",this._updateLoopUI())}),this.ui.loopEndInput.addEventListener("change",t=>{const e=this._parseTime(t.target.value);null!==e&&(this.loopEnd=e,this.loopMode="ab",this._updateLoopUI())})),this.config.controls.filters&&this.ui.filtersBtn&&(this.ui.filtersBtn.addEventListener("click",()=>this.toggleFilterPanel()),this.ui.closeFilterPanelBtn&&this.ui.closeFilterPanelBtn.addEventListener("click",()=>this.toggleFilterPanel()),this.ui.brightnessSlider&&this.ui.brightnessSlider.addEventListener("input",t=>{const e=parseInt(t.target.value);this.videoFilters.setBrightness(e),this.ui.brightnessValue.textContent=`${e}%`,this._updateFiltersButtonState()}),this.ui.contrastSlider&&this.ui.contrastSlider.addEventListener("input",t=>{const e=parseInt(t.target.value);this.videoFilters.setContrast(e),this.ui.contrastValue.textContent=`${e}%`,this._updateFiltersButtonState()}),this.ui.saturationSlider&&this.ui.saturationSlider.addEventListener("input",t=>{const e=parseInt(t.target.value);this.videoFilters.setSaturation(e),this.ui.saturationValue.textContent=`${e}%`,this._updateFiltersButtonState()}),this.container.querySelectorAll(".filter-preset-btn").forEach(t=>{t.addEventListener("click",()=>{const e=t.dataset.preset;this.videoFilters.applyPreset(e),this._syncFilterSliders(),this._updateFiltersButtonState()})}),this.ui.resetFiltersBtn&&this.ui.resetFiltersBtn.addEventListener("click",()=>{this.videoFilters.reset(),this._syncFilterSliders(),this._updateFiltersButtonState()})),this.config.controls.equalizer&&this.ui.audioSettingsBtn&&(this.ui.audioSettingsBtn.addEventListener("click",()=>this.toggleAudioPanel()),this.ui.closeAudioPanelBtn&&this.ui.closeAudioPanelBtn.addEventListener("click",()=>this.toggleAudioPanel()),this.ui.panelMuteBtn&&this.ui.panelMuteBtn.addEventListener("click",()=>this.toggleMute()),this.ui.panelVolumeSlider&&this.ui.panelVolumeSlider.addEventListener("input",t=>{const e=parseFloat(t.target.value);this.setVolume(e)}),this.ui.eqBassSlider&&this.ui.eqBassSlider.addEventListener("input",t=>{const e=parseInt(t.target.value);this.audioEqualizer.setBass(e),this.ui.eqBassValue.textContent=e}),this.ui.eqMidSlider&&this.ui.eqMidSlider.addEventListener("input",t=>{const e=parseInt(t.target.value);this.audioEqualizer.setMid(e),this.ui.eqMidValue.textContent=e}),this.ui.eqTrebleSlider&&this.ui.eqTrebleSlider.addEventListener("input",t=>{const e=parseInt(t.target.value);this.audioEqualizer.setTreble(e),this.ui.eqTrebleValue.textContent=e}),this.container.querySelectorAll(".eq-preset-btn").forEach(t=>{t.addEventListener("click",()=>{const e=t.dataset.preset;this.audioEqualizer.applyPreset(e),this._syncEqSliders()})}),this.ui.resetEqBtn&&this.ui.resetEqBtn.addEventListener("click",()=>{this.audioEqualizer.reset(),this._syncEqSliders()})),document.addEventListener("click",this._handlers.click),this.config.controls.keyboard&&document.addEventListener("keydown",this._handlers.keydown)}_handleDocumentClick(t){this.ui.ccBtn&&this.ui.ccMenu&&!this.ui.ccBtn.contains(t.target)&&!this.ui.ccMenu.contains(t.target)&&this.ui.ccMenu.classList.remove("visible"),this.ui.audioBtn&&this.ui.audioMenu&&!this.ui.audioBtn.contains(t.target)&&!this.ui.audioMenu.contains(t.target)&&this.ui.audioMenu.classList.remove("visible"),this.ui.speedBtn&&this.ui.speedMenu&&!this.ui.speedBtn.contains(t.target)&&!this.ui.speedMenu.contains(t.target)&&this.ui.speedMenu.classList.remove("visible"),this.ui.filterPanel&&this.ui.filtersBtn&&!this.ui.filtersBtn.contains(t.target)&&!this.ui.filterPanel.contains(t.target)&&(this.ui.filterPanel.style.display="none"),this.ui.audioPanel&&this.ui.audioSettingsBtn&&!this.ui.audioSettingsBtn.contains(t.target)&&!this.ui.audioPanel.contains(t.target)&&(this.ui.audioPanel.style.display="none")}_updateSpeedMenu(){if(!this.ui.speedMenu||!this.ui.speedBtn)return;this.ui.speedMenu.querySelectorAll(".jellyjump-menu-item").forEach(t=>{parseFloat(t.dataset.value)===this.playbackRate?t.classList.add("active"):t.classList.remove("active")}),this.ui.speedBtn.textContent=1===this.playbackRate?"1x":`${this.playbackRate}x`,1!==this.playbackRate?this.ui.speedBtn.style.color="var(--accent-primary)":this.ui.speedBtn.style.color=""}toggleLoopMode(){"off"===this.loopMode?this.loopMode="playlist":"playlist"===this.loopMode?this.loopMode="one":this.loopMode="off",null===this.loopStart&&null===this.loopEnd||(this.loopStart=null,this.loopEnd=null),this._updateLoopUI()}toggleLoopPanel(){const t="none"!==this.ui.loopPanel.style.display;this.ui.loopPanel.style.display=t?"none":"block",t||this._updateLoopUI()}toggleFilterPanel(){if(!this.ui.filterPanel)return;const t="none"!==this.ui.filterPanel.style.display;this.ui.filterPanel.style.display=t?"none":"block",t||this._syncFilterSliders()}_syncFilterSliders(){if(!this.videoFilters)return;const t=this.videoFilters.getState();this.ui.brightnessSlider&&(this.ui.brightnessSlider.value=t.brightness,this.ui.brightnessValue.textContent=`${t.brightness}%`),this.ui.contrastSlider&&(this.ui.contrastSlider.value=t.contrast,this.ui.contrastValue.textContent=`${t.contrast}%`),this.ui.saturationSlider&&(this.ui.saturationSlider.value=t.saturation,this.ui.saturationValue.textContent=`${t.saturation}%`)}_updateFiltersButtonState(){this.ui.filtersBtn&&this.videoFilters&&(this.videoFilters.isActive()?(this.ui.filtersBtn.style.color="var(--accent-primary)",this.ui.filtersBtn.setAttribute("aria-label","Video Filters (Active)")):(this.ui.filtersBtn.style.color="",this.ui.filtersBtn.setAttribute("aria-label","Video Filters")))}toggleAudioPanel(){if(!this.ui.audioPanel)return;const t="none"!==this.ui.audioPanel.style.display;this.ui.audioPanel.style.display=t?"none":"block",t||(this._syncEqSliders(),this._updateVolumeUI())}_syncEqSliders(){if(!this.audioEqualizer)return;const t=this.audioEqualizer.getState();this.ui.eqBassSlider&&(this.ui.eqBassSlider.value=t.bass,this.ui.eqBassValue.textContent=t.bass),this.ui.eqMidSlider&&(this.ui.eqMidSlider.value=t.mid,this.ui.eqMidValue.textContent=t.mid),this.ui.eqTrebleSlider&&(this.ui.eqTrebleSlider.value=t.treble,this.ui.eqTrebleValue.textContent=t.treble)}_updateAudioButtonState(){if(!this.ui.audioSettingsBtn)return;const t=this.ui.audioSettingsBtn.querySelector("use");t&&(this.isMuted||0===this.volume?(t.setAttribute("href","assets/icons/sprite.svg#icon-volume-mute"),this.ui.audioSettingsBtn.setAttribute("aria-label","Audio Settings (Muted)")):(this.volume<.5?t.setAttribute("href","assets/icons/sprite.svg#icon-volume-low"):t.setAttribute("href","assets/icons/sprite.svg#icon-volume-high"),this.ui.audioSettingsBtn.setAttribute("aria-label","Audio Settings"),this.audioEqualizer&&this.audioEqualizer.isActive()?this.ui.audioSettingsBtn.style.color="var(--accent-primary)":this.ui.audioSettingsBtn.style.color=""))}setLoopStart(){this.loopStart=this.currentTime,null!==this.loopEnd&&this.loopStart>=this.loopEnd&&(this.loopEnd=null),this.loopMode="ab",this._updateLoopUI(),console.log("Loop Start set:",this.loopStart)}setLoopEnd(){null!==this.loopStart?this.currentTime<=this.loopStart?console.warn("Loop End must be after Loop Start"):(this.loopEnd=this.currentTime,this.loopMode="ab",this._updateLoopUI(),console.log("Loop End set:",this.loopEnd)):this.setLoopStart()}clearLoopMarkers(){this.loopStart=null,this.loopEnd=null,this._updateLoopUI()}resetLoop(){this.loopStart=null,this.loopEnd=null,this.loopMode="off",this._updateLoopUI()}_updateLoopUI(){const t=this.ui.loopBtn,e=t.querySelector("use");let i="Off";if("off"===this.loopMode?(t.style.color="",t.setAttribute("aria-label","Loop Mode: Off"),e.setAttribute("href","assets/icons/sprite.svg#icon-loop"),i="Off"):"playlist"===this.loopMode?(t.style.color="var(--accent-primary)",t.setAttribute("aria-label","Loop Mode: Playlist"),e.setAttribute("href","assets/icons/sprite.svg#icon-loop-playlist"),i="Playlist"):"one"===this.loopMode?(t.style.color="var(--accent-primary)",t.setAttribute("aria-label","Loop Mode: One"),e.setAttribute("href","assets/icons/sprite.svg#icon-loop-one"),i="Current Video"):"ab"===this.loopMode&&(t.style.color="var(--accent-primary)",t.setAttribute("aria-label","Loop Mode: A-B"),e.setAttribute("href","assets/icons/sprite.svg#icon-loop-ab"),i="A-B Loop"),this.ui.loopStatus&&(this.ui.loopStatus.textContent=i,this.ui.loopStartInput.value=null!==this.loopStart?this._formatTime(this.loopStart):"",this.ui.loopEndInput.value=null!==this.loopEnd?this._formatTime(this.loopEnd):""),this.duration>0)if(null!==this.loopStart?(this.ui.loopMarkerA.style.display="block",this.ui.loopMarkerA.style.left=this.loopStart/this.duration*100+"%"):this.ui.loopMarkerA.style.display="none",null!==this.loopEnd?(this.ui.loopMarkerB.style.display="block",this.ui.loopMarkerB.style.left=this.loopEnd/this.duration*100+"%"):this.ui.loopMarkerB.style.display="none",null!==this.loopStart&&null!==this.loopEnd){this.ui.loopRegion.style.display="block";const t=this.loopStart/this.duration*100,e=this.loopEnd/this.duration*100;this.ui.loopRegion.style.left=`${t}%`,this.ui.loopRegion.style.width=e-t+"%"}else this.ui.loopRegion.style.display="none"}async setPlaybackRate(t){if(t<.25||t>2)return;const e=this.isPlaying,i=this._getPlaybackTime();e&&(this.pause(),this.audioIteratorCleanupPromise&&await this.audioIteratorCleanupPromise),this.playbackRate=t,localStorage.setItem("jellyjump-speed",t),this._updateSpeedMenu(),e&&(await this._seekTo(i),await this.play())}_updateSubtitleMenu(){if(!this.ui.ccMenu||!this.ui.ccBtn)return;this.ui.ccMenu.querySelectorAll('[data-value^="custom-"]').forEach(t=>t.remove()),this.ui.ccMenu.querySelectorAll(".jellyjump-menu-item").forEach(t=>{t.classList.remove("active")});const t=this.ui.ccMenu.querySelector("#mb-upload-cc");if(this.subtitleTracks.forEach(e=>{const i=document.createElement("div");i.className="jellyjump-menu-item",i.setAttribute("data-value",e.id),i.setAttribute("role","menuitem"),i.setAttribute("tabindex","0"),i.textContent=e.name,t?this.ui.ccMenu.insertBefore(i,t):this.ui.ccMenu.appendChild(i),i.addEventListener("click",()=>{this._switchSubtitleTrack(e.id),this.ui.ccMenu.classList.remove("visible")})}),this.isSubtitlesEnabled){const t=this.ui.ccMenu.querySelector(`[data-value="${this.activeSubtitleTrackId}"]`);t&&t.classList.add("active"),this.ui.ccBtn.classList.add("active")}else this.ui.ccMenu.querySelector('[data-value="off"]').classList.add("active"),this.ui.ccBtn.classList.remove("active")}_switchSubtitleTrack(t){const e=this.subtitleTracks.find(e=>e.id===t);e&&(this.subtitleManager.cues=[...e.cues],this.activeSubtitleTrackId=t,this.isSubtitlesEnabled=!0,this._updateSubtitleMenu(),console.log(`Switched to subtitle track: ${e.name}`))}async _switchAudioTrack(t){if(!this.input)return;const e=(await this.input.getAudioTracks()).find(e=>e.id===t);e&&(this.audioTrack=e,this.audioSink,this.audioSink=new MediaBunny.AudioSampleSink(this.audioTrack),this._updateAudioTracks(),console.log(`Switched to audio track: ${e.id}`))}async _updateAudioTracks(){if(!this.ui.audioMenu||!this.ui.audioContainer)return;this.ui.audioMenu.textContent="";const t=this.input?await this.input.getAudioTracks():[];if(t.length<=1)return void(this.ui.audioContainer.style.display="none");this.ui.audioContainer.style.display="block";const e=document.getElementById("player-menu-item-template");t.forEach((t,i)=>{const s=e.content.cloneNode(!0).querySelector(".jellyjump-menu-item");s.textContent=t.languageCode||`Track ${i+1}`,s.dataset.value=t.id,this.audioTrack&&this.audioTrack.id===t.id&&s.classList.add("active"),this.ui.audioMenu.appendChild(s)})}_handleKeyboard(t){if(["INPUT","TEXTAREA","SELECT"].includes(document.activeElement.tagName))return;if(t.ctrlKey||t.altKey||t.metaKey)return;const e=t.key.toLowerCase();switch(e){case" ":case"k":t.preventDefault(),this.togglePlay();break;case"j":t.preventDefault(),this._seekTo(Math.max(0,this.currentTime-10));break;case"l":t.shiftKey?(t.preventDefault(),this.clearLoopMarkers()):(t.preventDefault(),this._seekTo(Math.min(this.duration,this.currentTime+10)));break;case"arrowleft":t.preventDefault(),this._seekTo(Math.max(0,this.currentTime-5));break;case"arrowright":t.preventDefault(),this._seekTo(Math.min(this.duration,this.currentTime+5));break;case"home":t.preventDefault(),this._seekTo(0);break;case"end":t.preventDefault(),this._seekTo(this.duration);break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":t.preventDefault();const i=parseInt(e)/10;this._seekTo(this.duration*i);break;case"arrowup":t.preventDefault(),this.setVolume(this.config.volume+.1);break;case"arrowdown":t.preventDefault(),this.setVolume(this.config.volume-.1);break;case"m":t.preventDefault(),this.toggleMute();break;case"f":t.preventDefault(),this.toggleFullscreen();break;case"c":t.preventDefault(),this.isSubtitlesEnabled=!this.isSubtitlesEnabled,this._updateSubtitleMenu();break;case"escape":document.fullscreenElement?document.exitFullscreen():this.screenshotManager&&this.screenshotManager.isModalOpen()?this.screenshotManager.closeModal():"none"!==this.ui.helpOverlay.style.display&&this._toggleHelp();break;case"?":t.preventDefault(),this._toggleHelp();break;case"s":t.preventDefault(),this.screenshotManager&&this.screenshotManager.capture();break;case"n":t.shiftKey&&"player"===this.config.mode&&(t.preventDefault(),!this.ui.nextBtn.disabled&&this.onNext&&this.onNext());break;case"p":t.shiftKey&&"player"===this.config.mode&&(t.preventDefault(),!this.ui.prevBtn.disabled&&this.onPrevious&&this.onPrevious());break;case"<":t.shiftKey&&(t.preventDefault(),this._cycleSpeed(-1));break;case">":t.shiftKey&&(t.preventDefault(),this._cycleSpeed(1));break;case",":"editor"===this.config.mode&&(t.preventDefault(),this._stepFrame(-1));break;case".":"editor"===this.config.mode&&(t.preventDefault(),this._stepFrame(1));break;case"i":t.preventDefault(),this.setLoopStart();break;case"o":t.preventDefault(),this.setLoopEnd();break;case"r":t.preventDefault(),this.resetLoop()}}_toggleHelp(){const t="none"!==this.ui.helpOverlay.style.display;this.ui.helpOverlay.style.display=t?"none":"flex"}_cycleSpeed(t){const e=[.25,.5,.75,1,1.25,1.5,1.75,2];let i=e.indexOf(this.playbackRate);-1===i&&(i=3),i+=t,i>=0&&i<e.length&&this.setPlaybackRate(e[i])}_stepFrame(t){const e=1/(this.frameRate||30),i=this.currentTime+t*e;this._seekTo(Math.max(0,Math.min(this.duration,i)))}reset(){if(this.pause(),this.ctx&&this.canvas&&this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.currentTime=0,this.duration=0,this.videoSink&&"function"==typeof this.videoSink.dispose)try{this.videoSink.dispose()}catch(t){console.warn("Error disposing videoSink:",t)}if(this.audioSink&&"function"==typeof this.audioSink.dispose)try{this.audioSink.dispose()}catch(t){console.warn("Error disposing audioSink:",t)}if(this.input&&"function"==typeof this.input.dispose)try{this.input.dispose()}catch(t){console.warn("Error disposing input:",t)}this.input=null,this.videoSink=null,this.audioSink=null,this.videoTrack=null,this.audioTrack=null,this.videoFrameIterator=null,this.audioBufferIterator=null,this.nextFrame=null,this.currentVideoId=null,this._updateTimeDisplay(),this._updateProgress(),this.ui.loader.style.display="none",this.audioContext&&(this.activeSources.forEach(t=>{try{t.stop()}catch(t){}}),this.activeSources=[])}destroy(){this.reset(),this.config.controls.fullscreen&&(document.removeEventListener("fullscreenchange",this._handlers.fullscreen),document.removeEventListener("webkitfullscreenchange",this._handlers.fullscreen),document.removeEventListener("mozfullscreenchange",this._handlers.fullscreen),document.removeEventListener("MSFullscreenChange",this._handlers.fullscreen)),document.removeEventListener("click",this._handlers.click),this.config.controls.keyboard&&document.removeEventListener("keydown",this._handlers.keydown),this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null),this.container.innerHTML=""}async load(t,e=!1,i=null,s=null){try{if(StreamDetector.detect(t)===StreamDetector.TYPE_HLS)return this._loadHLSStream(t,e,i);if(this.hlsPlayer&&this._cleanupHLS(),this.isStreamMode=!1,this.isLive=!1,this._hideStreamVideo(),this.pause(!1),this.currentTime=0,this.videoFrameIterator&&await this.videoFrameIterator.return(),this.audioIteratorCleanupPromise&&await this.audioIteratorCleanupPromise,this.audioBufferIterator&&await this.audioBufferIterator.return(),this.videoFrameIterator=null,this.audioBufferIterator=null,this.nextFrame=null,this.asyncId++,this.playbackTimeAtStart=0,this.audioContextStartTime=null,this.queuedAudioNodes.clear(),this.ctx&&this.canvas&&this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this._updateTimeDisplay(),this.videoSink&&"function"==typeof this.videoSink.dispose)try{this.videoSink.dispose()}catch(t){console.warn("Error disposing videoSink:",t)}if(this.audioSink&&"function"==typeof this.audioSink.dispose)try{this.audioSink.dispose()}catch(t){console.warn("Error disposing audioSink:",t)}if(this.input&&"function"==typeof this.input.dispose)try{this.input.dispose()}catch(t){console.warn("Error disposing input:",t)}if(this.videoSink=null,this.audioSink=null,this.input=null,this.subtitleTracks=[],this.subtitleTrackCounter=0,this.activeSubtitleTrackId=null,this.isSubtitlesEnabled=!1,this.subtitleManager&&(this.subtitleManager.cues=[]),this.ui.loader.classList.add("visible"),console.log(`Loading media: ${t}`),this.currentVideoId=i||t,this.input=new MediaBunny.Input({source:new MediaBunny.UrlSource(t),formats:MediaBunny.ALL_FORMATS}),this.duration=await this.input.computeDuration(),this._updateTimeDisplay(),this.videoTrack=await this.input.getPrimaryVideoTrack(),this.videoTrack){try{const t=await this.videoTrack.computePacketStats();this.frameRate=t.averagePacketRate||30,console.log(`Detected frame rate: ${this.frameRate} fps`)}catch(t){console.warn("Could not compute frame rate, defaulting to 30fps",t),this.frameRate=30}this.videoSink=new MediaBunny.CanvasSink(this.videoTrack,{poolSize:2,fit:"contain"}),this.canvas.width=this.videoTrack.displayWidth,this.canvas.height=this.videoTrack.displayHeight,await this._handleInitialFrame(e),!e&&this.ui.playOverlay&&(this.ui.playOverlay.style.display="flex")}if(this.audioTrack=await this.input.getPrimaryAudioTrack(),!this.audioTrack){const t=await this.input.getAudioTracks();t.length>0&&(this.audioTrack=t[0])}this.audioTrack&&(this.audioSink=new MediaBunny.AudioSampleSink(this.audioTrack)),this._updateAudioTracks(),s&&s.length>0&&(this.subtitleTracks=s.map(t=>({id:t.id,name:t.name,cues:[...t.cues]})),this.subtitleTrackCounter=s.reduce((t,e)=>{const i=e.id.match(/custom-(\d+)/);return i?Math.max(t,parseInt(i[1])):t},0),console.log(`Restored ${s.length} subtitle track(s) for video`)),this._updateSubtitleMenu(),this.ui.loader.classList.remove("visible"),console.log("Media loaded successfully")}catch(t){console.error("Error loading media:",t),this.ui.loader.classList.remove("visible")}}async _loadHLSStream(t,e,i){try{console.log("[Stream] Loading HLS stream:",t),this._lastStreamUrl=t,this.pause(!1),this._cleanupMediaBunny(),this.isStreamMode=!0,this.currentVideoId=i||t,this.ui.loader.classList.add("visible"),this._hideStreamError(),this._createStreamVideo(),this._showStreamVideo(),this.hlsPlayer||(this.hlsPlayer=new HLSPlayer(this.streamVideo),this.hlsPlayer.onManifestParsed=t=>{console.log("[Stream] Manifest parsed:",t.levels?.length,"quality levels"),this._updateQualityMenu()},this.hlsPlayer.onQualityChange=t=>{this._updateQualityMenu()},this.hlsPlayer.onError=t=>{if(console.warn("[Stream] HLS error:",t),t.fatal||"networkError"===t.type){const e=HLSPlayer.getErrorDetails(t);this._showStreamError(e)}}),await this.hlsPlayer.load(t),this.isLive=this.hlsPlayer.isLive,this._updateStreamUI(),this._setupStreamVideoEvents(),this.streamVideo&&(this.streamVideo.volume=this.config.volume,this.streamVideo.muted=this.config.muted),this.ui.loader.classList.remove("visible"),console.log("[Stream] HLS stream loaded successfully. Live:",this.isLive),this.isLive&&(this._needsSeekToLive=!0),e?this.play():(this.ui.playOverlay&&(this.ui.playOverlay.style.display="flex"),this.isLive&&this.ui.liveBadge&&this.ui.liveBadge.classList.add("not-live"))}catch(e){console.error("[Stream] Error loading HLS stream:",e),this.ui.loader.classList.remove("visible");const i=HLSPlayer.getErrorDetails({type:"networkError",details:e.message||"manifestLoadError",error:e,url:t});this._showStreamError(i)}}_createStreamVideo(){if(this.streamVideo)return;this.streamVideo=document.createElement("video"),this.streamVideo.className="jellyjump-stream-video jellyjump-video",this.streamVideo.playsInline=!0,this.streamVideo.crossOrigin="anonymous";(this.container.querySelector(".jellyjump-video-wrapper")||this.container).appendChild(this.streamVideo)}_showStreamVideo(){this.streamVideo&&(this.streamVideo.style.display="block"),this.canvas&&(this.canvas.style.display="none")}_hideStreamVideo(){this.streamVideo&&(this.streamVideo.style.display="none"),this.canvas&&(this.canvas.style.display="block"),this._setStreamModeControls(!1)}_setupStreamVideoEvents(){this.streamVideo&&(this.streamVideo.ontimeupdate=()=>{if(this.isStreamMode&&(this.currentTime=this.streamVideo.currentTime,this.duration=this.streamVideo.duration||0,this._updateTimeDisplay(),this._updateProgress(),this.isLive&&this.ui.liveBadge)){const t=this.hlsPlayer?.getLiveLatency()||0;let e=!1;e="buffer"===this.liveMode?Math.abs(t-30)<5:t<10,this.ui.liveBadge.classList.toggle("not-live",!e)}},this.streamVideo.onended=()=>{this.isStreamMode&&this.onEnded&&this.onEnded()},this.streamVideo.onseeked=()=>{this.isStreamMode&&this.ui.loader.classList.remove("visible")},this.streamVideo.onplay=()=>{this.isPlaying=!0,this._updatePlayPauseUI(),this.ui.playOverlay&&(this.ui.playOverlay.style.display="none"),this._needsSeekToLive&&this.hlsPlayer&&(this._needsSeekToLive=!1,this.ui.loader.classList.add("visible"),setTimeout(()=>{this.hlsPlayer.seekToLive()},300)),"overlay"===this.controlBarMode&&setTimeout(()=>{this.isPlaying&&"overlay"===this.controlBarMode&&this._startAutoHideTimer()},500)},this.streamVideo.onpause=()=>{this.isPlaying=!1,this._clearAutoHideTimer(),this._updatePlayPauseUI(),this.isLive&&this.ui.liveBadge&&this.ui.liveBadge.classList.add("not-live")},this.streamVideo.addEventListener("click",()=>this.togglePlay()))}_updateStreamUI(){if(this.isLive){if(!this.ui.liveControl){this.ui.liveControl=document.createElement("div"),this.ui.liveControl.className="jellyjump-menu-btn jellyjump-live-control",this.ui.liveControl.style.display="inline-flex",this.ui.liveControl.style.marginRight="10px",this.ui.liveControl.style.position="relative",this.ui.liveBadge=document.createElement("button"),this.ui.liveBadge.className="jellyjump-live-badge",this.ui.liveBadge.textContent="LIVE",this.ui.liveBadge.title="Click to change mode",this.ui.liveBadge.style.display="inline-flex",this.ui.liveBadge.style.marginRight="0",this.ui.liveMenu=document.createElement("div"),this.ui.liveMenu.className="jellyjump-menu",this.ui.liveMenu.style.minWidth="150px",this.ui.liveMenu.style.left="0",this.ui.liveMenu.style.right="auto",this.ui.liveMenu.innerHTML='\n                    <div class="jellyjump-menu-item active" data-value="live">Live (Low Latency)</div>\n                    <div class="jellyjump-menu-item" data-value="buffer">30s Buffer (Stable)</div>\n                ',this.ui.liveControl.appendChild(this.ui.liveBadge),this.ui.liveControl.appendChild(this.ui.liveMenu),this.ui.liveBadge.addEventListener("click",t=>{t.stopPropagation(),this.ui.liveMenu.classList.toggle("visible")}),document.addEventListener("click",t=>{this.ui.liveControl.contains(t.target)||this.ui.liveMenu.classList.remove("visible")}),this.ui.liveMenu.addEventListener("click",t=>{const e=t.target.closest(".jellyjump-menu-item");if(!e)return;const i=e.dataset.value;this.liveMode=i,this.ui.liveMenu.querySelectorAll(".jellyjump-menu-item").forEach(t=>t.classList.remove("active")),e.classList.add("active"),this.ui.liveBadge.textContent="live"===i?"LIVE":"BUFFER",this._seekToLive(),this.ui.liveMenu.classList.remove("visible")});const t=this.ui.timeDisplay?.parentNode;t&&t.insertBefore(this.ui.liveControl,this.ui.timeDisplay)}this.ui.liveControl.style.display="inline-flex",this.ui.progressContainer&&this.ui.progressContainer.classList.add("live-mode-hidden"),this.ui.timeDisplay&&this.ui.timeDisplay.classList.add("live-mode-hidden")}else this.ui.liveControl&&(this.ui.liveControl.style.display="none"),this.ui.progressContainer&&this.ui.progressContainer.classList.remove("live-mode-hidden"),this.ui.timeDisplay&&this.ui.timeDisplay.classList.remove("live-mode-hidden");this._setStreamModeControls(!0),this._createQualitySelector()}_setStreamModeControls(t){const e=[this.ui.ccBtn,this.ui.speedBtn,this.ui.filtersBtn,this.ui.audioSettingsBtn,this.ui.loopBtn],i=this.container.querySelector("#mb-screenshot-btn");i&&e.push(i),e.forEach(e=>{e&&e.classList.toggle("stream-mode-hidden",t)})}_createQualitySelector(){if(!this.hlsPlayer||this.ui.qualityBtn)return;if(this.hlsPlayer.getLevels().length<=1)return;this.ui.qualityBtn=document.createElement("button"),this.ui.qualityBtn.className="jellyjump-control-btn jellyjump-quality-btn",this.ui.qualityBtn.setAttribute("aria-label","Quality"),this.ui.qualityBtn.innerHTML='\n            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">\n                <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-8 12H9.5v-2h-2v2H6V9h1.5v2.5h2V9H11v6zm2-6h4c.55 0 1 .45 1 1v4c0 .55-.45 1-1 1h-4V9zm1.5 4.5h2v-3h-2v3z"/>\n            </svg>\n        ',this.ui.qualityMenu=document.createElement("div"),this.ui.qualityMenu.className="jellyjump-dropdown jellyjump-quality-menu";const t=this.container.querySelector(".jellyjump-controls-right");t&&(t.insertBefore(this.ui.qualityMenu,t.firstChild),t.insertBefore(this.ui.qualityBtn,t.firstChild)),this.ui.qualityBtn.addEventListener("click",()=>{this.ui.qualityMenu.classList.toggle("visible")}),this.ui.qualityMenu.addEventListener("click",t=>{const e=t.target.closest(".jellyjump-menu-item");if(e){const t=parseInt(e.dataset.value);this.hlsPlayer.setLevel(t),this.ui.qualityMenu.classList.remove("visible"),this._updateQualityMenu()}}),this._updateQualityMenu()}_updateQualityMenu(){if(!this.ui.qualityMenu||!this.hlsPlayer)return;const t=this.hlsPlayer.getLevels(),e=this.hlsPlayer.getCurrentLevel(),i=this.hlsPlayer.isAutoLevel();let s=`\n            <div class="jellyjump-menu-item ${i?"active":""}" data-value="-1">\n                Auto\n            </div>\n        `;if(t.forEach(t=>{s+=`\n                <div class="jellyjump-menu-item ${i||e!==t.index?"":"active"}" \n                     data-value="${t.index}">\n                    ${t.label}\n                </div>\n            `}),this.ui.qualityMenu.innerHTML=s,this.ui.qualityBtn){const s=i?"Auto":t[e]?.label||"Auto";this.ui.qualityBtn.title=`Quality: ${s}`}}_cleanupMediaBunny(){if(this.videoFrameIterator&&(this.videoFrameIterator.return().catch(()=>{}),this.videoFrameIterator=null),this.audioBufferIterator&&(this.audioBufferIterator.return().catch(()=>{}),this.audioBufferIterator=null),this.videoSink&&"function"==typeof this.videoSink.dispose)try{this.videoSink.dispose()}catch(t){}if(this.audioSink&&"function"==typeof this.audioSink.dispose)try{this.audioSink.dispose()}catch(t){}if(this.input&&"function"==typeof this.input.dispose)try{this.input.dispose()}catch(t){}this.videoSink=null,this.audioSink=null,this.input=null,this.videoTrack=null,this.audioTrack=null,this.nextFrame=null}_seekToLive(){this.isStreamMode&&this.isLive&&this.hlsPlayer&&(this.ui.loader.classList.add("visible"),"buffer"===this.liveMode?(this.hlsPlayer.seekToLatency(30),console.log("[Stream] Seeked to 30s buffer")):(this.hlsPlayer.seekToLive(),console.log("[Stream] Seeked to live edge")),this.ui.liveBadge&&this.ui.liveBadge.classList.remove("not-live"),this.isPlaying||this.play())}_cleanupHLS(){this.hlsPlayer&&(this.hlsPlayer.destroy(),this.hlsPlayer=null),this.isStreamMode=!1,this.isLive=!1,this.ui.liveControl&&(this.ui.liveControl.remove(),this.ui.liveControl=null,this.ui.liveBadge=null,this.ui.liveMenu=null),this.ui.qualityBtn&&(this.ui.qualityBtn.remove(),this.ui.qualityBtn=null),this.ui.qualityMenu&&(this.ui.qualityMenu.remove(),this.ui.qualityMenu=null),this.ui.progressContainer&&this.ui.progressContainer.classList.remove("live-mode-hidden"),this.ui.timeDisplay&&this.ui.timeDisplay.classList.remove("live-mode-hidden"),this._hideStreamError()}_createErrorOverlay(){const t=document.createElement("div");t.className="jellyjump-error-overlay",t.style.display="none",t.innerHTML='\n            <div class="jellyjump-error-content">\n                <span class="jellyjump-error-icon">⚠️</span>\n                <h3 class="jellyjump-error-title">Stream Error</h3>\n                <p class="jellyjump-error-message">Failed to load stream.</p>\n                <p class="jellyjump-error-suggestion"></p>\n                <div class="jellyjump-error-actions">\n                    <button class="jellyjump-btn-secondary jellyjump-error-retry">Retry</button>\n                    <button class="jellyjump-btn-secondary jellyjump-error-dismiss">Dismiss</button>\n                </div>\n            </div>\n        ';(this.container.querySelector(".jellyjump-video-wrapper")||this.container).appendChild(t),this.ui.errorOverlay=t,t.querySelector(".jellyjump-error-retry").addEventListener("click",()=>{this._hideStreamError(),this._lastStreamUrl&&this._loadHLSStream(this._lastStreamUrl,!1,this.currentVideoId)}),t.querySelector(".jellyjump-error-dismiss").addEventListener("click",()=>{this._hideStreamError()})}_showStreamError(t){if(!this.ui.errorOverlay)return;const e=this.ui.errorOverlay;e.querySelector(".jellyjump-error-icon").textContent=t.icon||"⚠️",e.querySelector(".jellyjump-error-title").textContent=t.title||"Stream Error",e.querySelector(".jellyjump-error-message").textContent=t.message||"Failed to load stream.",e.querySelector(".jellyjump-error-suggestion").textContent=t.suggestion||"";e.querySelector(".jellyjump-error-retry").style.display=t.recoverable?"inline-block":"none",this.ui.loader.classList.remove("visible"),e.style.display="flex"}_hideStreamError(){this.ui.errorOverlay&&(this.ui.errorOverlay.style.display="none")}async loadSubtitle(t){if(this.subtitleManager)try{console.log(`Loading subtitles: ${t}`);const e=await fetch(t),i=await e.text();let s=i;if(i.trim().startsWith("{")||i.trim().startsWith("["))try{const{parseTranscriptJSON:t,jsonToVTT:e}=await import("./SubtitleConverter.js");s=e(t(i)),console.log("Converted JSON transcript to VTT format")}catch(t){console.warn("Failed to parse as JSON transcript, treating as VTT:",t)}this.subtitleManager.parse(s),this.subtitleTrackCounter++;const a=`custom-${this.subtitleTrackCounter}`,o=`Custom ${this.subtitleTrackCounter}`;this.subtitleTracks.push({id:a,name:o,cues:[...this.subtitleManager.cues]}),this.activeSubtitleTrackId=a,this.isSubtitlesEnabled=!0,this._updateSubtitleMenu(),console.log(`Subtitles loaded successfully as "${o}"`),this.onSubtitleChange&&this.onSubtitleChange(this.subtitleTracks)}catch(t){console.error("Error loading subtitles:",t)}else console.warn("Subtitle manager not initialized (captions disabled)")}async _updateNextFrame(){const t=this.asyncId;for(;this.videoFrameIterator;){const e=(await this.videoFrameIterator.next()).value??null;if(!e)break;if(t!==this.asyncId)break;const i=this._getPlaybackTime();if(!(e.timestamp<=i)){this.nextFrame=e;break}this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.drawImage(e.canvas,0,0,this.canvas.width,this.canvas.height),this.afterFrameRenderCallbacks.length>0&&this.afterFrameRenderCallbacks.forEach(t=>t(this.ctx,this.canvas.width,this.canvas.height))}}_renderSubtitles(t){if(!this.subtitleManager)return;const e=this.subtitleManager.getActiveCues(t);if(0===e.length)return;const i=Math.max(22,.055*this.canvas.height),s=1.35*i,a=.08*this.canvas.height,o=this.canvas.width/2,n=[];if(e.forEach(t=>{t.text.split("\n").forEach(t=>{t.trim()&&n.push(t.trim())})}),0===n.length)return;let l=this.canvas.height-a;this.ctx.font=`bold ${i}px "Segoe UI", Roboto, Arial, sans-serif`,this.ctx.textAlign="center",this.ctx.textBaseline="bottom",this.ctx.lineJoin="round",this.ctx.miterLimit=2;for(let t=n.length-1;t>=0;t--){const e=n[t];this.ctx.strokeStyle="#000000",this.ctx.lineWidth=.15*i,this.ctx.strokeText(e,o,l),this.ctx.fillStyle="#ffffff",this.ctx.fillText(e,o,l),l-=s}}_getPlaybackTime(){if(this.isPlaying&&this.audioContext){return(this.audioContext.currentTime-this.audioContextStartTime)*this.playbackRate+this.playbackTimeAtStart}return this.playbackTimeAtStart}togglePlay(){this.videoTrack||this.audioTrack||this.isStreamMode||this.currentVideoId?this.isPlaying?this.pause():this.play():this.onPlayRequest&&this.onPlayRequest()}async play(){if(this.isStreamMode&&this.streamVideo)try{await this.streamVideo.play(),this.isPlaying=!0,this._updatePlayPauseUI(),this.ui.playOverlay&&(this.ui.playOverlay.style.display="none"),"overlay"===this.controlBarMode&&setTimeout(()=>{this.isPlaying&&"overlay"===this.controlBarMode&&this._startAutoHideTimer()},500)}catch(t){console.warn("[Stream] Play failed:",t.message)}else(this.videoTrack||this.audioTrack)&&(this._initAudio(),this.audioContext&&"suspended"===this.audioContext.state&&await this.audioContext.resume(),this._getPlaybackTime()>=this.duration?(this.playbackTimeAtStart=0,await this._startVideoIterator()):this.videoFrameIterator||await this._startVideoIterator(),this.audioContextStartTime=this.audioContext.currentTime,this.isPlaying=!0,this._updatePlayPauseUI(),this.audioSink&&(this.audioBufferIterator&&await this.audioBufferIterator.return(),this.audioBufferIterator=this.audioSink.samples(this._getPlaybackTime()),this._runAudioIterator()),this._startRenderLoop(),"overlay"===this.controlBarMode&&setTimeout(()=>{this.isPlaying&&"overlay"===this.controlBarMode&&this._startAutoHideTimer()},500),this.ui.playOverlay&&(this.ui.playOverlay.style.display="none"))}pause(t=!0){if(console.log("Player.pause() called"),this.isStreamMode&&this.streamVideo)return this.streamVideo.pause(),this.isPlaying=!1,this._clearAutoHideTimer(),this._updatePlayPauseUI(),void(this.ui.playOverlay&&(this.ui.playOverlay.style.display=t?"flex":"none"));if(this.playbackTimeAtStart=this._getPlaybackTime(),this.isPlaying=!1,this._clearAutoHideTimer(),this._updatePlayPauseUI(),this.audioBufferIterator){const t=this.audioBufferIterator;this.audioBufferIterator=null,this.audioIteratorCleanupPromise=t.return().catch(t=>{console.debug("Error closing audio iterator:",t)}).finally(()=>{this.audioIteratorCleanupPromise=null})}this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.audioContext&&"running"===this.audioContext.state&&this.audioContext.suspend();for(const t of this.queuedAudioNodes)try{t.stop()}catch(t){}this.queuedAudioNodes.clear(),this._savePlaybackState(),this.ui.playOverlay&&(this.ui.playOverlay.style.display=t?"flex":"none")}async _startVideoIterator(){if(!this.videoSink)return;this.asyncId++;const t=this.asyncId;this.videoFrameIterator&&await this.videoFrameIterator.return(),this.videoFrameIterator=this.videoSink.canvases(this._getPlaybackTime());const e=(await this.videoFrameIterator.next()).value??null,i=(await this.videoFrameIterator.next()).value??null;t===this.asyncId&&(this.nextFrame=i,e&&(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.drawImage(e.canvas,0,0,this.canvas.width,this.canvas.height),this.afterFrameRenderCallbacks.length>0&&this.afterFrameRenderCallbacks.forEach(t=>t(this.ctx,this.canvas.width,this.canvas.height))))}_startRenderLoop(){if(this.animationFrameId)return;const t=()=>{if(this.isPlaying){const t=this._getPlaybackTime();if(this.currentTime=t,t>=this.duration){if("one"===this.loopMode)return void this._seekTo(0);this.pause(),this.playbackTimeAtStart=this.duration,this.onEnded&&this.onEnded()}if("ab"===this.loopMode&&null!==this.loopStart&&null!==this.loopEnd&&t>=this.loopEnd)return void this._seekTo(this.loopStart);this.nextFrame&&this.nextFrame.timestamp<=t&&(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.drawImage(this.nextFrame.canvas,0,0,this.canvas.width,this.canvas.height),this.afterFrameRenderCallbacks.length>0&&this.afterFrameRenderCallbacks.forEach(t=>t(this.ctx,this.canvas.width,this.canvas.height)),this.nextFrame=null,this._updateNextFrame()),this._updateProgress(),this.isSubtitlesEnabled&&this._renderSubtitles(t)}this.animationFrameId=requestAnimationFrame(t)};this.animationFrameId=requestAnimationFrame(t)}async _runAudioIterator(){if(this.audioSink)try{for await(const t of this.audioBufferIterator){if(!this.isPlaying){t.close();break}const e=t.toAudioBuffer(),i=t.timestamp;t.close();const s=this.audioContext.createBufferSource();s.buffer=e,s.playbackRate.value=this.playbackRate,this.audioEqualizer&&this.audioEqualizer.isInitialized?s.connect(this.audioEqualizer.getInputNode()):s.connect(this.gainNode);const a=this.audioContext.currentTime,o=(i-this._getPlaybackTime())/this.playbackRate,n=a+Math.max(0,o);if(o>=0)s.start(n);else{const t=-o;t<e.duration/this.playbackRate&&s.start(a,t*this.playbackRate)}this.queuedAudioNodes.add(s),s.onended=()=>this.queuedAudioNodes.delete(s),i-this._getPlaybackTime()>=1&&await new Promise(t=>{const e=setInterval(()=>{(!this.isPlaying||i-this._getPlaybackTime()<1)&&(clearInterval(e),t())},100)})}}catch(t){"InputDisposedError"===t.name||t.message.includes("Input has been disposed")||console.error("Error in audio iterator:",t)}finally{if(this.audioBufferIterator)try{await this.audioBufferIterator.return()}catch(t){}}}async _seekTo(t){console.log(`_seekTo called with time: ${t}`),this.ui.loader.classList.add("visible");const e=this.isPlaying;e&&this.pause(!1),this.playbackTimeAtStart=Math.max(0,Math.min(this.duration,t)),this.currentTime=this.playbackTimeAtStart,this._updateProgress();try{await this._startVideoIterator()}finally{this.ui.loader.classList.remove("visible")}e&&this.playbackTimeAtStart<this.duration&&await this.play()}_seek(t){const e=this.ui.progressContainer.getBoundingClientRect(),i=(t.clientX-e.left)/e.width;this._seekTo(i*this.duration)}seek(t){this._seekTo(t)}toggleFullscreen(){document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement?(document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen(),this.container.classList.remove("fullscreen-fallback"),document.body.classList.remove("fullscreen-active")):this.container.requestFullscreen?this.container.requestFullscreen().catch(t=>{console.error(`Error attempting to enable fullscreen: ${t.message}`)}):this.container.webkitRequestFullscreen?this.container.webkitRequestFullscreen():this.container.mozRequestFullScreen?this.container.mozRequestFullScreen():this.container.msRequestFullscreen?this.container.msRequestFullscreen():(this.container.classList.toggle("fullscreen-fallback"),document.body.classList.toggle("fullscreen-active")),this._updateFullscreenUI()}_updatePlayPauseUI(){const t=this.ui.playBtn.querySelector("use");this.isPlaying?(this.ui.playBtn.setAttribute("aria-label","Pause"),this.ui.playBtn.setAttribute("aria-pressed","true"),t.setAttribute("href","assets/icons/sprite.svg#icon-pause")):(this.ui.playBtn.setAttribute("aria-label","Play"),this.ui.playBtn.setAttribute("aria-pressed","false"),t.setAttribute("href","assets/icons/sprite.svg#icon-play"))}_updateProgress(){const t=this.currentTime/this.duration*100;this.ui.progressBar.style.width=`${t}%`,this.ui.progressContainer.setAttribute("aria-valuenow",Math.round(t)),this._updateTimeDisplay()}_updateTimeDisplay(){const t=this._formatTime(this.currentTime),e=this._formatTime(this.duration);this.ui.timeDisplay.textContent=`${t} / ${e}`}_formatTime(t){const e=Math.floor(t/60),i=Math.floor(t%60);return`${e}:${i<10?"0":""}${i}`}_updateFullscreenUI(){const t=this.ui.fullscreenBtn.querySelector("use");document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement||this.container.classList.contains("fullscreen-fallback")?(this.ui.fullscreenBtn.setAttribute("aria-label","Exit Fullscreen"),t.setAttribute("href","assets/icons/sprite.svg#icon-fullscreen-exit")):(this.ui.fullscreenBtn.setAttribute("aria-label","Fullscreen"),t.setAttribute("href","assets/icons/sprite.svg#icon-fullscreen"))}setVolume(t){this.config.volume=Math.max(0,Math.min(1,t)),this.config.volume>0&&(this.config.muted=!1),this.isStreamMode&&this.streamVideo&&(this.streamVideo.volume=this.config.volume,this.streamVideo.muted=this.config.muted),this.gainNode&&(this.gainNode.gain.value=this.config.muted?0:this.config.volume),this._updateVolumeUI()}toggleMute(){this.config.muted=!this.config.muted,this.isStreamMode&&this.streamVideo&&(this.streamVideo.muted=this.config.muted),this.gainNode&&(this.gainNode.gain.value=this.config.muted?0:this.config.volume),this._updateVolumeUI()}get volume(){return this.config.volume}get isMuted(){return this.config.muted}_updateVolumeUI(){if(this.ui.panelVolumeSlider&&(this.ui.panelVolumeSlider.value=this.volume),this.ui.panelVolumeValue&&(this.ui.panelVolumeValue.textContent=`${Math.round(100*this.volume)}%`),this.ui.panelMuteBtn){const t=this.ui.panelMuteBtn.querySelector("use");this.isMuted||0===this.volume?(t.setAttribute("href","assets/icons/sprite.svg#icon-volume-mute"),this.ui.panelMuteBtn.setAttribute("aria-label","Unmute")):(t.setAttribute("href","assets/icons/sprite.svg#icon-volume-high"),this.ui.panelMuteBtn.setAttribute("aria-label","Mute"))}this._updateAudioButtonState()}setPlayCallback(t){this.onPlayRequest=t}setNavigationCallbacks(t,e){this.onPrevious=t,this.onNext=e}updateNavigationButtons(t,e){this.ui.prevBtn&&(this.ui.prevBtn.disabled=!t,this.ui.prevBtn.style.opacity=t?"1":"0.4",this.ui.prevBtn.style.cursor=t?"pointer":"not-allowed"),this.ui.nextBtn&&(this.ui.nextBtn.disabled=!e,this.ui.nextBtn.style.opacity=e?"1":"0.4",this.ui.nextBtn.style.cursor=e?"pointer":"not-allowed")}destroy(){this.pause(),this.audioContext&&(this.audioContext.close(),this.audioContext=null),this.videoSink&&(this.videoSink=null),this.audioSink&&(this.audioSink=null),this.input&&(this.input=null),this.canvas&&(this.canvas.remove(),this.canvas=null),this.ui.controls&&this.ui.controls.remove(),this.ui.helpOverlay&&this.ui.helpOverlay.remove(),this.ui.loader&&this.ui.loader.remove(),this.container.classList.remove("jellyjump-container"),this.container=null,this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null)}_loadControlBarMode(){try{const t=localStorage.getItem("controlBarMode");"fixed"!==t&&"overlay"!==t||(this.controlBarMode=t)}catch(t){console.warn("Failed to load control bar mode:",t)}this._applyControlBarMode()}_saveControlBarMode(){try{localStorage.setItem("controlBarMode",this.controlBarMode)}catch(t){console.warn("Failed to save control bar mode:",t)}}toggleControlBarMode(){this.controlBarMode="overlay"===this.controlBarMode?"fixed":"overlay",this._applyControlBarMode(),this._saveControlBarMode()}_applyControlBarMode(){if(this.container.classList.remove("mode-overlay","mode-fixed"),this.container.classList.add(`mode-${this.controlBarMode}`),this.ui.modeToggleBtn){const t="fixed"===this.controlBarMode;this.ui.modeToggleBtn.setAttribute("aria-label",t?"Unpin controls":"Pin controls"),this.ui.modeToggleBtn.setAttribute("aria-pressed",t.toString()),this.ui.modeToggleBtn.setAttribute("title",t?"Unpin controls":"Pin controls")}"overlay"===this.controlBarMode?(this.ui.controls.classList.add("visible"),this._startAutoHideTimer()):(this._clearAutoHideTimer(),this.ui.controls.classList.add("visible"))}_handleMouseMove(t){if("overlay"!==this.controlBarMode)return;if(this.ui.controls.classList.add("visible"),this._clearAutoHideTimer(),!this.isPlaying)return;const e=this.ui.controls.getBoundingClientRect();t.clientY>=e.top&&t.clientY<=e.bottom&&t.clientX>=e.left&&t.clientX<=e.right||this._startAutoHideTimer()}_startAutoHideTimer(){"overlay"===this.controlBarMode&&this.isPlaying&&(this._clearAutoHideTimer(),this.autoHideTimer=setTimeout(()=>{this.ui.controls.classList.remove("visible"),this.container.classList.add("hide-cursor")},3e3))}_clearAutoHideTimer(){this.autoHideTimer&&(clearTimeout(this.autoHideTimer),this.autoHideTimer=null),this.container.classList.remove("hide-cursor")}setControlsConfig(t){this.config.controls={...this.config.controls,...t},this._applyControlVisibility()}toggleControl(t,e){this.config.controls.hasOwnProperty(t)?(this.config.controls[t]=e,this._applyControlVisibility()):console.warn(`Control '${t}' not found in configuration.`)}getControlsConfig(){return{...this.config.controls}}setControlsPreset(t){this.PRESETS[t]?this.setControlsConfig(this.PRESETS[t]):console.warn(`Preset '${t}' not found.`)}_initResizeObserver(){this.ui.controls&&(this.resizeObserver=new ResizeObserver(t=>{for(const e of t)this._handleResize(e)}),this.resizeObserver.observe(this.ui.controls))}_handleResize(t){const e=t.contentRect.width;this.ui.controls.classList.remove("size-compact","size-minimal"),e<400?this.ui.controls.classList.add("size-minimal"):e<600&&this.ui.controls.classList.add("size-compact")}async _handleInitialFrame(t=!1){if(!this.videoTrack)return;const e=this._loadPlaybackState();let i=0;if(e&&e.videoIdentifier===this.currentVideoId)console.log("Restoring playback state:",e),i=e.timestamp;else if(console.log("No saved state, using default frame"),!t){const t=.5*this.duration;return void await this._extractAndDrawFrame(t)}if(this.playbackTimeAtStart=i,this.currentTime=i,this._updateProgress(),t)try{const t=this.play(),e=new Promise((t,e)=>setTimeout(()=>e(new Error("Autoplay timeout")),1e3));await Promise.race([t,e])}catch(t){console.warn("Autoplay failed or timed out, falling back to paused state:",t),this.isPlaying=!1,this._updatePlayPauseUI(),await this._startVideoIterator(),this.ui.playOverlay&&(this.ui.playOverlay.style.display="flex")}else await this._startVideoIterator()}async _extractAndDrawFrame(t){if(!this.videoSink)return;const e=this.videoSink.canvases(t),i=(await e.next()).value;i&&(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.drawImage(i.canvas,0,0,this.canvas.width,this.canvas.height),this.afterFrameRenderCallbacks.length>0&&this.afterFrameRenderCallbacks.forEach(t=>t(this.ctx,this.canvas.width,this.canvas.height))),await e.return()}_savePlaybackState(){if(!this.currentVideoId||this.duration<1)return;const t={videoIdentifier:this.currentVideoId,timestamp:this.currentTime,savedAt:(new Date).toISOString()};try{localStorage.setItem(`jellyjump-state-${this.currentVideoId}`,JSON.stringify(t))}catch(t){console.warn("Failed to save playback state:",t)}}_loadPlaybackState(){if(!this.currentVideoId)return null;try{const t=localStorage.getItem(`jellyjump-state-${this.currentVideoId}`);return t?JSON.parse(t):null}catch(t){return null}}addRenderCallback(t){"function"==typeof t&&this.afterFrameRenderCallbacks.push(t)}removeRenderCallback(t){const e=this.afterFrameRenderCallbacks.indexOf(t);-1!==e&&this.afterFrameRenderCallbacks.splice(e,1)}}