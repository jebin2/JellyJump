import Hls from"../lib/hls.js";export class HLSPlayer{constructor(e){this.video=e,this.hls=null,this.isLive=!1,this.currentUrl=null,this.currentLevel=-1,this.onError=null,this.onLevelLoaded=null,this.onManifestParsed=null,this.onQualityChange=null}static isSupported(){return Hls.isSupported()}async load(e){if(this.destroy(),this.currentUrl=e,this.video.canPlayType("application/vnd.apple.mpegurl"))return console.log("[HLS] Using native HLS support"),this.video.src=e,this._waitForMetadata();if(!Hls.isSupported())throw new Error("HLS is not supported in this browser");return console.log("[HLS] Using hls.js"),this.hls=new Hls({enableWorker:!0,lowLatencyMode:!0,backBufferLength:90,maxBufferLength:30,maxMaxBufferLength:60,startLevel:-1}),new Promise((t,s)=>{this.hls.on(Hls.Events.MANIFEST_PARSED,(e,s)=>{console.log("[HLS] Manifest parsed:",s.levels.length,"quality levels"),this.isLive=!s.levels[0]?.details?.endSN,this.onManifestParsed?.(s),t()}),this.hls.on(Hls.Events.LEVEL_LOADED,(e,t)=>{this.isLive=t.details.live,this.onLevelLoaded?.(t)}),this.hls.on(Hls.Events.LEVEL_SWITCHED,(e,t)=>{this.currentLevel=t.level,this.onQualityChange?.(t.level)}),this.hls.on(Hls.Events.ERROR,(e,t)=>{console.warn("[HLS] Error:",t.type,t.details),t.fatal&&(this._handleFatalError(t),s(new Error(t.details))),this.onError?.(t)}),this.hls.loadSource(e),this.hls.attachMedia(this.video)})}_handleFatalError(e){switch(e.type){case Hls.ErrorTypes.NETWORK_ERROR:console.warn("[HLS] Network error, attempting recovery..."),this.hls.startLoad();break;case Hls.ErrorTypes.MEDIA_ERROR:console.warn("[HLS] Media error, attempting recovery..."),this.hls.recoverMediaError();break;default:console.error("[HLS] Unrecoverable error:",e),this.destroy()}}_waitForMetadata(){return new Promise((e,t)=>{const s=()=>{this.video.removeEventListener("loadedmetadata",s),this.video.removeEventListener("error",r),this.isLive=!isFinite(this.video.duration),e()},r=e=>{this.video.removeEventListener("loadedmetadata",s),this.video.removeEventListener("error",r),t(new Error("Failed to load stream: "+(e.target?.error?.message||"Unknown error")))};this.video.addEventListener("loadedmetadata",s),this.video.addEventListener("error",r)})}getLevels(){return this.hls?this.hls.levels.map((e,t)=>({index:t,height:e.height,width:e.width,bitrate:e.bitrate,label:e.height?`${e.height}p`:`${Math.round(e.bitrate/1e3)}kbps`})):[]}getCurrentLevel(){return this.hls?this.hls.currentLevel:-1}setLevel(e){this.hls&&(this.hls.currentLevel=e,console.log("[HLS] Quality level set to:",-1===e?"Auto":this.getLevels()[e]?.label))}isAutoLevel(){return!this.hls||this.hls.autoLevelEnabled}async play(){try{await this.video.play()}catch(e){throw console.warn("[HLS] Play failed:",e.message),e}}pause(){this.video.pause()}get currentTime(){return this.video.currentTime}set currentTime(e){this.video.currentTime=e}get duration(){return this.video.duration}get volume(){return this.video.volume}set volume(e){this.video.volume=e}get muted(){return this.video.muted}set muted(e){this.video.muted=e}get paused(){return this.video.paused}seekToLive(){if(this.hls&&this.isLive){const e=this.hls.liveSyncPosition;e&&(this.video.currentTime=e)}}getLiveLatency(){return this.hls&&this.isLive&&this.hls.latency||0}destroy(){this.hls&&(this.hls.destroy(),this.hls=null),this.video.src="",this.video.load(),this.currentUrl=null,this.isLive=!1,this.currentLevel=-1}}