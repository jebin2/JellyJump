import Hls from"../lib/hls.js";export class HLSPlayer{constructor(e){this.video=e,this.hls=null,this.isLive=!1,this.currentUrl=null,this.currentLevel=-1,this.onError=null,this.onLevelLoaded=null,this.onManifestParsed=null,this.onQualityChange=null}static isSupported(){return Hls.isSupported()}async load(e,t={}){if(this.destroy(),this.currentUrl=e,this.streamBuffer=t.streamBuffer||null,this.video.canPlayType("application/vnd.apple.mpegurl"))return console.log("[HLS] Using native HLS support"),this.video.src=e,this._waitForMetadata();if(!Hls.isSupported())throw new Error("HLS is not supported in this browser");console.log("[HLS] Using hls.js");const r=this.streamBuffer?this.streamBuffer.getHLSConfig():{enableWorker:!0,lowLatencyMode:!0,backBufferLength:90,maxBufferLength:30,maxMaxBufferLength:60,startLevel:-1};return this.hls=new Hls(r),new Promise((t,r)=>{this.hls.on(Hls.Events.MANIFEST_PARSED,(e,r)=>{console.log("[HLS] Manifest parsed:",r.levels.length,"quality levels"),this.isLive=!r.levels[0]?.details?.endSN,this.onManifestParsed?.(r),this.streamBuffer&&(this.streamBuffer.startCapture(),console.log("[HLS] StreamBuffer capture started")),t()}),this.hls.on(Hls.Events.LEVEL_LOADED,(e,t)=>{this.isLive=t.details.live,this.onLevelLoaded?.(t)}),this.hls.on(Hls.Events.LEVEL_SWITCHED,(e,t)=>{this.currentLevel=t.level,this.onQualityChange?.(t.level)}),this.hls.on(Hls.Events.ERROR,(e,t)=>{console.warn("[HLS] Error:",t.type,t.details),t.fatal&&(this._handleFatalError(t),r(new Error(t.details))),this.onError?.(t)}),this.hls.loadSource(e),this.hls.attachMedia(this.video)})}_handleFatalError(e){switch(e.type){case Hls.ErrorTypes.NETWORK_ERROR:console.warn("[HLS] Network error, attempting recovery..."),this.hls.startLoad();break;case Hls.ErrorTypes.MEDIA_ERROR:console.warn("[HLS] Media error, attempting recovery..."),this.hls.recoverMediaError();break;default:console.error("[HLS] Unrecoverable error:",e),this.destroy()}}static getErrorDetails(e){e.url;const t=e.details||"",r="manifestLoadError"===t&&0===e.response?.code||e.error?.message?.includes("CORS")||"TypeError"===e.error?.name,s=t.includes("manifestLoadError")&&(e.error?.message?.includes("ERR_NAME_NOT_RESOLVED")||e.error?.message?.includes("getaddrinfo")),i=t.includes("timeout")||e.error?.message?.includes("timeout"),o="mediaError"===e.type;return r?{type:"cors",title:"Access Blocked",message:"This stream is blocked by the server's security policy (CORS).",suggestion:"The stream server doesn't allow playback from this site. Try a different stream.",recoverable:!1,icon:"ðŸš«"}:s?{type:"dns",title:"Server Not Found",message:"Could not connect to the stream server.",suggestion:"Check your internet connection or the stream URL may be invalid.",recoverable:!0,icon:"ðŸŒ"}:i?{type:"timeout",title:"Connection Timeout",message:"The stream server took too long to respond.",suggestion:"Try again or check your internet connection.",recoverable:!0,icon:"â±ï¸"}:o?{type:"media",title:"Playback Error",message:"Unable to play this stream format.",suggestion:"The stream format may not be supported by your browser.",recoverable:!1,icon:"ðŸŽ¬"}:"networkError"===e.type?{type:"network",title:"Network Error",message:"Failed to load the stream.",suggestion:"Check your internet connection and try again.",recoverable:!0,icon:"ðŸ“¡"}:{type:"unknown",title:"Stream Error",message:`Failed to load stream: ${t||"Unknown error"}`,suggestion:"Try a different stream or refresh the page.",recoverable:!0,icon:"âš ï¸"}}_waitForMetadata(){return new Promise((e,t)=>{const r=()=>{this.video.removeEventListener("loadedmetadata",r),this.video.removeEventListener("error",s),this.isLive=!isFinite(this.video.duration),e()},s=e=>{this.video.removeEventListener("loadedmetadata",r),this.video.removeEventListener("error",s),t(new Error("Failed to load stream: "+(e.target?.error?.message||"Unknown error")))};this.video.addEventListener("loadedmetadata",r),this.video.addEventListener("error",s)})}getLevels(){return this.hls?this.hls.levels.map((e,t)=>({index:t,height:e.height,width:e.width,bitrate:e.bitrate,label:e.height?`${e.height}p`:`${Math.round(e.bitrate/1e3)}kbps`})):[]}getCurrentLevel(){return this.hls?this.hls.currentLevel:-1}setLevel(e){this.hls&&(this.hls.currentLevel=e,console.log("[HLS] Quality level set to:",-1===e?"Auto":this.getLevels()[e]?.label))}isAutoLevel(){return!this.hls||this.hls.autoLevelEnabled}async play(){try{await this.video.play()}catch(e){throw console.warn("[HLS] Play failed:",e.message),e}}pause(){this.video.pause()}get currentTime(){return this.video.currentTime}set currentTime(e){this.video.currentTime=e}get duration(){return this.video.duration}get volume(){return this.video.volume}set volume(e){this.video.volume=e}get muted(){return this.video.muted}set muted(e){this.video.muted=e}get paused(){return this.video.paused}seekToLive(){if(!this.isLive)return;const e=this.video.seekable;if(e.length>0){const t=e.end(e.length-1);this.video.currentTime=t,console.log("[HLS] Seeked to live edge:",t)}else this.hls?.liveSyncPosition&&(this.video.currentTime=this.hls.liveSyncPosition,console.log("[HLS] Seeked to live sync position:",this.hls.liveSyncPosition))}seekToLatency(e){if(!this.isLive)return;const t=this.video.seekable;if(t.length>0){let r=t.end(t.length-1)-e;const s=t.start(0);r=Math.max(s,r),this.video.currentTime=r,console.log(`[HLS] Seeked to latency ${e}s (time: ${r})`)}}getLiveLatency(){if(!this.isLive)return 0;if(this.hls&&this.hls.latency)return this.hls.latency;const e=this.video.seekable;if(e.length>0){const t=e.end(e.length-1)-this.video.currentTime;return Math.max(0,t)}return 0}destroy(){this.streamBuffer&&(this.streamBuffer.stopCapture(),this.streamBuffer=null),this.hls&&(this.hls.destroy(),this.hls=null),this.video.src="",this.video.load(),this.currentUrl=null,this.isLive=!1,this.currentLevel=-1}getStreamBuffer(){return this.streamBuffer}}